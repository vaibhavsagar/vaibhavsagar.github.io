<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Refactoring Haskell: A Case Study - Vaibhav Sagar</title>
        <link href="data:," rel="icon">
        <link rel="stylesheet" type="text/css" href="../../../../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../../../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../../../../">Vaibhav Sagar</a>
            </div>
            <div id="navigation">
                <a href="../../../../../about/">About</a>
                <a href="../../../../../talks/">Talks</a>
                <a href="../../../../../archive/">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Refactoring Haskell: A Case Study</h1>

            <div class="info">
    Posted on 12 February 2019
    
</div>
<div class="info">
    
        Tags: <a title="All pages tagged 'programming'." href="../../../../../blog/tags/programming/" rel="tag">programming</a>, <a title="All pages tagged 'haskell'." href="../../../../../blog/tags/haskell/" rel="tag">haskell</a>
    
</div>

<p>Many people claim that <a href="https://twitter.com/search?q=haskell%20refactoring">refactoring Haskell is a
joy</a>. I’ve certainly found
this to be the case, but what does that mean in practice? I thought it might be
useful to demonstrate by refactoring some of my own code.</p>
<p>The code we’re looking at today is an implementation of <a href="https://en.wikipedia.org/wiki/Tarjan%27s_strongly_connected_components_algorithm">Tarjan’s Strongly
Connected Components
algorithm</a>
used to determine whether a given <a href="https://en.wikipedia.org/wiki/2-satisfiability">2-SAT
problem</a> is satisfiable or not,
and was written to complete <a href="https://online.stanford.edu/course/algorithms-design-and-analysis-part-1">an online
course</a>
that is now offered in a different form. I’ve <a href="../../../../../blog/2017/06/10/dag-toolkit/">written about Tarjan’s algorithm
previously</a> and it can be
used to determine the satisfiability of a 2-SAT problem by checking if any SCC
contains both a variable and its negation. If it does, we have a contradiction
and the problem is unsatisfiable, otherwise the problem is satisfiable.</p>
<p>This code isn’t particularly elegant or easy to follow, and it’s lousy with
mutable state. Despite these drawbacks, it is still relatively straightforward
to refactor.</p>
<p>If you’d like to follow along, I have the code (and some test data) available
<a href="https://gist.github.com/vaibhavsagar/2418c9dd79da431065ad0d80e690b12f">at this
gist</a>
with each revision representing a refactoring step.</p>
<p>The initial version of the code is as follows:</p>
<details>
<summary style="cursor: pointer">
Initial 2SAT.hs
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="pp">{-# LANGUAGE LambdaCase #-}</span><span>

</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Graph</span><span>      </span><span class="kw">as</span><span> </span><span class="dt">G</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Map.Strict</span><span> </span><span class="kw">as</span><span> </span><span class="dt">M</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Set</span><span>        </span><span class="kw">as</span><span> </span><span class="dt">S</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Array</span><span>      </span><span class="kw">as</span><span> </span><span class="dt">A</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Prelude</span><span>         </span><span class="kw">as</span><span> </span><span class="dt">P</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Prelude</span><span> </span><span class="kw">hiding</span><span> </span><span class="ot">(</span><span class="va">lookup</span><span class="ot">)</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.ST</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.STRef</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad</span><span> </span><span class="ot">(</span><span class="va">forM_</span><span class="ot">,</span><span> </span><span class="va">when</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Maybe</span><span> </span><span class="ot">(</span><span class="va">isJust</span><span class="ot">,</span><span> </span><span class="va">isNothing</span><span class="ot">,</span><span> </span><span class="va">fromJust</span><span class="ot">)</span><span>

</span><span class="va">tarjan</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="dt">S.Set</span><span> </span><span class="dt">Int</span><span class="ot">]</span><span>
</span><span class="va">tarjan</span><span> </span><span class="va">n</span><span> </span><span class="va">graph</span><span> </span><span class="ot">=</span><span> </span><span class="va">runST</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">index</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="dv">0</span><span>
    </span><span class="va">stack</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
    </span><span class="va">stackSet</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="va">S.empty</span><span>
    </span><span class="va">indices</span><span>  </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="va">M.empty</span><span>
    </span><span class="va">lowlinks</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="va">M.empty</span><span>
    </span><span class="va">output</span><span>   </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">[</span><span class="ot">]</span><span class="ot">)</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">G.vertices</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">vIndex</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">M.lookup</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">indices</span><span>
        </span><span class="va">when</span><span> </span><span class="ot">(</span><span class="va">isNothing</span><span> </span><span class="va">vIndex</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>

    </span><span class="va">readSTRef</span><span> </span><span class="va">output</span><span>

</span><span class="va">strongConnect</span><span>
    </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">S.Set</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">M.Map</span><span> </span><span class="dt">Int</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">M.Map</span><span> </span><span class="dt">Int</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="dt">S.Set</span><span> </span><span class="dt">Int</span><span class="ot">]</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span>    </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">index</span><span>
    </span><span class="va">insert</span><span> </span><span class="va">v</span><span> </span><span class="va">i</span><span> </span><span class="va">indices</span><span>
    </span><span class="va">insert</span><span> </span><span class="va">v</span><span> </span><span class="va">i</span><span> </span><span class="va">lowlinks</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">index</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span>
    </span><span class="va">push</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">v</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">graph</span><span> </span><span class="op">A.!</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">w</span><span> </span><span class="va">indices</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="ot">case</span><span>
        </span><span class="dt">Nothing</span><span>     </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>
            </span><span class="va">vLowLink</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">v</span><span> </span><span class="va">lowlinks</span><span>
            </span><span class="va">wLowLink</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">w</span><span> </span><span class="va">lowlinks</span><span>
            </span><span class="va">insert</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="va">vLowLink</span><span> </span><span class="va">wLowLink</span><span class="ot">)</span><span> </span><span class="va">lowlinks</span><span>
        </span><span class="dt">Just</span><span> </span><span class="va">wIndex</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">wOnStack</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">S.member</span><span> </span><span class="va">w</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">stackSet</span><span>
            </span><span class="va">when</span><span> </span><span class="va">wOnStack</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
                </span><span class="va">vLowLink</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">v</span><span> </span><span class="va">lowlinks</span><span>
                </span><span class="va">insert</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="va">vLowLink</span><span> </span><span class="va">wIndex</span><span class="ot">)</span><span> </span><span class="va">lowlinks</span><span>

    </span><span class="va">vLowLink</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">v</span><span> </span><span class="va">lowlinks</span><span>
    </span><span class="va">vIndex</span><span>   </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">v</span><span> </span><span class="va">indices</span><span>
    </span><span class="va">when</span><span> </span><span class="ot">(</span><span class="va">vLowLink</span><span> </span><span class="op">==</span><span> </span><span class="va">vIndex</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">scc</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">S.empty</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span>
        </span><span class="va">modifySTRef'</span><span> </span><span class="va">output</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">sccs</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">:</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">scc</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">sccs</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">lookup</span><span> </span><span class="va">value</span><span> </span><span class="va">hashMap</span><span>     </span><span class="ot">=</span><span> </span><span class="va">M.lookup</span><span> </span><span class="va">value</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">hashMap</span><span>
        </span><span class="va">insert</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="va">hashMap</span><span> </span><span class="ot">=</span><span> </span><span class="va">modifySTRef'</span><span> </span><span class="va">hashMap</span><span> </span><span class="ot">(</span><span class="va">M.insert</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span class="ot">)</span><span>

</span><span class="va">addSCC</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">S.Set</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">S.Set</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">(</span><span class="dt">S.Set</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span class="ot">)</span><span>
</span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">=</span><span> </span><span class="va">pop</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="ot">`</span><span class="va">S.member</span><span class="ot">`</span><span> </span><span class="va">scc</span><span class="ot">)</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="dt">Nothing</span><span> </span><span class="kw">else</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">scc'</span><span> </span><span class="ot">=</span><span> </span><span class="va">S.insert</span><span> </span><span class="va">w</span><span> </span><span class="va">scc</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">w</span><span> </span><span class="op">==</span><span> </span><span class="va">v</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">scc'</span><span class="ot">)</span><span> </span><span class="kw">else</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc'</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span>

</span><span class="va">push</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">S.Set</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">push</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span>    </span><span class="ot">(</span><span class="va">e</span><span class="ot">:</span><span class="ot">)</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">(</span><span class="va">S.insert</span><span> </span><span class="va">e</span><span class="ot">)</span><span>

</span><span class="va">pop</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">S.Set</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">pop</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">e</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">head</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">stack</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="va">tail</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">(</span><span class="va">S.delete</span><span> </span><span class="va">e</span><span class="ot">)</span><span>
    </span><span class="va">return</span><span> </span><span class="va">e</span><span>

</span><span class="va">denormalise</span><span>     </span><span class="ot">=</span><span> </span><span class="va">subtract</span><span>
</span><span class="va">normalise</span><span>       </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="ot">)</span><span>
</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span>       </span><span class="ot">=</span><span> </span><span class="dv">2</span><span class="ot">*</span><span class="va">n</span><span> </span><span class="op">-</span><span> </span><span class="va">v</span><span>
</span><span class="va">clauses</span><span> </span><span class="va">n</span><span> </span><span class="ot">[</span><span class="va">u</span><span class="ot">,</span><span class="va">v</span><span class="ot">]</span><span> </span><span class="ot">=</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">u</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span class="ot">,</span><span> </span><span class="va">u</span><span class="ot">)</span><span class="ot">]</span><span>

</span><span class="va">checkSat</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">IO</span><span> </span><span class="dt">Bool</span><span>
</span><span class="va">checkSat</span><span> </span><span class="va">name</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">p</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="va">P.read</span><span> </span><span class="op">.</span><span> </span><span class="va">words</span><span class="ot">)</span><span> </span><span class="op">.</span><span> </span><span class="va">lines</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readFile</span><span> </span><span class="va">name</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">pNo</span><span>    </span><span class="ot">=</span><span> </span><span class="va">head</span><span> </span><span class="op">$</span><span> </span><span class="va">head</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pn</span><span>     </span><span class="ot">=</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">normalise</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tail</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pGraph</span><span> </span><span class="ot">=</span><span> </span><span class="va">G.buildG</span><span> </span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span><span class="dv">2</span><span class="ot">*</span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">concatMap</span><span> </span><span class="ot">(</span><span class="va">clauses</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="va">pn</span><span>
    </span><span class="va">return</span><span> </span><span class="op">$</span><span> </span><span class="ot">(</span><span class="dt">Nothing</span><span> </span><span class="op">/=</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tarjan</span><span> </span><span class="va">pNo</span><span> </span><span class="va">pGraph</span></code></pre></div>
</details>
<p>I’ve included 2SAT-specific functionality for completeness, but I’ll only be
changing the <code>tarjan</code> function and the functions it depends on
(<code>strongConnect</code>, <code>addSCC</code>, <code>push</code>, and <code>pop</code>).</p>
<p>The first change is using more suitable data structures. Tarjan’s algorithm is
only linear in the size of the graph when operations, such as checking if <code>w</code> is
on the stack and looking up indices, happen in constant time (<span class="math inline">\(O(1)\)</span>). I’m
currently using <code>Data.Map</code> and <code>Data.Set</code> which are both implemented with trees
and are <span class="math inline">\(O(\log{}n)\)</span> in these operations. A better choice would be
<a href="http://hackage.haskell.org/package/vector/docs/Data-Vector-Mutable.html"><code>Data.Vector.Mutable</code></a>
from the <code>vector</code> package, which does have constant-time operations.</p>
<p>This refactoring mostly consists of initialising vectors with a known length
and replacing calls to <code>lookup</code> and <code>insert</code> with calls to <code>read</code> and <code>write</code>.</p>
<details>
<summary style="cursor: pointer">
2SAT.hs using <code>vector</code>
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="pp">{-# LANGUAGE LambdaCase #-}</span><span>

</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Graph</span><span> </span><span class="kw">as</span><span> </span><span class="dt">G</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Array</span><span> </span><span class="kw">as</span><span> </span><span class="dt">A</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Prelude</span><span>    </span><span class="kw">as</span><span> </span><span class="dt">P</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Prelude</span><span> </span><span class="kw">hiding</span><span> </span><span class="ot">(</span><span class="va">lookup</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">)</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.ST</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.STRef</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad</span><span>       </span><span class="ot">(</span><span class="va">forM_</span><span class="ot">,</span><span> </span><span class="va">when</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Maybe</span><span>          </span><span class="ot">(</span><span class="va">isJust</span><span class="ot">,</span><span> </span><span class="va">isNothing</span><span class="ot">,</span><span> </span><span class="va">fromJust</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Vector.Mutable</span><span> </span><span class="ot">(</span><span class="dt">STVector</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">,</span><span> </span><span class="va">write</span><span class="ot">)</span><span>

</span><span class="va">tarjan</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span>
</span><span class="va">tarjan</span><span> </span><span class="va">n</span><span> </span><span class="va">graph</span><span> </span><span class="ot">=</span><span> </span><span class="va">runST</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">index</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="dv">0</span><span>
    </span><span class="va">stack</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
    </span><span class="va">stackSet</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">False</span><span>
    </span><span class="va">indices</span><span>  </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
    </span><span class="va">lowlinks</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
    </span><span class="va">output</span><span>   </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">[</span><span class="ot">]</span><span class="ot">)</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">G.vertices</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">vIndex</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">v</span><span>
        </span><span class="va">when</span><span> </span><span class="ot">(</span><span class="va">isNothing</span><span> </span><span class="va">vIndex</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>

    </span><span class="va">readSTRef</span><span> </span><span class="va">output</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">size</span><span> </span><span class="ot">=</span><span> </span><span class="va">snd</span><span> </span><span class="ot">(</span><span class="va">A.bounds</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>

</span><span class="va">strongConnect</span><span>
    </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span>    </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">index</span><span>
    </span><span class="va">write</span><span> </span><span class="va">indices</span><span>  </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">index</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span>
    </span><span class="va">push</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">v</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">graph</span><span> </span><span class="op">A.!</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">w</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="ot">case</span><span>
        </span><span class="dt">Nothing</span><span>     </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>
            </span><span class="va">vLowLink</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span>
            </span><span class="va">wLowLink</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">w</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="va">vLowLink</span><span> </span><span class="va">wLowLink</span><span class="ot">)</span><span class="ot">)</span><span>
        </span><span class="dt">Just</span><span> </span><span class="va">wIndex</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">wOnStack</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">read</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">w</span><span>
            </span><span class="va">when</span><span> </span><span class="va">wOnStack</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
                </span><span class="va">vLowLink</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span>
                </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="va">vLowLink</span><span> </span><span class="va">wIndex</span><span class="ot">)</span><span class="ot">)</span><span>

    </span><span class="va">vLowLink</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span>
    </span><span class="va">vIndex</span><span>   </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span>  </span><span class="va">v</span><span>
    </span><span class="va">when</span><span> </span><span class="ot">(</span><span class="va">vLowLink</span><span> </span><span class="op">==</span><span> </span><span class="va">vIndex</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">scc</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="ot">[</span><span class="ot">]</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span>
        </span><span class="va">modifySTRef'</span><span> </span><span class="va">output</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">sccs</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">:</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">scc</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">sccs</span><span>

</span><span class="va">addSCC</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">)</span><span>
</span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">=</span><span> </span><span class="va">pop</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="ot">`</span><span class="va">elem</span><span class="ot">`</span><span> </span><span class="va">scc</span><span class="ot">)</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="dt">Nothing</span><span> </span><span class="kw">else</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">scc'</span><span> </span><span class="ot">=</span><span> </span><span class="va">w</span><span class="ot">:</span><span class="va">scc</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">w</span><span> </span><span class="op">==</span><span> </span><span class="va">v</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">scc'</span><span class="ot">)</span><span> </span><span class="kw">else</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc'</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span>

</span><span class="va">push</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">push</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="ot">(</span><span class="va">e</span><span class="ot">:</span><span class="ot">)</span><span>
    </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">True</span><span>

</span><span class="va">pop</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">pop</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">e</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">head</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">stack</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="va">tail</span><span>
    </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">False</span><span>
    </span><span class="va">return</span><span> </span><span class="va">e</span><span>

</span><span class="va">denormalise</span><span>     </span><span class="ot">=</span><span> </span><span class="va">subtract</span><span>
</span><span class="va">normalise</span><span>       </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="ot">)</span><span>
</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span>       </span><span class="ot">=</span><span> </span><span class="dv">2</span><span class="ot">*</span><span class="va">n</span><span> </span><span class="op">-</span><span> </span><span class="va">v</span><span>
</span><span class="va">clauses</span><span> </span><span class="va">n</span><span> </span><span class="ot">[</span><span class="va">u</span><span class="ot">,</span><span class="va">v</span><span class="ot">]</span><span> </span><span class="ot">=</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">u</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span class="ot">,</span><span> </span><span class="va">u</span><span class="ot">)</span><span class="ot">]</span><span>

</span><span class="va">checkSat</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">IO</span><span> </span><span class="dt">Bool</span><span>
</span><span class="va">checkSat</span><span> </span><span class="va">name</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">p</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="va">P.read</span><span> </span><span class="op">.</span><span> </span><span class="va">words</span><span class="ot">)</span><span> </span><span class="op">.</span><span> </span><span class="va">lines</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readFile</span><span> </span><span class="va">name</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">pNo</span><span>    </span><span class="ot">=</span><span> </span><span class="va">head</span><span> </span><span class="op">$</span><span> </span><span class="va">head</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pn</span><span>     </span><span class="ot">=</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">normalise</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tail</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pGraph</span><span> </span><span class="ot">=</span><span> </span><span class="va">G.buildG</span><span> </span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span><span class="dv">2</span><span class="ot">*</span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">concatMap</span><span> </span><span class="ot">(</span><span class="va">clauses</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="va">pn</span><span>
    </span><span class="va">return</span><span> </span><span class="op">$</span><span> </span><span class="ot">(</span><span class="dt">Nothing</span><span> </span><span class="op">/=</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tarjan</span><span> </span><span class="va">pNo</span><span> </span><span class="va">pGraph</span></code></pre></div>
</details>
<p>I didn’t notice a significant difference in speed on my inputs, but it’s good
to know that the algorithm has been implemented with the correct asymptotics
now!</p>
<p><em>Sidenote: A <code>Vector</code> of <code>Bool</code>s can be much more compactly represented as a
sequence of 0s and 1s, which are just machine words. For implementations of
this in Haskell, see the <a href="https://hackage.haskell.org/package/bv">bv</a> or
<a href="https://hackage.haskell.org/package/bv-little">bv-little</a> packages. Using
these could be another possible refactoring.</em></p>
<p>Looking at the code again, I notice some repetition of the form</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">x</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">vectorX</span><span> </span><span class="va">i</span><span>
</span><span class="va">y</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">vectorY</span><span> </span><span class="va">j</span><span>
</span><span class="va">write</span><span> </span><span class="va">vectorZ</span><span> </span><span class="va">k</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">(</span><span class="va">operation</span><span> </span><span class="va">x</span><span> </span><span class="va">y</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p>and with the judicious use of <code>(=&lt;&lt;)</code> and <code>(&lt;*&gt;)</code> this can instead be</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">write</span><span> </span><span class="va">vectorZ</span><span> </span><span class="va">k</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">operation</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">vectorX</span><span> </span><span class="va">i</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">lookup</span><span> </span><span class="va">vectorY</span><span> </span><span class="va">j</span><span class="ot">)</span></code></pre></div>
<p>There are a couple of other places we could use <code>(&lt;*&gt;)</code>:</p>
<details>
<summary style="cursor: pointer">
2SAT.hs using <code>(&lt;*&gt;)</code>
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="pp">{-# LANGUAGE LambdaCase #-}</span><span>

</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Graph</span><span> </span><span class="kw">as</span><span> </span><span class="dt">G</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Array</span><span> </span><span class="kw">as</span><span> </span><span class="dt">A</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Prelude</span><span>    </span><span class="kw">as</span><span> </span><span class="dt">P</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Prelude</span><span> </span><span class="kw">hiding</span><span> </span><span class="ot">(</span><span class="va">lookup</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">)</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.ST</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.STRef</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad</span><span>       </span><span class="ot">(</span><span class="va">forM_</span><span class="ot">,</span><span> </span><span class="va">when</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Maybe</span><span>          </span><span class="ot">(</span><span class="va">isJust</span><span class="ot">,</span><span> </span><span class="va">isNothing</span><span class="ot">,</span><span> </span><span class="va">fromJust</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Vector.Mutable</span><span> </span><span class="ot">(</span><span class="dt">STVector</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">,</span><span> </span><span class="va">write</span><span class="ot">)</span><span>

</span><span class="va">tarjan</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span>
</span><span class="va">tarjan</span><span> </span><span class="va">n</span><span> </span><span class="va">graph</span><span> </span><span class="ot">=</span><span> </span><span class="va">runST</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">index</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="dv">0</span><span>
    </span><span class="va">stack</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
    </span><span class="va">stackSet</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">False</span><span>
    </span><span class="va">indices</span><span>  </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
    </span><span class="va">lowlinks</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
    </span><span class="va">output</span><span>   </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">[</span><span class="ot">]</span><span class="ot">)</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">G.vertices</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">vIndex</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">v</span><span>
        </span><span class="va">when</span><span> </span><span class="ot">(</span><span class="va">isNothing</span><span> </span><span class="va">vIndex</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>

    </span><span class="va">readSTRef</span><span> </span><span class="va">output</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">size</span><span> </span><span class="ot">=</span><span> </span><span class="va">snd</span><span> </span><span class="ot">(</span><span class="va">A.bounds</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>

</span><span class="va">strongConnect</span><span>
    </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span>    </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">index</span><span>
    </span><span class="va">write</span><span> </span><span class="va">indices</span><span>  </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">index</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span>
    </span><span class="va">push</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">v</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">graph</span><span> </span><span class="op">A.!</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">w</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="ot">case</span><span>
        </span><span class="dt">Nothing</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">w</span><span class="ot">)</span><span>
        </span><span class="dt">Just</span><span class="ot">{</span><span class="ot">}</span><span>  </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">wOnStack</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">read</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">w</span><span>
            </span><span class="va">when</span><span> </span><span class="va">wOnStack</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
                </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">w</span><span class="ot">)</span><span>

    </span><span class="va">vLowLink</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span>
    </span><span class="va">vIndex</span><span>   </span><span class="ot">&lt;-</span><span> </span><span class="va">fromJust</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span>  </span><span class="va">v</span><span>
    </span><span class="va">when</span><span> </span><span class="ot">(</span><span class="va">vLowLink</span><span> </span><span class="op">==</span><span> </span><span class="va">vIndex</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">scc</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="ot">[</span><span class="ot">]</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span>
        </span><span class="va">modifySTRef'</span><span> </span><span class="va">output</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">sccs</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">:</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">scc</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">sccs</span><span>

</span><span class="va">addSCC</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">)</span><span>
</span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">=</span><span> </span><span class="va">pop</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="ot">`</span><span class="va">elem</span><span class="ot">`</span><span> </span><span class="va">scc</span><span class="ot">)</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="dt">Nothing</span><span> </span><span class="kw">else</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">scc'</span><span> </span><span class="ot">=</span><span> </span><span class="va">w</span><span class="ot">:</span><span class="va">scc</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">w</span><span> </span><span class="op">==</span><span> </span><span class="va">v</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">scc'</span><span class="ot">)</span><span> </span><span class="kw">else</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc'</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span>

</span><span class="va">push</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">push</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="ot">(</span><span class="va">e</span><span class="ot">:</span><span class="ot">)</span><span>
    </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">True</span><span>

</span><span class="va">pop</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">pop</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">e</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">head</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">stack</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="va">tail</span><span>
    </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">False</span><span>
    </span><span class="va">return</span><span> </span><span class="va">e</span><span>

</span><span class="va">denormalise</span><span>     </span><span class="ot">=</span><span> </span><span class="va">subtract</span><span>
</span><span class="va">normalise</span><span>       </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="ot">)</span><span>
</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span>       </span><span class="ot">=</span><span> </span><span class="dv">2</span><span class="ot">*</span><span class="va">n</span><span> </span><span class="op">-</span><span> </span><span class="va">v</span><span>
</span><span class="va">clauses</span><span> </span><span class="va">n</span><span> </span><span class="ot">[</span><span class="va">u</span><span class="ot">,</span><span class="va">v</span><span class="ot">]</span><span> </span><span class="ot">=</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">u</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span class="ot">,</span><span> </span><span class="va">u</span><span class="ot">)</span><span class="ot">]</span><span>

</span><span class="va">checkSat</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">IO</span><span> </span><span class="dt">Bool</span><span>
</span><span class="va">checkSat</span><span> </span><span class="va">name</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">p</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="va">P.read</span><span> </span><span class="op">.</span><span> </span><span class="va">words</span><span class="ot">)</span><span> </span><span class="op">.</span><span> </span><span class="va">lines</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readFile</span><span> </span><span class="va">name</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">pNo</span><span>    </span><span class="ot">=</span><span> </span><span class="va">head</span><span> </span><span class="op">$</span><span> </span><span class="va">head</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pn</span><span>     </span><span class="ot">=</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">normalise</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tail</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pGraph</span><span> </span><span class="ot">=</span><span> </span><span class="va">G.buildG</span><span> </span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span><span class="dv">2</span><span class="ot">*</span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">concatMap</span><span> </span><span class="ot">(</span><span class="va">clauses</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="va">pn</span><span>
    </span><span class="va">return</span><span> </span><span class="op">$</span><span> </span><span class="ot">(</span><span class="dt">Nothing</span><span> </span><span class="op">/=</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tarjan</span><span> </span><span class="va">pNo</span><span> </span><span class="va">pGraph</span></code></pre></div>
</details>
<p>This is much nicer with the applicative combinators.</p>
<p>I would like to clean up that <code>when</code> as well, and for that I’d need a function
like</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">whenM</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Monad</span><span> </span><span class="va">m</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">m</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span></code></pre></div>
<p>which is <a href="hackage.haskell.org/package/extra/docs/Control-Monad-Extra.html#v:whenM">available in Neil Mitchell’s <code>extra</code>
package</a>.</p>
<p>I don’t think it’s worth pulling in that dependency though, so I’ll just copy
that definition:</p>
<details>
<summary style="cursor: pointer">
2SAT.hs using <code>whenM</code>
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="pp">{-# LANGUAGE LambdaCase #-}</span><span>

</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Graph</span><span> </span><span class="kw">as</span><span> </span><span class="dt">G</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Array</span><span> </span><span class="kw">as</span><span> </span><span class="dt">A</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Prelude</span><span>    </span><span class="kw">as</span><span> </span><span class="dt">P</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Prelude</span><span> </span><span class="kw">hiding</span><span> </span><span class="ot">(</span><span class="va">lookup</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">)</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.ST</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.STRef</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad</span><span>       </span><span class="ot">(</span><span class="va">forM_</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Vector.Mutable</span><span> </span><span class="ot">(</span><span class="dt">STVector</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">,</span><span> </span><span class="va">write</span><span class="ot">)</span><span>

</span><span class="va">whenM</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Monad</span><span> </span><span class="va">m</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">m</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">whenM</span><span> </span><span class="va">condM</span><span> </span><span class="va">block</span><span> </span><span class="ot">=</span><span> </span><span class="va">condM</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">cond</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="va">cond</span><span> </span><span class="kw">then</span><span> </span><span class="va">block</span><span> </span><span class="kw">else</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>

</span><span class="va">tarjan</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span>
</span><span class="va">tarjan</span><span> </span><span class="va">n</span><span> </span><span class="va">graph</span><span> </span><span class="ot">=</span><span> </span><span class="va">runST</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">index</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="dv">0</span><span>
    </span><span class="va">stack</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
    </span><span class="va">stackSet</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">False</span><span>
    </span><span class="va">indices</span><span>  </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
    </span><span class="va">lowlinks</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
    </span><span class="va">output</span><span>   </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">[</span><span class="ot">]</span><span class="ot">)</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">G.vertices</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span>
        </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="op">==</span><span class="ot">)</span><span> </span><span class="dt">Nothing</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>

    </span><span class="va">readSTRef</span><span> </span><span class="va">output</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">size</span><span> </span><span class="ot">=</span><span> </span><span class="va">snd</span><span> </span><span class="ot">(</span><span class="va">A.bounds</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>

</span><span class="va">strongConnect</span><span>
    </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span>    </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">index</span><span>
    </span><span class="va">write</span><span> </span><span class="va">indices</span><span>  </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">index</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span>
    </span><span class="va">push</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">v</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">graph</span><span> </span><span class="op">A.!</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">w</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="ot">case</span><span>
        </span><span class="dt">Nothing</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">w</span><span class="ot">)</span><span>
        </span><span class="dt">Just</span><span class="ot">{</span><span class="ot">}</span><span>  </span><span class="ot">-&gt;</span><span> </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="va">read</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span>  </span><span class="va">w</span><span class="ot">)</span><span>

    </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="op">==</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">scc</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="ot">[</span><span class="ot">]</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span>
        </span><span class="va">modifySTRef'</span><span> </span><span class="va">output</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">sccs</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">:</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">scc</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">sccs</span><span>

</span><span class="va">addSCC</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">)</span><span>
</span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">=</span><span> </span><span class="va">pop</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="ot">`</span><span class="va">elem</span><span class="ot">`</span><span> </span><span class="va">scc</span><span class="ot">)</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="dt">Nothing</span><span> </span><span class="kw">else</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">scc'</span><span> </span><span class="ot">=</span><span> </span><span class="va">w</span><span class="ot">:</span><span class="va">scc</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">w</span><span> </span><span class="op">==</span><span> </span><span class="va">v</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">scc'</span><span class="ot">)</span><span> </span><span class="kw">else</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc'</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span>

</span><span class="va">push</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">push</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="ot">(</span><span class="va">e</span><span class="ot">:</span><span class="ot">)</span><span>
    </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">True</span><span>

</span><span class="va">pop</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">pop</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">e</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">head</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">stack</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="va">tail</span><span>
    </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">False</span><span>
    </span><span class="va">return</span><span> </span><span class="va">e</span><span>

</span><span class="va">denormalise</span><span>     </span><span class="ot">=</span><span> </span><span class="va">subtract</span><span>
</span><span class="va">normalise</span><span>       </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="ot">)</span><span>
</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span>       </span><span class="ot">=</span><span> </span><span class="dv">2</span><span class="ot">*</span><span class="va">n</span><span> </span><span class="op">-</span><span> </span><span class="va">v</span><span>
</span><span class="va">clauses</span><span> </span><span class="va">n</span><span> </span><span class="ot">[</span><span class="va">u</span><span class="ot">,</span><span class="va">v</span><span class="ot">]</span><span> </span><span class="ot">=</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">u</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span class="ot">,</span><span> </span><span class="va">u</span><span class="ot">)</span><span class="ot">]</span><span>

</span><span class="va">checkSat</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">IO</span><span> </span><span class="dt">Bool</span><span>
</span><span class="va">checkSat</span><span> </span><span class="va">name</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">p</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="va">P.read</span><span> </span><span class="op">.</span><span> </span><span class="va">words</span><span class="ot">)</span><span> </span><span class="op">.</span><span> </span><span class="va">lines</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readFile</span><span> </span><span class="va">name</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">pNo</span><span>    </span><span class="ot">=</span><span> </span><span class="va">head</span><span> </span><span class="op">$</span><span> </span><span class="va">head</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pn</span><span>     </span><span class="ot">=</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">normalise</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tail</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pGraph</span><span> </span><span class="ot">=</span><span> </span><span class="va">G.buildG</span><span> </span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span><span class="dv">2</span><span class="ot">*</span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">concatMap</span><span> </span><span class="ot">(</span><span class="va">clauses</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="va">pn</span><span>
    </span><span class="va">return</span><span> </span><span class="op">$</span><span> </span><span class="ot">(</span><span class="dt">Nothing</span><span> </span><span class="op">/=</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tarjan</span><span> </span><span class="va">pNo</span><span> </span><span class="va">pGraph</span></code></pre></div>
</details>
<p>Now I don’t actually even need <code>when</code> anymore!</p>
<p>Since most of the auxiliary functions aren’t used outside <code>strongConnect</code>, it
might make sense to put them under a <code>where</code> clause. This would also make the
parameters passed to <code>strongConnect</code> available to these functions. This is one
place that the <code>ScopedTypeVariables</code> language extension is necessary, otherwise
GHC can’t tell that the <code>s</code> in the type signature of <code>strongConnect</code> is the
same <code>s</code> as the one in each type signature under the <code>where</code> clause.</p>
<details>
<summary style="cursor: pointer">
2SAT.hs using <code>where</code>
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="pp">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span class="pp">{-# LANGUAGE ScopedTypeVariables #-}</span><span>

</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Graph</span><span> </span><span class="kw">as</span><span> </span><span class="dt">G</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Array</span><span> </span><span class="kw">as</span><span> </span><span class="dt">A</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Prelude</span><span>    </span><span class="kw">as</span><span> </span><span class="dt">P</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Prelude</span><span> </span><span class="kw">hiding</span><span> </span><span class="ot">(</span><span class="va">lookup</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">)</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.ST</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.STRef</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad</span><span>       </span><span class="ot">(</span><span class="va">forM_</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Vector.Mutable</span><span> </span><span class="ot">(</span><span class="dt">STVector</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">,</span><span> </span><span class="va">write</span><span class="ot">)</span><span>

</span><span class="va">whenM</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Monad</span><span> </span><span class="va">m</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">m</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">whenM</span><span> </span><span class="va">condM</span><span> </span><span class="va">block</span><span> </span><span class="ot">=</span><span> </span><span class="va">condM</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">cond</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="va">cond</span><span> </span><span class="kw">then</span><span> </span><span class="va">block</span><span> </span><span class="kw">else</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>

</span><span class="va">tarjan</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span>
</span><span class="va">tarjan</span><span> </span><span class="va">n</span><span> </span><span class="va">graph</span><span> </span><span class="ot">=</span><span> </span><span class="va">runST</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">index</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="dv">0</span><span>
    </span><span class="va">stack</span><span>    </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
    </span><span class="va">stackSet</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">False</span><span>
    </span><span class="va">indices</span><span>  </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
    </span><span class="va">lowlinks</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
    </span><span class="va">output</span><span>   </span><span class="ot">&lt;-</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">[</span><span class="ot">]</span><span class="ot">)</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">G.vertices</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span>
        </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="op">==</span><span class="ot">)</span><span> </span><span class="dt">Nothing</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>

    </span><span class="va">readSTRef</span><span> </span><span class="va">output</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">size</span><span> </span><span class="ot">=</span><span> </span><span class="va">snd</span><span> </span><span class="ot">(</span><span class="va">A.bounds</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>

</span><span class="va">strongConnect</span><span>
    </span><span class="ot">::</span><span> </span><span class="kw">forall</span><span> </span><span class="va">s</span><span>
    </span><span class="op">.</span><span>  </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span class="ot">)</span><span>
    </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span>    </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">index</span><span>
    </span><span class="va">write</span><span> </span><span class="va">indices</span><span>  </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">index</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span>
    </span><span class="va">push</span><span> </span><span class="va">v</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">graph</span><span> </span><span class="op">A.!</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">w</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="ot">case</span><span>
        </span><span class="dt">Nothing</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span> </span><span class="va">graph</span><span> </span><span class="va">index</span><span> </span><span class="va">stack</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">indices</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">output</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">w</span><span class="ot">)</span><span>
        </span><span class="dt">Just</span><span class="ot">{</span><span class="ot">}</span><span>  </span><span class="ot">-&gt;</span><span> </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="va">read</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span>  </span><span class="va">w</span><span class="ot">)</span><span>

    </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="op">==</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">scc</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
        </span><span class="va">modifySTRef'</span><span> </span><span class="va">output</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">sccs</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">:</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">scc</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">sccs</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">addSCC</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">)</span><span>
        </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc</span><span> </span><span class="ot">=</span><span> </span><span class="va">pop</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="ot">`</span><span class="va">elem</span><span class="ot">`</span><span> </span><span class="va">scc</span><span class="ot">)</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="dt">Nothing</span><span> </span><span class="kw">else</span><span>
            </span><span class="kw">let</span><span> </span><span class="va">scc'</span><span> </span><span class="ot">=</span><span> </span><span class="va">w</span><span class="ot">:</span><span class="va">scc</span><span>
            </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">w</span><span> </span><span class="op">==</span><span> </span><span class="va">v</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">scc'</span><span class="ot">)</span><span> </span><span class="kw">else</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc'</span><span>
        </span><span class="va">push</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
        </span><span class="va">push</span><span> </span><span class="va">e</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="ot">(</span><span class="va">e</span><span class="ot">:</span><span class="ot">)</span><span>
            </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">True</span><span>
        </span><span class="va">pop</span><span> </span><span class="ot">::</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
        </span><span class="va">pop</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">e</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">head</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">stack</span><span>
            </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="va">tail</span><span>
            </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">False</span><span>
            </span><span class="va">return</span><span> </span><span class="va">e</span><span>

</span><span class="va">denormalise</span><span>     </span><span class="ot">=</span><span> </span><span class="va">subtract</span><span>
</span><span class="va">normalise</span><span>       </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="ot">)</span><span>
</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span>       </span><span class="ot">=</span><span> </span><span class="dv">2</span><span class="ot">*</span><span class="va">n</span><span> </span><span class="op">-</span><span> </span><span class="va">v</span><span>
</span><span class="va">clauses</span><span> </span><span class="va">n</span><span> </span><span class="ot">[</span><span class="va">u</span><span class="ot">,</span><span class="va">v</span><span class="ot">]</span><span> </span><span class="ot">=</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">u</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span class="ot">,</span><span> </span><span class="va">u</span><span class="ot">)</span><span class="ot">]</span><span>

</span><span class="va">checkSat</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">IO</span><span> </span><span class="dt">Bool</span><span>
</span><span class="va">checkSat</span><span> </span><span class="va">name</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">p</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="va">P.read</span><span> </span><span class="op">.</span><span> </span><span class="va">words</span><span class="ot">)</span><span> </span><span class="op">.</span><span> </span><span class="va">lines</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readFile</span><span> </span><span class="va">name</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">pNo</span><span>    </span><span class="ot">=</span><span> </span><span class="va">head</span><span> </span><span class="op">$</span><span> </span><span class="va">head</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pn</span><span>     </span><span class="ot">=</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">normalise</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tail</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pGraph</span><span> </span><span class="ot">=</span><span> </span><span class="va">G.buildG</span><span> </span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span><span class="dv">2</span><span class="ot">*</span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">concatMap</span><span> </span><span class="ot">(</span><span class="va">clauses</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="va">pn</span><span>
    </span><span class="va">return</span><span> </span><span class="op">$</span><span> </span><span class="ot">(</span><span class="dt">Nothing</span><span> </span><span class="op">/=</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tarjan</span><span> </span><span class="va">pNo</span><span> </span><span class="va">pGraph</span></code></pre></div>
</details>
<p>I think the logic is clearer now that the auxiliary functions take fewer
arguments.</p>
<p>Instead of a large number of implictly related variables, it might be nice to
define a single product type containing our entire environment and pass just
one value around. With <code>NamedFieldPuns</code> only minimal code changes are required:</p>
<details>
<summary style="cursor: pointer">
2SAT.hs using <code>NamedFieldPuns</code>
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="pp">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span class="pp">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span class="pp">{-# LANGUAGE ScopedTypeVariables #-}</span><span>

</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Graph</span><span> </span><span class="kw">as</span><span> </span><span class="dt">G</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Array</span><span> </span><span class="kw">as</span><span> </span><span class="dt">A</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Prelude</span><span>    </span><span class="kw">as</span><span> </span><span class="dt">P</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Prelude</span><span> </span><span class="kw">hiding</span><span> </span><span class="ot">(</span><span class="va">lookup</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">)</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.ST</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.STRef</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad</span><span>       </span><span class="ot">(</span><span class="va">forM_</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Vector.Mutable</span><span> </span><span class="ot">(</span><span class="dt">STVector</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">,</span><span> </span><span class="va">write</span><span class="ot">)</span><span>

</span><span class="kw">data</span><span> </span><span class="dt">TarjanEnv</span><span> </span><span class="va">s</span><span> </span><span class="ot">=</span><span> </span><span class="dt">TarjanEnv</span><span>
    </span><span class="ot">{</span><span> </span><span class="va">index</span><span>    </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">stack</span><span>    </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">indices</span><span>  </span><span class="ot">::</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">lowlinks</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">output</span><span>   </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span class="ot">)</span><span>
    </span><span class="ot">}</span><span>

</span><span class="va">whenM</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Monad</span><span> </span><span class="va">m</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">m</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">whenM</span><span> </span><span class="va">condM</span><span> </span><span class="va">block</span><span> </span><span class="ot">=</span><span> </span><span class="va">condM</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">cond</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="va">cond</span><span> </span><span class="kw">then</span><span> </span><span class="va">block</span><span> </span><span class="kw">else</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>

</span><span class="va">tarjan</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span>
</span><span class="va">tarjan</span><span> </span><span class="va">n</span><span> </span><span class="va">graph</span><span> </span><span class="ot">=</span><span> </span><span class="va">runST</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">tarjanEnv</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="dt">TarjanEnv</span><span>
        </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">newSTRef</span><span> </span><span class="dv">0</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">False</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">[</span><span class="ot">]</span><span class="ot">)</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">G.vertices</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span>
        </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="op">==</span><span class="ot">)</span><span> </span><span class="dt">Nothing</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="ot">(</span><span class="va">indices</span><span> </span><span class="va">tarjanEnv</span><span class="ot">)</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">tarjanEnv</span><span>

    </span><span class="va">readSTRef</span><span> </span><span class="ot">(</span><span class="va">output</span><span> </span><span class="va">tarjanEnv</span><span class="ot">)</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">size</span><span> </span><span class="ot">=</span><span> </span><span class="va">snd</span><span> </span><span class="ot">(</span><span class="va">A.bounds</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>

</span><span class="va">strongConnect</span><span> </span><span class="ot">::</span><span> </span><span class="kw">forall</span><span> </span><span class="va">s</span><span class="op">.</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">TarjanEnv</span><span> </span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">tarjanEnv</span><span class="ot">@</span><span class="dt">TarjanEnv</span><span class="ot">{</span><span> </span><span class="va">index</span><span class="ot">,</span><span> </span><span class="va">stack</span><span class="ot">,</span><span> </span><span class="va">stackSet</span><span class="ot">,</span><span> </span><span class="va">indices</span><span class="ot">,</span><span> </span><span class="va">lowlinks</span><span class="ot">,</span><span> </span><span class="va">output</span><span> </span><span class="ot">}</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">index</span><span>
    </span><span class="va">write</span><span> </span><span class="va">indices</span><span>  </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">index</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span>
    </span><span class="va">push</span><span> </span><span class="va">v</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">graph</span><span> </span><span class="op">A.!</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">w</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="ot">case</span><span>
        </span><span class="dt">Nothing</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span> </span><span class="va">graph</span><span> </span><span class="va">tarjanEnv</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">w</span><span class="ot">)</span><span>
        </span><span class="dt">Just</span><span class="ot">{</span><span class="ot">}</span><span>  </span><span class="ot">-&gt;</span><span> </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="va">read</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span>  </span><span class="va">w</span><span class="ot">)</span><span>

    </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="op">==</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">scc</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
        </span><span class="va">modifySTRef'</span><span> </span><span class="va">output</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">sccs</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">:</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">scc</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">sccs</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">addSCC</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">)</span><span>
        </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc</span><span> </span><span class="ot">=</span><span> </span><span class="va">pop</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="ot">`</span><span class="va">elem</span><span class="ot">`</span><span> </span><span class="va">scc</span><span class="ot">)</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="dt">Nothing</span><span> </span><span class="kw">else</span><span>
            </span><span class="kw">let</span><span> </span><span class="va">scc'</span><span> </span><span class="ot">=</span><span> </span><span class="va">w</span><span class="ot">:</span><span class="va">scc</span><span>
            </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">w</span><span> </span><span class="op">==</span><span> </span><span class="va">v</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">scc'</span><span class="ot">)</span><span> </span><span class="kw">else</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc'</span><span>
        </span><span class="va">push</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
        </span><span class="va">push</span><span> </span><span class="va">e</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="ot">(</span><span class="va">e</span><span class="ot">:</span><span class="ot">)</span><span>
            </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">True</span><span>
        </span><span class="va">pop</span><span> </span><span class="ot">::</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
        </span><span class="va">pop</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">e</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">head</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">stack</span><span>
            </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="va">tail</span><span>
            </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">False</span><span>
            </span><span class="va">return</span><span> </span><span class="va">e</span><span>

</span><span class="va">denormalise</span><span>     </span><span class="ot">=</span><span> </span><span class="va">subtract</span><span>
</span><span class="va">normalise</span><span>       </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="ot">)</span><span>
</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span>       </span><span class="ot">=</span><span> </span><span class="dv">2</span><span class="ot">*</span><span class="va">n</span><span> </span><span class="op">-</span><span> </span><span class="va">v</span><span>
</span><span class="va">clauses</span><span> </span><span class="va">n</span><span> </span><span class="ot">[</span><span class="va">u</span><span class="ot">,</span><span class="va">v</span><span class="ot">]</span><span> </span><span class="ot">=</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">u</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span class="ot">,</span><span> </span><span class="va">u</span><span class="ot">)</span><span class="ot">]</span><span>

</span><span class="va">checkSat</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">IO</span><span> </span><span class="dt">Bool</span><span>
</span><span class="va">checkSat</span><span> </span><span class="va">name</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">p</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="va">P.read</span><span> </span><span class="op">.</span><span> </span><span class="va">words</span><span class="ot">)</span><span> </span><span class="op">.</span><span> </span><span class="va">lines</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readFile</span><span> </span><span class="va">name</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">pNo</span><span>    </span><span class="ot">=</span><span> </span><span class="va">head</span><span> </span><span class="op">$</span><span> </span><span class="va">head</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pn</span><span>     </span><span class="ot">=</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">normalise</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tail</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pGraph</span><span> </span><span class="ot">=</span><span> </span><span class="va">G.buildG</span><span> </span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span><span class="dv">2</span><span class="ot">*</span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">concatMap</span><span> </span><span class="ot">(</span><span class="va">clauses</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="va">pn</span><span>
    </span><span class="va">return</span><span> </span><span class="op">$</span><span> </span><span class="ot">(</span><span class="dt">Nothing</span><span> </span><span class="op">/=</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tarjan</span><span> </span><span class="va">pNo</span><span> </span><span class="va">pGraph</span></code></pre></div>
</details>
<p>Let’s pause here. Although more refactoring is certainly possible, my last two
steps did not reduce the line count and may have in fact made the code harder
to understand.</p>
<p>How have we benefited from this refactoring? Aside from the code being shorter
and better structured, it’s now easier to make meaningful improvements. For
example, this implementation is more inefficient than it needs to be, because
it doesn’t short-circuit when it finds that the current problem is
unsatisfiable. Instead it works through the rest of the problem, only to throw
all that work away. A sophisticated solution to this problem might involve the
use of the
<a href="https://hackage.haskell.org/package/transformers/docs/Control-Monad-Trans-Except.html"><code>ExceptT</code></a>
monad transformer to throw an exception and exit early, but there is a simpler
approach: we can store an extra boolean variable denoting whether or not the
current problem is possibly satisfiable, and only continue working if it is.
I’ll call this variable <code>possible</code>, update it in <code>addSCC</code>, and check for it
before each call to <code>strongConnect</code> in <code>tarjan</code>. It takes more effort to
reformat the code than to make this change:</p>
<details>
<summary style="cursor: pointer">
2SAT.hs with short-circuiting
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="pp">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span class="pp">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span class="pp">{-# LANGUAGE ScopedTypeVariables #-}</span><span>

</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Graph</span><span> </span><span class="kw">as</span><span> </span><span class="dt">G</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Array</span><span> </span><span class="kw">as</span><span> </span><span class="dt">A</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Prelude</span><span>    </span><span class="kw">as</span><span> </span><span class="dt">P</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Prelude</span><span> </span><span class="kw">hiding</span><span> </span><span class="ot">(</span><span class="va">lookup</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">)</span><span>

</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.ST</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.STRef</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad</span><span>       </span><span class="ot">(</span><span class="va">forM_</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Vector.Mutable</span><span> </span><span class="ot">(</span><span class="dt">STVector</span><span class="ot">,</span><span> </span><span class="va">read</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">,</span><span> </span><span class="va">write</span><span class="ot">)</span><span>

</span><span class="kw">data</span><span> </span><span class="dt">TarjanEnv</span><span> </span><span class="va">s</span><span> </span><span class="ot">=</span><span> </span><span class="dt">TarjanEnv</span><span>
    </span><span class="ot">{</span><span> </span><span class="va">index</span><span>    </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">stack</span><span>    </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">stackSet</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">indices</span><span>  </span><span class="ot">::</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">lowlinks</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STVector</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">output</span><span>   </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span class="ot">)</span><span>
    </span><span class="ot">,</span><span> </span><span class="va">possible</span><span> </span><span class="ot">::</span><span> </span><span class="dt">STRef</span><span> </span><span class="va">s</span><span> </span><span class="dt">Bool</span><span>
    </span><span class="ot">}</span><span>

</span><span class="va">whenM</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Monad</span><span> </span><span class="va">m</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">m</span><span> </span><span class="dt">Bool</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">m</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">whenM</span><span> </span><span class="va">condM</span><span> </span><span class="va">block</span><span> </span><span class="ot">=</span><span> </span><span class="va">condM</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">cond</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="va">cond</span><span> </span><span class="kw">then</span><span> </span><span class="va">block</span><span> </span><span class="kw">else</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>

</span><span class="va">tarjan</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">]</span><span>
</span><span class="va">tarjan</span><span> </span><span class="va">n</span><span> </span><span class="va">graph</span><span> </span><span class="ot">=</span><span> </span><span class="va">runST</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">tarjanEnv</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="dt">TarjanEnv</span><span>
        </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">newSTRef</span><span> </span><span class="dv">0</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">False</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">replicate</span><span> </span><span class="va">size</span><span> </span><span class="dt">Nothing</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">newSTRef</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="ot">[</span><span class="ot">]</span><span class="ot">)</span><span>
        </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">newSTRef</span><span> </span><span class="dt">True</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">G.vertices</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span>
        </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="op">&amp;&amp;</span><span class="ot">)</span><span>
            </span><span class="op">&lt;$&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="op">==</span><span class="ot">)</span><span> </span><span class="dt">Nothing</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="ot">(</span><span class="va">indices</span><span> </span><span class="va">tarjanEnv</span><span class="ot">)</span><span> </span><span class="va">v</span><span class="ot">)</span><span>
            </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="ot">(</span><span class="va">possible</span><span> </span><span class="va">tarjanEnv</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
                </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">tarjanEnv</span><span>

    </span><span class="va">readSTRef</span><span> </span><span class="ot">(</span><span class="va">output</span><span> </span><span class="va">tarjanEnv</span><span class="ot">)</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">size</span><span> </span><span class="ot">=</span><span> </span><span class="va">snd</span><span> </span><span class="ot">(</span><span class="va">A.bounds</span><span> </span><span class="va">graph</span><span class="ot">)</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>

</span><span class="va">strongConnect</span><span> </span><span class="ot">::</span><span> </span><span class="kw">forall</span><span> </span><span class="va">s</span><span class="op">.</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">G.Graph</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">TarjanEnv</span><span> </span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">graph</span><span> </span><span class="va">tarjanEnv</span><span class="ot">@</span><span class="dt">TarjanEnv</span><span class="ot">{</span><span> </span><span class="va">index</span><span class="ot">,</span><span> </span><span class="va">stack</span><span class="ot">,</span><span> </span><span class="va">stackSet</span><span class="ot">,</span><span> </span><span class="va">indices</span><span class="ot">,</span><span> </span><span class="va">lowlinks</span><span class="ot">,</span><span> </span><span class="va">output</span><span class="ot">,</span><span> </span><span class="va">possible</span><span> </span><span class="ot">}</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">index</span><span>
    </span><span class="va">write</span><span> </span><span class="va">indices</span><span>  </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">i</span><span class="ot">)</span><span>
    </span><span class="va">modifySTRef'</span><span> </span><span class="va">index</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span>
    </span><span class="va">push</span><span> </span><span class="va">v</span><span>

    </span><span class="va">forM_</span><span> </span><span class="ot">(</span><span class="va">graph</span><span> </span><span class="op">A.!</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">w</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="ot">case</span><span>
        </span><span class="dt">Nothing</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">strongConnect</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span> </span><span class="va">graph</span><span> </span><span class="va">tarjanEnv</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">w</span><span class="ot">)</span><span>
        </span><span class="dt">Just</span><span class="ot">{</span><span class="ot">}</span><span>  </span><span class="ot">-&gt;</span><span> </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="va">read</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="op">$</span><span>
            </span><span class="va">write</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">=&lt;&lt;</span><span> </span><span class="ot">(</span><span class="va">min</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span>  </span><span class="va">w</span><span class="ot">)</span><span>

    </span><span class="va">whenM</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="op">==</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">lowlinks</span><span> </span><span class="va">v</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">read</span><span> </span><span class="va">indices</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">scc</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="ot">[</span><span class="ot">]</span><span>
        </span><span class="va">modifySTRef'</span><span> </span><span class="va">output</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">sccs</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">:</span><span class="ot">)</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">scc</span><span> </span><span class="op">&lt;*&gt;</span><span> </span><span class="va">sccs</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">addSCC</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="dt">Maybe</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span class="ot">)</span><span>
        </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc</span><span> </span><span class="ot">=</span><span> </span><span class="va">pop</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">w</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">if</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">w</span><span class="ot">)</span><span> </span><span class="ot">`</span><span class="va">elem</span><span class="ot">`</span><span> </span><span class="va">scc</span><span class="ot">)</span><span>
            </span><span class="kw">then</span><span> </span><span class="va">writeSTRef</span><span> </span><span class="va">possible</span><span> </span><span class="dt">False</span><span> </span><span class="op">&gt;&gt;</span><span> </span><span class="va">return</span><span> </span><span class="dt">Nothing</span><span>
            </span><span class="kw">else</span><span>
                </span><span class="kw">let</span><span> </span><span class="va">scc'</span><span> </span><span class="ot">=</span><span> </span><span class="va">w</span><span class="ot">:</span><span class="va">scc</span><span>
                </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">w</span><span> </span><span class="op">==</span><span> </span><span class="va">v</span><span> </span><span class="kw">then</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="dt">Just</span><span> </span><span class="va">scc'</span><span class="ot">)</span><span> </span><span class="kw">else</span><span> </span><span class="va">addSCC</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span> </span><span class="va">scc'</span><span>
        </span><span class="va">push</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
        </span><span class="va">push</span><span> </span><span class="va">e</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="ot">(</span><span class="va">e</span><span class="ot">:</span><span class="ot">)</span><span>
            </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">True</span><span>
        </span><span class="va">pop</span><span> </span><span class="ot">::</span><span> </span><span class="dt">ST</span><span> </span><span class="va">s</span><span> </span><span class="dt">Int</span><span>
        </span><span class="va">pop</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
            </span><span class="va">e</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">head</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readSTRef</span><span> </span><span class="va">stack</span><span>
            </span><span class="va">modifySTRef'</span><span> </span><span class="va">stack</span><span> </span><span class="va">tail</span><span>
            </span><span class="va">write</span><span> </span><span class="va">stackSet</span><span> </span><span class="va">e</span><span> </span><span class="dt">False</span><span>
            </span><span class="va">return</span><span> </span><span class="va">e</span><span>

</span><span class="va">denormalise</span><span>     </span><span class="ot">=</span><span> </span><span class="va">subtract</span><span>
</span><span class="va">normalise</span><span>       </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="op">+</span><span class="ot">)</span><span>
</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span>       </span><span class="ot">=</span><span> </span><span class="dv">2</span><span class="ot">*</span><span class="va">n</span><span> </span><span class="op">-</span><span> </span><span class="va">v</span><span>
</span><span class="va">clauses</span><span> </span><span class="va">n</span><span> </span><span class="ot">[</span><span class="va">u</span><span class="ot">,</span><span class="va">v</span><span class="ot">]</span><span> </span><span class="ot">=</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">u</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="va">other</span><span> </span><span class="va">n</span><span> </span><span class="va">v</span><span class="ot">,</span><span> </span><span class="va">u</span><span class="ot">)</span><span class="ot">]</span><span>

</span><span class="va">checkSat</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">IO</span><span> </span><span class="dt">Bool</span><span>
</span><span class="va">checkSat</span><span> </span><span class="va">name</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">p</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="va">P.read</span><span> </span><span class="op">.</span><span> </span><span class="va">words</span><span class="ot">)</span><span> </span><span class="op">.</span><span> </span><span class="va">lines</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">readFile</span><span> </span><span class="va">name</span><span>
    </span><span class="kw">let</span><span> </span><span class="va">pNo</span><span>    </span><span class="ot">=</span><span> </span><span class="va">head</span><span> </span><span class="op">$</span><span> </span><span class="va">head</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pn</span><span>     </span><span class="ot">=</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">map</span><span> </span><span class="ot">(</span><span class="va">normalise</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tail</span><span> </span><span class="va">p</span><span>
        </span><span class="va">pGraph</span><span> </span><span class="ot">=</span><span> </span><span class="va">G.buildG</span><span> </span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span><span class="dv">2</span><span class="ot">*</span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">concatMap</span><span> </span><span class="ot">(</span><span class="va">clauses</span><span> </span><span class="va">pNo</span><span class="ot">)</span><span> </span><span class="va">pn</span><span>
    </span><span class="va">return</span><span> </span><span class="op">$</span><span> </span><span class="ot">(</span><span class="dt">Nothing</span><span> </span><span class="op">/=</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">tarjan</span><span> </span><span class="va">pNo</span><span> </span><span class="va">pGraph</span></code></pre></div>
</details>
<p>This change does seem to make a significant difference, and it’s good to know
we’re not doing useless work.</p>
<p>I think this is a good place to stop, and I hope I’ve been able to demonstrate
some of Haskell’s strengths when it comes to refactoring. In my experience,
it’s not usually necessary to deeply understand Haskell code in order to
attempt a refactoring, especially if it’s backed by well-chosen types and a
good test suite. I also find that I’m able to be more daring when writing new
code, because bad up-front design is less costly and even the jankiest working
code can be gently massaged into something presentable.</p>
<p><em>Thanks to
<a href="https://joelburget.com/">Joel Burget</a>, <a href="http://www.matfournier.com/">Mat Fournier</a>, <a href="https://eskimor.gonimo.com/">Robert Klotzner</a>, <a href="https://github.com/L8D">Tenor</a>, <a href="http://www.tomharding.me/">Tom Harding</a>, and <a href="http://www.tylerweir.com/">Tyler Weir</a> for suggestions and
feedback.</em></p>

        </div>
        <div id="footer">
            <div class="rc-webring">
                <a href="https://webring.recurse.com"><img src="https://webring.recurse.com/icon.svg" /> RC Webring</a>
            </div>
            <div class="rc-scout">
                <script async defer src="https://www.recurse-scout.com/loader.js?t=5ac465e5d3396a7e491e42afac4c5c90"></script>
            </div>
        </div>
        <script data-goatcounter="//vaibhavsagar.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
        <script type="text/javascript" id="MathJax-script" async src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
        </script>
        <script>
        window.MathJax = {
            loader: {load: ['[tex]/color', '[tex]/cancel', '[tex]/textmacros']},
            tex: {packages: {'[+]': ['color', 'cancel', 'textmacros']}}
        };
        </script>
    </body>
</html>
