<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Easy IHaskell Docker Images with Nix - Vaibhav Sagar</title>
        <link href="data:," rel="icon">
        <link rel="stylesheet" type="text/css" href="../../../../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../../../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../../../../">Vaibhav Sagar</a>
            </div>
            <div id="navigation">
                <a href="../../../../../about/">About</a>
                <a href="../../../../../talks/">Talks</a>
                <a href="../../../../../archive/">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Easy IHaskell Docker Images with Nix</h1>

            <div class="info">
    Posted on 11 August 2019
    
</div>
<div class="info">
    
        Tags: <a title="All pages tagged 'haskell'." href="../../../../../blog/tags/haskell/">haskell</a>, <a title="All pages tagged 'nix'." href="../../../../../blog/tags/nix/">nix</a>
    
</div>

<p>Today I learned how to turn an IHaskell Nix expression into a Docker image. Here is an example:</p>
<pre class="nix"><code># default.nix
let
  pkgs = {
    ihaskell = builtins.fetchTarball {
      url = &quot;https://github.com/gibiansky/IHaskell/tarball/93bfa3a7a434c1dfe6873c2105c43856c282e183&quot;;
      sha256 = &quot;1cvqqmpvz7s3d7zclmkm5igx36clrbdiafs47i9rik3rdzw0gr3d&quot;;
    };
    nixpkgs = builtins.fetchTarball {
      url = &quot;https://github.com/NixOS/nixpkgs-channels/tarball/9ca57dc9171ca4547abf076a8987ed73c46f2e15&quot;;
      sha256 = &quot;18d01cw6s6k9fnac3vq0k6inybqalkz4ak88pw67q4wqzq9rc07l&quot;;
    };
  };
  nixpkgs = import pkgs.nixpkgs {};
  NB_USER = &quot;jovyan&quot;;
  NB_UID = &quot;1000&quot;;
  dockerEtc = nixpkgs.runCommand &quot;docker-etc&quot; {} ''
    mkdir -p $out/etc/pam.d

    echo &quot;root:x:0:0::/root:/bin/sh&quot; &gt; $out/etc/passwd
    echo &quot;${NB_USER}:x:1000:1000::/home/${NB_USER}:&quot; &gt;&gt; $out/etc/passwd
    echo &quot;root:!x:::::::&quot; &gt; $out/etc/shadow
    echo &quot;${NB_USER}:!:::::::&quot; &gt;&gt; $out/etc/shadow

    echo &quot;root:x:0:&quot; &gt; $out/etc/group
    echo &quot;${NB_USER}:x:1000:&quot; &gt;&gt; $out/etc/group
    echo &quot;root:x::&quot; &gt; $out/etc/gshadow
    echo &quot;${NB_USER}:!::&quot; &gt;&gt; $out/etc/gshadow
  '';
  ihaskell = import &quot;${pkgs.ihaskell}/release.nix&quot; {
    inherit nixpkgs;
    compiler = &quot;ghc864&quot;;
    packages = self: with self; [];
  };
in nixpkgs.dockerTools.buildLayeredImage {
    name = &quot;ihaskell-nix&quot;;
    tag = &quot;latest&quot;;
    contents =  [
      dockerEtc
      ihaskell
      nixpkgs.bashInteractive
    ];
    config = {
      Cmd = [&quot;ihaskell-notebook&quot; &quot;--ip=0.0.0.0&quot;];
      User = NB_USER;
      WorkingDir = &quot;/home/${NB_USER}&quot;;
    };
    extraCommands = ''
      mkdir -m 1777 ./tmp
      mkdir -m 777 -p ./home/${NB_USER}
    '';
    maxLayers = 100;
};</code></pre>
<p>This is how to use it:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker load <span class="op">&lt;</span> <span class="va">$(</span><span class="ex">nix-build</span> default.nix<span class="va">)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> docker run <span class="at">-p8888:8888</span> <span class="at">-it</span> ihaskell-nix:latest</span></code></pre></div>
<p>This uses IHaskell’s <a href="https://github.com/gibiansky/IHaskell/blob/93bfa3a7a434c1dfe6873c2105c43856c282e183/release.nix">built-in
<code>release.nix</code></a>
to do most of the heavy lifting for IHaskell itself, and does a couple of other
things:</p>
<ol type="1">
<li>Creates the <code>/tmp</code> directory</li>
<li>Sets up a <code>jovyan</code> user, because Jupyter complains when run as <code>root</code></li>
<li>Includes <code>bash</code>, which is not strictly necessary but is useful for poking
around in the image and for using <code>:!</code> from within a notebook</li>
</ol>
<p>Building the image and loading it into Docker are both very slow compared to
using Nix directly (even though I’m using the Nix support for layered images),
so I wouldn’t recommend using this approach for local development. I’m
primarily interested in doing this to:</p>
<ol type="1">
<li>Share IHaskell notebooks with people who are less comfortable with Nix</li>
<li>Deploy to platforms such as Amazon’s Elastic Container Service and Google’s
App Engine, which offer excellent support for Docker and no support for Nix</li>
</ol>
<p>Unfortunately this isn’t quite ready to deploy yet, especially because Jupyter
uses token-based authentication by default and the console output will not
necessarily be available after deployment. It’s possible to set a password
instead, so I expect that copying the output of <code>jupyter notebook --generate-config</code> and changing the relevant settings will be enough. I hope
to post instructions when I get around to trying this myself.</p>
<p>In the meantime, I hope this is useful as a way of making IHaskell even more
widely available, and as a demonstration of using <code>dockerTools</code> to bridge the
gap between Nix and Docker!</p>
<p><em>Thanks to <a href="https://grahamc.com">Graham Christensen</a> for improving the Nix
expression to use <code>buildLayeredImage</code>.</em></p>

        </div>
        <div id="footer">
            <div class="rc-webring">
                <a href="https://webring.recurse.com"><img src="https://webring.recurse.com/icon.svg" /> RC Webring</a>
            </div>
            <div class="rc-scout">
                <script async defer src="https://www.recurse-scout.com/loader.js?t=5ac465e5d3396a7e491e42afac4c5c90"></script>
            </div>
        </div>
        <script data-goatcounter="https://vaibhavsagar.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    </body>
</html>
