<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Functional DevOps in a Dysfunctional World - Vaibhav Sagar</title>
        <link href="data:," rel="icon">
        <link rel="stylesheet" type="text/css" href="../../../../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../../../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../../../../">Vaibhav Sagar</a>
            </div>
            <div id="navigation">
                <a href="../../../../../about/">About</a>
                <a href="../../../../../talks/">Talks</a>
                <a href="../../../../../archive/">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Functional DevOps in a Dysfunctional World</h1>

            <div class="info">
    Posted on  4 July 2019
    
</div>
<div class="info">
    
        Tags: <a title="All pages tagged 'programming'." href="../../../../../blog/tags/programming/">programming</a>, <a title="All pages tagged 'nix'." href="../../../../../blog/tags/nix/">nix</a>, <a title="All pages tagged 'devops'." href="../../../../../blog/tags/devops/">devops</a>
    
</div>

<p><em>This is a pseudo-transcript of <a href="https://www.youtube.com/watch?v=RsSNEkBGmj0">a presentation I gave at the linux.conf.au 2018 Real World Functional Programming Miniconf</a>.</em></p>
<p>What is DevOps about? For me it’s about my relationship to the phrase</p>
<blockquote>
<p>It works on my machine.</p>
</blockquote>
<p>I’ve been guilty of saying this in the past, and quite frankly, it isn’t good enough. After the development team has written their last line of code, some amount of work still needs to happen in order for the software to deliver value.</p>
<p>A few jobs ago I was at a small web development shop, and my deployment workflow was as follows:</p>
<ol type="1">
<li>Log on to the development server and take careful notes on how it had diverged from the production server.</li>
<li>Carefully set aside some time to ‘do the deploy’.</li>
<li>Log on to the production server and do a <code>git pull</code> to get the latest code changes.</li>
<li>Perform database migrations according to the notes you made earlier.</li>
<li>Manually make any other required changes.</li>
</ol>
<p>Despite my best efforts, I would inevitably run into issues whenever I did this, resulting in site outages and frustrated clients. This was far from ideal, but I wasn’t able to articulate why at the time.</p>
<p>I posit that a better deployment process has the following properties:</p>
<ul>
<li><p><strong>Automatic</strong>: instead of a manual multi-step process, it has a single step, which can be performed automatically.</p></li>
<li><p><strong>Repeatable</strong>: instead of only being able to deploy to one lovingly hand-maintained server, it can deploy reliably multiple times to multiple servers.</p></li>
<li><p><strong>Idempotent</strong>: if the target is already in the desired state, no extra work needs to be done.</p></li>
<li><p><strong>Reversible</strong>: if it turns out I made a mistake, I can go back to the previous state.</p></li>
<li><p><strong>Atomic</strong>: an external observer can only see the new state or the old state, not any intermediate state.</p></li>
</ul>
<p>I hope to demonstrate how the Nix suite of tools (Nix, NixOS, and NixOps) fulfill these properties and provide a better DevOps experience.</p>
<p>To make things easier, I’m not assuming that you already run NixOS. Any Linux distro should do, as long as you’ve <a href="https://nixos.org/nix/download.html">installed Nix</a>. macOS users will be able to follow along until I get to the NixOps section.</p>
<h2 id="shipping-it">Shipping it</h2>
<h3 id="packaging">Packaging</h3>
<p>Suppose we have been given a small Haskell app to get up and running:</p>
<p><em>Main.hs</em></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Web.Scotty</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Data.Monoid</span> (mconcat)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>main <span class="ot">=</span> scotty <span class="dv">3000</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>    get <span class="st">&quot;/:word&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>        beam <span class="ot">&lt;-</span> param <span class="st">&quot;word&quot;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>        html <span class="op">$</span> <span class="fu">mconcat</span> [<span class="st">&quot;&lt;h1&gt;Scotty, &quot;</span>, beam, <span class="st">&quot; me up!&lt;/h1&gt;&quot;</span>]</span></code></pre></div>
<p><em>blank-me-up.cabal</em></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>name<span class="op">:</span>                blank<span class="op">-</span>me<span class="op">-</span>up</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>version<span class="op">:</span>             <span class="fl">0.1</span><span class="op">.</span><span class="fl">0.0</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>license<span class="op">:</span>             <span class="dt">BSD3</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>build<span class="op">-</span><span class="kw">type</span><span class="op">:</span>          <span class="dt">Simple</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>cabal<span class="op">-</span>version<span class="op">:</span>       <span class="op">&gt;=</span><span class="fl">1.10</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>executable blank<span class="op">-</span>me<span class="op">-</span>up</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>  main<span class="op">-</span>is<span class="op">:</span>             Main.hs</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>  build<span class="op">-</span>depends<span class="op">:</span>       base <span class="op">&gt;=</span><span class="fl">4.9</span> <span class="op">&amp;&amp;</span> <span class="op">&lt;</span><span class="dv">5</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>                     , scotty</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>  default<span class="op">-</span>language<span class="op">:</span>    <span class="dt">Haskell2010</span></span></code></pre></div>
<p>(This example is taken straight from <a href="https://github.com/scotty-web/scotty/blob/306fee7121dc41a55bd4e9b785f8366198de7e3c/README.md#scotty-">Scotty’s README</a>.)</p>
<p>Our first step is to build this app and quickly check that it works. We’ll need Nix and <code>cabal2nix</code>, which turns <code>.cabal</code> files into configuration for the Nix package manager. Assuming we’ve installed <code>cabal2nix</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>$ <span class="ex">nix-env</span> -i cabal2nix</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="op">&lt;</span><span class="ex">a</span> lot of output<span class="op">&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="ex">created</span> <span class="op">&lt;</span>number<span class="op">&gt;</span> symlinks in user environment</span></code></pre></div>
<p>How do we know it worked? Try <code>nix-env -q</code> (short for <code>--query</code>):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>$ <span class="ex">nix-env</span> -q</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="ex">cabal2nix</span></span></code></pre></div>
<p>Okay, assuming the app is in the <code>app</code> subdirectory, let’s create a directory called <code>nix</code> to store our <code>.nix</code> files and begin:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>$ <span class="bu">cd</span> nix</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>$ <span class="ex">cabal2nix</span> ../app/ --shell <span class="op">&gt;</span> default.nix</span></code></pre></div>
<p><code>default.nix</code> might look something like</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">{</span> <span class="ex">nixpkgs</span> ? import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {<span class="kw">}</span>, <span class="ex">compiler</span> ? <span class="st">&quot;default&quot;</span> }:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="bu">let</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>  <span class="ex">inherit</span> (nixpkgs) <span class="ex">pkgs</span><span class="kw">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>  <span class="ex">f</span> = { mkDerivation, base, scotty, stdenv }:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>      <span class="ex">mkDerivation</span> {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>        <span class="ex">pname</span> = <span class="st">&quot;blank-me-up&quot;</span><span class="kw">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>        <span class="ex">version</span> = <span class="st">&quot;0.1.0.0&quot;</span><span class="kw">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>        <span class="ex">src</span> = ../app<span class="kw">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>        <span class="ex">isLibrary</span> = false<span class="kw">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>        <span class="ex">isExecutable</span> = true<span class="kw">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a>        <span class="ex">executableHaskellDepends</span> = [ base scotty ]<span class="kw">;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a>        <span class="ex">license</span> = stdenv.lib.licenses.bsd3<span class="kw">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a>      };</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a>  <span class="ex">haskellPackages</span> = if compiler == <span class="st">&quot;default&quot;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a>                       <span class="kw">then</span> <span class="ex">pkgs.haskellPackages</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a>                       <span class="kw">else</span> <span class="ex">pkgs.haskell.packages.</span><span class="va">${compiler}</span><span class="kw">;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a>  <span class="ex">drv</span> = haskellPackages.callPackage f {};</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a><span class="kw">in</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a>  <span class="kw">if</span> <span class="ex">pkgs.lib.inNixShell</span> then drv.env else drv</span></code></pre></div>
<p>Now we can build our project by running <code>nix-build</code>, which tries to build <code>default.nix</code> in the current directory if no arguments are provided:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>$ <span class="ex">nix-build</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="op">&lt;</span><span class="ex">lots</span> of output<span class="op">&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="ex">/nix/store</span>/<span class="op">&lt;</span><span class="bu">hash</span><span class="op">&gt;</span>-blank-me-up-0.1.0.0</span></code></pre></div>
<p>There should also be a new <code>result</code> symlink in the current directory, which points to the path above:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>$ <span class="fu">readlink</span> result</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="ex">/nix/store</span>/<span class="op">&lt;</span><span class="bu">hash</span><span class="op">&gt;</span>-blank-me-up-0.1.0.0</span></code></pre></div>
<p>Notice that we’ve built a Haskell executable without having to directly deal with any Haskell-specific tooling (unless you count <code>cabal2nix</code>). Nix works best if you allow it full control over builds, as we do here.</p>
<p>What happens if we run <code>nix-build</code> again without changing anything?</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a>$ <span class="ex">nix-build</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="ex">/nix/store</span>/<span class="op">&lt;</span><span class="bu">hash</span><span class="op">&gt;</span>-blank-me-up-0.1.0.0</span></code></pre></div>
<p>It should be nearly instantaneous and not require rebuilding anything. Nix tries to think of build outputs as a pure function of its inputs, and since our inputs are unchanged, it is able to give us back the same path that it did before. This is what I mean when I say Nix is declarative.</p>
<p>What if we break our app:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">--- a/functional-devops/app/Main.hs</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="dt">+++ b/functional-devops/app/Main.hs</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="dt">@@ -4,6 +4,8 @@ import Web.Scotty</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a> import Data.Monoid (mconcat)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a><span class="va">+broken</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a><span class="va">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a> main = scotty 3000 $ do</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a>     get &quot;/:word&quot; $ do</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a>         beam &lt;- param &quot;word&quot;</span></code></pre></div>
<p>and try to build again?</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>$ <span class="ex">nix-build</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="op">&lt;</span><span class="ex">...</span><span class="op">&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="ex">Building</span> executable <span class="st">'blank-me-up'</span> for blank-me-up-0.1.0.0..</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>[<span class="ex">1</span> of 1] Compiling Main             ( Main.hs, dist/build/blank-me-up/blank-me-up-tmp/Main.o )</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a><span class="ex">Main.hs</span>:7:1: error:</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>    <span class="ex">Parse</span> error: module header, import declaration</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>    <span class="ex">or</span> top-level declaration expected.</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>  <span class="kw">|</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a><span class="ex">7</span> <span class="kw">|</span> <span class="ex">broken</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>  <span class="kw">|</span> ^^^^^^</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a><span class="ex">builder</span> for <span class="st">'/nix/store/&lt;hash&gt;-blank-me-up-0.1.0.0.drv'</span> failed with exit code 1</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a><span class="ex">error</span>: build of <span class="st">'/nix/store/&lt;hash&gt;-blank-me-up-0.1.0.0.drv'</span> failed</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a><span class="op">&lt;</span><span class="ex">...</span><span class="op">&gt;</span></span></code></pre></div>
<p>It fails, as one would hope, but more importantly the previous symlink at <code>result</code> is still available! This is because <code>nix-build</code> completes the build before atomically updating the symlink at <code>result</code> to point to the new artifact. This way, we can move from one known working state to another, without exposing our users to any intermediate brokenness.</p>
<h3 id="service-configuration">Service Configuration</h3>
<p>Okay, now that we’re able to successfully build the app, let’s configure a service file so that <code>systemd</code> can manage our app. I don’t know of any tools that automatically generate this so I always find myself copying and pasting from an existing service file. Here’s one I prepared earlier.</p>
<p><em>nix/service.nix</em></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">{</span> <span class="ex">config</span>, lib, pkgs, ... <span class="kw">}</span>:                                               #<span class="ex">1</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="bu">let</span>                                                                       #2</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>  <span class="ex">blank-me-up</span> = pkgs.callPackage ./default.nix {};                        #<span class="ex">3</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a><span class="kw">in</span> <span class="kw">{</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>  <span class="ex">options.services.blank-me-up.enable</span> = lib.mkEnableOption <span class="st">&quot;Blank Me Up&quot;</span><span class="kw">;</span> #<span class="ex">4</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>  <span class="ex">config</span> = lib.mkIf config.services.blank-me-up.enable {                  #5</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>    <span class="ex">networking.firewall.allowedTCPPorts</span> = [ 3000 ]<span class="kw">;</span>                       #<span class="ex">6</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a>    <span class="ex">systemd.services.blank-me-up</span> = {                                      #7</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a>      <span class="ex">description</span> = <span class="st">&quot;Blank Me Up&quot;</span><span class="kw">;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>      <span class="ex">after</span> = [ <span class="st">&quot;network.target&quot;</span> ]<span class="kw">;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a>      <span class="ex">wantedBy</span> = [ <span class="st">&quot;multi-user.target&quot;</span> ]<span class="kw">;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>      <span class="ex">serviceConfig</span> = {</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a>        <span class="ex">ExecStart</span> = <span class="st">&quot;</span><span class="va">${blank-</span>me-up<span class="va">}</span><span class="st">/bin/blank-me-up&quot;</span><span class="kw">;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a>        <span class="ex">Restart</span> = <span class="st">&quot;always&quot;</span><span class="kw">;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a>        <span class="ex">KillMode</span> = <span class="st">&quot;process&quot;</span><span class="kw">;</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a>      <span class="kw">}</span>;</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a>    };</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a>  };</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a>}</span></code></pre></div>
<p>This isn’t intended to be a Nix language tutorial, but there are a few interesting things that I want to point out. For a more comprehensive overview of the language, see <a href="https://medium.com/@MrJamesFisher/nix-by-example-a0063a1a4c55">here</a> or <a href="https://nixos.org/nix/manual/#ch-expression-language">here</a>.</p>
<ol type="1">
<li>These are the arguments to this expression that the caller will pass. Another way to think of this is as a form of dependency injection.</li>
<li><code>let</code> expressions work similarly to Haskell.</li>
<li>This is the equivalent of our <code>nix-build</code> from before.</li>
<li>We define a single option that enables our service.</li>
<li>The <code>config</code> attribute contains service configuration.</li>
<li>We expose port 3000.</li>
<li>If you squint this looks a lot like a regular unit file. More on this below.</li>
</ol>
<p>It would be useful to look at the systemd service file that gets generated from this configuration. To do this, we’ll need one more file:</p>
<p><em>ops/webserver.nix</em></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="kw">{</span> <span class="ex">...</span> <span class="kw">}</span>: <span class="kw">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>  <span class="ex">imports</span> = [ ../nix/service.nix ]<span class="kw">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>  <span class="ex">services.blank-me-up.enable</span> = true<span class="kw">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a><span class="kw">}</span></span></code></pre></div>
<p>This is a function that imports the above configuration and enables the <code>blank-me-up</code> service. With this in place, we can do</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a>$ <span class="ex">nix-instantiate</span> --eval -E <span class="st">'(import &lt;nixpkgs/nixos/lib/eval-config.nix&gt; { modules = [./ops/webserver.nix]; }).config.systemd.units.&quot;blank-me-up.service&quot;.text'</span></span></code></pre></div>
<p>We’re using <code>nix-instantiate</code> to evaluate (<code>--eval</code>) an expression (<code>-E</code>) that uses <code>eval-config.nix</code> from the library to import the file we created and output the text of the final unit file. The output of this is pretty messy, but we can use <code>jq</code> to clean it up:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>$ <span class="ex">nix-instantiate</span> --eval -E <span class="st">'(import &lt;nixpkgs/nixos/lib/eval-config.nix&gt; { modules = [./ops/webserver.nix]; }).config.systemd.units.&quot;blank-me-up.service&quot;.text'</span> <span class="kw">|</span> <span class="ex">jq</span> -r</span></code></pre></div>
<p>Here’s what that looks like on my machine:</p>
<details>
<summary style="cursor: pointer;">
Generated <code>systemd</code> service
</summary>
<div class="sourceCode" id="cb16"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>[Unit]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>After=network.target</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>Description=Blank Me Up</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>[Service]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>Environment=&quot;LOCALE_ARCHIVE=/nix/store/&lt;hash&gt;-glibc-locales-2.27/lib/locale/locale-archive&quot;</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>Environment=&quot;PATH=/nix/store/&lt;hash&gt;-coreutils-8.30/bin:/nix/store/&lt;hash&gt;-findutils-4.6.0/bin:/nix/store/&lt;hash&gt;-gnugrep-3.3/bin:/nix/store/&lt;hash&gt;-gnused-4.7/bin:/nix/store/&lt;hash&gt;-systemd-239.20190219/bin:/nix/store/&lt;hash&gt;-coreutils-8.30/sbin:/nix/store/&lt;hash&gt;-findutils-4.6.0/sbin:/nix/store/&lt;hash&gt;-gnugrep-3.3/sbin:/nix/store/&lt;hash&gt;-gnused-4.7/sbin:/nix/store/&lt;hash&gt;-systemd-239.20190219/sbin&quot;</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>Environment=&quot;TZDIR=/nix/store/&lt;hash&gt;-tzdata-2019a/share/zoneinfo&quot;</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a>ExecStart=/nix/store/&lt;hash&gt;-blank-me-up-0.1.0.0/bin/blank-me-up</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>KillMode=process</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a>Restart=always</span></code></pre></div>
</details>
<p>Hopefully at this point you’re convinced that Nix can take some quasi-JSON and turn it into a binary and a <code>systemd</code> service file. Let’s deploy this!</p>
<h3 id="deploying">Deploying</h3>
<p>First, we install NixOps:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a>$ <span class="ex">nix-env</span> -i nixops</span></code></pre></div>
<p>We also have to set up VirtualBox, which I’ll be using as my deploy target. If you’re using NixOS this is as simple as adding the following line to <code>configuration.nix</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="ex">virtualisation.virtualbox.host.enable</span> = true<span class="kw">;</span></span></code></pre></div>
<p>and running <code>sudo nixos-rebuild switch</code>. If you’re using another Linux distro, install VirtualBox and set up a host-only network called <code>vboxnet0</code>.</p>
<p>We’ll be using the <a href="https://nixos.org/nixops/manual/#idm140737318606176">instructions from the manual</a> as our starting point. Create two files:</p>
<p><em>ops/trivial.nix</em></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="kw">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>  <span class="ex">network.description</span> = <span class="st">&quot;Web server&quot;</span><span class="kw">;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>  <span class="ex">network.enableRollback</span> = true<span class="kw">;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>  <span class="ex">webserver</span> = import ./webserver.nix<span class="kw">;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a><span class="kw">}</span></span></code></pre></div>
<p><em>ops/trivial-vbox.nix</em></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="kw">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>  <span class="ex">webserver</span> =</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>    <span class="kw">{</span> <span class="ex">config</span>, pkgs, ... <span class="kw">}</span>:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>    <span class="kw">{</span> <span class="ex">deployment.targetEnv</span> = <span class="st">&quot;virtualbox&quot;</span><span class="kw">;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>      <span class="ex">deployment.virtualbox.headless</span> = true<span class="kw">;</span> # <span class="ex">don</span><span class="st">'t show a display</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a><span class="st">      deployment.virtualbox.memorySize = 1024; # megabytes</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a><span class="st">      deployment.virtualbox.vcpu = 2; # number of cpus</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a><span class="st">    };</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a><span class="st">}</span></span></code></pre></div>
<p>We should now be able to create a new deployment:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a>$ <span class="bu">cd</span> ops</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>$ <span class="ex">nixops</span> create trivial.nix trivial-vbox.nix -d trivial</span></code></pre></div>
<p>and deploy it:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a>$ <span class="ex">nixops</span> deploy -d trivial</span></code></pre></div>
<p>and assuming that everything goes well, we should see a lot of terminal output and at least one mention of <code>ssh://root@&lt;ip&gt;</code>, which is the IP of our target.</p>
<p>We should then be able to go to <code>http://&lt;ip&gt;:3000</code> and see our web app in action!</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a>$ <span class="ex">curl</span> http://<span class="op">&lt;</span>ip<span class="op">&gt;</span>:3000/help</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a><span class="op">&lt;</span><span class="ex">h1</span><span class="op">&gt;</span>Scotty, help me up!<span class="op">&lt;</span>/h1<span class="op">&gt;</span></span></code></pre></div>
<p>NixOps also allows us to SSH in for troubleshooting purposes or to view logs:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a>$ <span class="ex">nixops</span> ssh -d trivial webserver</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a><span class="op">&lt;</span><span class="ex">...</span><span class="op">&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>[<span class="ex">root@webserver</span>:~]# systemctl status blank-me-up</span></code></pre></div>
<h2 id="responding-to-change">Responding to change</h2>
<p>This is fantastic, but deployments are rarely fire-and-forget. What happens when our requirements change? In fact, there’s a serious issue with our application, which is that it hardcodes the port that it listens on. If we wanted it to listen on a different port, or to run more than one instance of it on the same machine, we’d need to do something differently.</p>
<p>The correct solution would be to talk to the developers and have them implement support, but in the meantime, how should we proceed?</p>
<h3 id="patching">Patching</h3>
<p>Nix gives us full control over each part of the build and deployment process, and we can patch the software as a stopgap measure. Although this scenario is somewhat contrived, I have in fact had to take matters into my own hands like this in the past when the development team hasn’t been able to prioritise fixing a production issue.</p>
<p>Our new expression looks like this:</p>
<p><em>nix/patched.nix</em></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="ex">args@</span>{ nixpkgs ? import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {}, <span class="ex">compiler</span> ? <span class="st">&quot;default&quot;</span> }:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a><span class="kw">(</span><span class="ex">import</span> ./default.nix args<span class="kw">)</span><span class="ex">.overrideAttrs</span> (old: {</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>  <span class="ex">postPatch</span> = let</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>    <span class="ex">oldImport</span> = <span class="st">''</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a>      <span class="ex">import</span> Web.Scotty</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a>    <span class="st">''</span>;</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true"></a>    <span class="ex">newImport</span> = <span class="st">''</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true"></a>      <span class="ex">import</span> Web.Scotty</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true"></a>      <span class="ex">import</span> System.Environment (getArgs)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true"></a>    <span class="st">''</span>;</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true"></a>    <span class="ex">oldMain</span> = <span class="st">''</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true"></a>      <span class="ex">main</span> = scotty 3000 $ do</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true"></a>    <span class="st">''</span>;</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true"></a>    <span class="ex">newMain</span> = <span class="st">''</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true"></a>      <span class="ex">main</span> = getArgs <span class="op">&gt;&gt;</span>= <span class="dt">\(</span>port:_) <span class="ex">-</span><span class="op">&gt;</span> scotty (read port) $ <span class="kw">do</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true"></a>    <span class="st">''</span>;</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true"></a>  <span class="kw">in</span> <span class="st">''</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true"></a>    <span class="ex">substituteInPlace</span> Main.hs --replace <span class="st">'${oldImport}'</span> <span class="st">'${newImport}'</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true"></a>    <span class="ex">substituteInPlace</span> Main.hs --replace <span class="st">'${oldMain}'</span>   <span class="st">'${newMain}'</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true"></a>    <span class="fu">cat</span> Main.hs</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true"></a>  <span class="st">''</span>;</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true"></a>})</span></code></pre></div>
<p>I’ve added that <code>cat Main.hs</code> at the end to</p>
<ul>
<li>confirm that the file was correctly patched</li>
<li>emphasise that arbitrary shell commands can be executed</li>
</ul>
<p>We can create a new service definition to use this expression:</p>
<p><em>nix/service-patched.nix</em></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="kw">{</span> <span class="ex">config</span>, lib, pkgs, ... <span class="kw">}</span>:</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a><span class="bu">let</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>  <span class="ex">blank-me-up</span> = pkgs.callPackage ./patched.nix { nixpkgs = pkgs<span class="kw">;</span> };</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a>  <span class="ex">cfg</span> = config.services.blank-me-up<span class="kw">;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a><span class="kw">in</span> <span class="kw">{</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a>  <span class="ex">options.services.blank-me-up.enable</span> = lib.mkEnableOption <span class="st">&quot;Blank Me Up&quot;</span><span class="kw">;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true"></a>  <span class="ex">options.services.blank-me-up.port</span> = lib.mkOption {</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true"></a>    <span class="ex">default</span> = 3000<span class="kw">;</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true"></a>    <span class="bu">type</span> = lib.types.int<span class="kw">;</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true"></a>  <span class="kw">}</span>;</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true"></a>  <span class="ex">config</span> = lib.mkIf cfg.enable {</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true"></a>    <span class="ex">networking.firewall.allowedTCPPorts</span> = [ cfg.port ]<span class="kw">;</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true"></a>    <span class="ex">systemd.services.blank-me-up</span> = {</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true"></a>      <span class="ex">description</span> = <span class="st">&quot;Blank Me Up&quot;</span><span class="kw">;</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true"></a>      <span class="ex">after</span> = [ <span class="st">&quot;network.target&quot;</span> ]<span class="kw">;</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true"></a>      <span class="ex">wantedBy</span> = [ <span class="st">&quot;multi-user.target&quot;</span> ]<span class="kw">;</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true"></a>      <span class="ex">serviceConfig</span> = {</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true"></a>        <span class="ex">ExecStart</span> = <span class="st">&quot;</span><span class="va">${blank-</span>me-up<span class="va">}</span><span class="st">/bin/blank-me-up </span><span class="va">${toString</span><span class="er"> cfg.port</span><span class="va">}</span><span class="st">&quot;</span><span class="kw">;</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true"></a>        <span class="ex">Restart</span> = <span class="st">&quot;always&quot;</span><span class="kw">;</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true"></a>        <span class="ex">KillMode</span> = <span class="st">&quot;process&quot;</span><span class="kw">;</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true"></a>      };</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true"></a>    };</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true"></a>  };</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true"></a>}</span></code></pre></div>
<p>We make sure to pass the configured port in on startup and open the firewall appropriately.</p>
<h3 id="deploying-again">Deploying (Again)</h3>
<p>We update <code>webserver.nix</code> to use the patched service and specify a different port:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="kw">{</span> <span class="ex">...</span> <span class="kw">}</span>: <span class="kw">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a>  <span class="ex">imports</span> = [ ../nix/service-patched.nix ]<span class="kw">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a>  <span class="ex">services.blank-me-up.enable</span> = true<span class="kw">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a>  <span class="ex">services.blank-me-up.port</span> = 3001<span class="kw">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a><span class="kw">}</span></span></code></pre></div>
<p>And we can deploy again!</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a>$ <span class="ex">nixops</span> deploy -d trivial</span></code></pre></div>
<p>The service should now be running on <code>http://&lt;ip&gt;:3001</code> instead of <code>http://&lt;ip&gt;:3000</code>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a>$ <span class="ex">curl</span> http://<span class="op">&lt;</span>ip<span class="op">&gt;</span>:3001/pull</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a><span class="op">&lt;</span><span class="ex">h1</span><span class="op">&gt;</span>Scotty, pull me up!<span class="op">&lt;</span>/h1<span class="op">&gt;</span></span></code></pre></div>
<p>If we made a mistake, rolling back is easy:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a>$ <span class="ex">nixops</span> list-generations -d trivial</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a>   <span class="ex">1</span>   <span class="op">&lt;</span>timestamp<span class="op">&gt;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a>   <span class="ex">2</span>   <span class="op">&lt;</span>timestamp<span class="op">&gt;</span>   (current)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>$ <span class="ex">nixops</span> rollback -d trivial 1</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a><span class="ex">switching</span> from generation 2 to 1</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a><span class="ex">webserver</span><span class="op">&gt;</span> copying closure...</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a><span class="ex">trivial</span><span class="op">&gt;</span> closures copied successfully</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a><span class="op">&lt;</span><span class="fu">more</span> output<span class="op">&gt;</span></span></code></pre></div>
<p>and in fact nothing needs to be copied to the target, because the previous deployment is still there.</p>
<h2 id="conclusion">Conclusion</h2>
<p>As demonstrated, the Nix ecosystem allows us to impose order on the usually messy and ad-hoc practice of packaging and deploying software at scale. I’m satisfied that this is the way forward and hope that you will consider using these tools to tackle problems of your own!</p>

        </div>
        <div id="footer">
            <div class="rc-webring">
                <a href="https://webring.recurse.com"><img src="https://webring.recurse.com/icon.svg" /> RC Webring</a>
            </div>
            <div class="rc-scout">
                <script async defer src="https://www.recurse-scout.com/loader.js?t=5ac465e5d3396a7e491e42afac4c5c90"></script>
            </div>
        </div>
        <script data-goatcounter="https://vaibhavsagar.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    </body>
</html>
