<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>You Could Have Invented The State Monad - Vaibhav Sagar</title>
        <link href="data:," rel="icon">
        <link rel="stylesheet" type="text/css" href="../../../../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../../../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../../../../">Vaibhav Sagar</a>
            </div>
            <div id="navigation">
                <a href="../../../../../about/">About</a>
                <a href="../../../../../talks/">Talks</a>
                <a href="../../../../../archive/">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>You Could Have Invented The State Monad</h1>

            <div class="info">
    Posted on 17 June 2016
    
</div>
<div class="info">
    
        Tags: <a title="All pages tagged 'programming'." href="../../../../../blog/tags/programming/" rel="tag">programming</a>, <a title="All pages tagged 'haskell'." href="../../../../../blog/tags/haskell/" rel="tag">haskell</a>, <a title="All pages tagged 'monads'." href="../../../../../blog/tags/monads/" rel="tag">monads</a>
    
</div>

<p>I’m attempting <a href="https://github.com/NICTA/course">NICTA/course</a> a second time. I
gave up the last time because none of the State exercises were making sense and
I found myself leaning so heavily on the solutions that I wasn’t actually
learning anything. This time I was much better prepared after watching lots of
<a href="http://www.meetup.com/CanFPG/">CanFPG</a> talks, reading lots of blog posts and
writing a little Haskell, and I easily cleared the State hurdle. In fact, I’m
now going to demonstrate how you (yes, <em>you</em>) could have come up with it (with
a little help).</p>
<p>The fundamental insight of state is that it can be represented by a function
that takes a value of type <code>s</code> and returns a tuple of some value <code>a</code> and a new
value of type <code>s</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">newtype</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">a</span><span> </span><span class="ot">=</span><span> </span><span class="dt">State</span><span> </span><span class="ot">{</span><span> </span><span class="va">runState</span><span> </span><span class="ot">::</span><span> </span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="va">a</span><span class="ot">,</span><span class="va">s</span><span class="ot">)</span><span> </span><span class="ot">}</span></code></pre></div>
<p>Given such a type, what would its <code>Functor</code> instance look like?</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span><span> </span><span class="dt">Functor</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">s</span><span class="ot">)</span><span> </span><span class="kw">where</span><span>
  </span><span class="ot">(</span><span class="op">&lt;$&gt;</span><span class="ot">)</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">b</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">b</span></code></pre></div>
<p>Our implementation should be another State that takes a value <code>s0</code>, passes it
to the second argument <code>sa</code> (resulting in <code>(a, s1)</code>) and calls the function
<code>fn</code> on <code>a</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>  </span><span class="ot">(</span><span class="op">&lt;$&gt;</span><span class="ot">)</span><span> </span><span class="va">fn</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">sa</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s0</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">let</span><span> </span><span class="ot">(</span><span class="va">a</span><span class="ot">,</span><span> </span><span class="va">s1</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="va">sa</span><span> </span><span class="va">s0</span><span> </span><span class="kw">in</span><span> </span><span class="ot">(</span><span class="va">fn</span><span> </span><span class="va">a</span><span class="ot">,</span><span> </span><span class="va">s1</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p>This is a State that takes <code>s0</code> and returns <code>(b, s1)</code>, which is exactly what we
wanted.</p>
<p>Let’s look at the <code>Applicative</code> instance next:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span><span> </span><span class="dt">Applicative</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">s</span><span class="ot">)</span><span> </span><span class="kw">where</span><span>
  </span><span class="va">pure</span><span>  </span><span class="ot">::</span><span> </span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">a</span><span>
  </span><span class="ot">(</span><span class="op">&lt;*&gt;</span><span class="ot">)</span><span> </span><span class="ot">::</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">b</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">b</span></code></pre></div>
<p>The implementation for <code>pure</code> explains where the <code>a</code> in our State comes from.
Given some <code>a</code>, return a State that, when fed a value <code>s</code>, results in <code>(a,s)</code>.
It practically writes itself.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>  </span><span class="va">pure</span><span> </span><span class="va">a</span><span> </span><span class="ot">=</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="va">a</span><span class="ot">,</span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p><code>(&lt;*&gt;)</code> is a bit trickier, because we’re dealing with both the State the
function is in and the State its argument is in. The implementation should be a
State that takes a value <code>s0</code>, feeds it to <code>sa</code> to get <code>(fn, s1)</code>, feeds <code>s1</code>
to <code>sb</code> to get <code>(a, s2)</code>, and calls <code>fn</code> on <code>a</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>  </span><span class="ot">(</span><span class="op">&lt;*&gt;</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">sa</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">sb</span><span class="ot">)</span><span> </span><span class="ot">=</span><span>
    </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s0</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">let</span><span> </span><span class="ot">(</span><span class="va">fn</span><span class="ot">,</span><span> </span><span class="va">s1</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="va">sa</span><span> </span><span class="va">s0</span><span>
                      </span><span class="ot">(</span><span class="va">a</span><span class="ot">,</span><span>  </span><span class="va">s2</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="va">sb</span><span> </span><span class="va">s1</span><span>
                  </span><span class="kw">in</span><span> </span><span class="ot">(</span><span class="va">fn</span><span> </span><span class="va">a</span><span class="ot">,</span><span> </span><span class="va">s2</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p>The hardest thing is remembering to thread <code>s0</code> through <code>sa</code> and <code>sb</code> so that
we don’t lose any state on the way. We can usually follow the types but they
don’t help in this specific case.</p>
<p>Finally, let’s look at the <code>Monad</code> instance:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span><span> </span><span class="dt">Monad</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">s</span><span class="ot">)</span><span> </span><span class="kw">where</span><span>
  </span><span class="ot">(</span><span class="op">&gt;&gt;=</span><span class="ot">)</span><span> </span><span class="ot">::</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">b</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">b</span></code></pre></div>
<p>As with all our previous implementations, it has the form:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>  </span><span class="ot">(</span><span class="op">&gt;&gt;=</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">sa</span><span class="ot">)</span><span> </span><span class="va">fn</span><span> </span><span class="ot">=</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s0</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">let</span><span> </span><span class="op">???</span><span> </span><span class="kw">in</span><span> </span><span class="op">???</span><span class="ot">)</span></code></pre></div>
<p>We know that we need to feed <code>s0</code> to <code>sa</code> to get an <code>a</code> to apply to <code>fn</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>  </span><span class="ot">(</span><span class="op">&gt;&gt;=</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">sa</span><span class="ot">)</span><span> </span><span class="va">fn</span><span> </span><span class="ot">=</span><span>
    </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s0</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">let</span><span> </span><span class="ot">(</span><span class="va">a</span><span class="ot">,</span><span> </span><span class="va">s1</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="va">sa</span><span> </span><span class="va">s0</span><span>
                      </span><span class="op">???</span><span>     </span><span class="ot">=</span><span> </span><span class="va">fn</span><span> </span><span class="va">a</span><span>
                  </span><span class="kw">in</span><span> </span><span class="op">???</span><span class="ot">)</span></code></pre></div>
<p>The result of <code>fn a</code> is a <code>State sb</code> but we need to return a tuple of <code>(b, s)</code>.
We can obtain one by feeding <code>s1</code> to <code>sb</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>  </span><span class="ot">(</span><span class="op">&gt;&gt;=</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">sa</span><span class="ot">)</span><span> </span><span class="va">fn</span><span> </span><span class="ot">=</span><span>
    </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s0</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">let</span><span> </span><span class="ot">(</span><span class="va">a</span><span class="ot">,</span><span> </span><span class="va">s1</span><span class="ot">)</span><span>  </span><span class="ot">=</span><span> </span><span class="va">sa</span><span> </span><span class="va">s0</span><span>
                      </span><span class="dt">State</span><span> </span><span class="va">sb</span><span> </span><span class="ot">=</span><span> </span><span class="va">fn</span><span> </span><span class="va">a</span><span>
                  </span><span class="kw">in</span><span> </span><span class="va">sb</span><span> </span><span class="va">s1</span><span class="ot">)</span></code></pre></div>
<p>Success!</p>
<p>Let’s define a few functions to make our lives easier. <code>get</code> returns a State
that, when fed some <code>s</code>, returns <code>(s,s)</code>. This allows us to expose <code>s</code> for
direct modification:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">get</span><span> </span><span class="ot">::</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">s</span><span>
</span><span class="va">get</span><span> </span><span class="ot">=</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="va">s</span><span class="ot">,</span><span> </span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p><code>put</code> allows us to store a State that ignores the <code>s</code> passed to it later:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">put</span><span> </span><span class="ot">::</span><span> </span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
</span><span class="va">put</span><span> </span><span class="va">s</span><span> </span><span class="ot">=</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p>Sometimes we want the <code>s</code> and not the <code>a</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">exec</span><span> </span><span class="ot">::</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">s</span><span>
</span><span class="va">exec</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">sa</span><span class="ot">)</span><span> </span><span class="va">s</span><span> </span><span class="ot">=</span><span> </span><span class="va">snd</span><span> </span><span class="op">$</span><span> </span><span class="va">sa</span><span> </span><span class="va">s</span></code></pre></div>
<p>At other times we want the <code>a</code> and not the <code>s</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">eval</span><span> </span><span class="ot">::</span><span> </span><span class="dt">State</span><span> </span><span class="va">s</span><span> </span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">a</span><span>
</span><span class="va">eval</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="va">sa</span><span class="ot">)</span><span> </span><span class="va">s</span><span> </span><span class="ot">=</span><span> </span><span class="va">fst</span><span> </span><span class="op">$</span><span> </span><span class="va">sa</span><span> </span><span class="va">s</span></code></pre></div>
<p>With all this machinery in place, we can do this:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">Prelude</span><span class="op">&gt;</span><span> </span><span class="va">exec</span><span> </span><span class="ot">(</span><span class="kw">do</span><span> </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">get</span><span class="ot">;</span><span> </span><span class="va">put</span><span> </span><span class="ot">(</span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">;</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="dv">0</span><span>
</span><span class="dv">1</span></code></pre></div>
<p>I still couldn’t believe that this worked the first time I tried it, so let’s
desugar this:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>    </span><span class="kw">do</span><span> </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">get</span><span class="ot">;</span><span> </span><span class="va">put</span><span> </span><span class="ot">(</span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">;</span><span> </span><span class="va">return</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
 </span><span class="op">==</span><span> </span><span class="va">get</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">i</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">put</span><span> </span><span class="ot">(</span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">pure</span><span> </span><span class="ot">(</span><span class="ot">)</span><span>
 </span><span class="op">==</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="va">s</span><span class="ot">,</span><span> </span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span><span>    </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">i</span><span> </span><span class="ot">-&gt;</span><span>
    </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span>
    </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p>Let’s simplify from the bottom up. By the definition of <code>(&gt;&gt;=)</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>    </span><span class="ot">(</span><span class="op">&gt;&gt;=</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="ot">=</span><span>
      </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s0</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">let</span><span> </span><span class="ot">(</span><span class="va">a</span><span class="ot">,</span><span> </span><span class="va">s1</span><span class="ot">)</span><span>  </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="va">s0</span><span>
                     </span><span class="co">-- (a, s1)  = ((), i+1)</span><span>
                        </span><span class="dt">State</span><span> </span><span class="va">sb</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="va">a</span><span>
                     </span><span class="co">--       sb = (\s -&gt; ((), s))</span><span>
                    </span><span class="kw">in</span><span> </span><span class="va">sb</span><span> </span><span class="va">s1</span><span class="ot">)</span><span>
                     </span><span class="co">-- ((), i+1)</span><span>
</span><span class="op">==</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s0</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span>
</span><span class="op">==</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span>  </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p>Plugging that back in, we have</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="va">s</span><span class="ot">,</span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="op">&gt;&gt;=</span><span> </span><span class="ot">\</span><span class="va">i</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p>Which we can simplify in the same way:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>    </span><span class="ot">(</span><span class="op">&gt;&gt;=</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="va">s</span><span class="ot">,</span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">i</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="ot">=</span><span>
      </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s0</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">let</span><span> </span><span class="ot">(</span><span class="va">a</span><span class="ot">,</span><span> </span><span class="va">s1</span><span class="ot">)</span><span>  </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="va">s</span><span class="ot">,</span><span class="va">s</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="va">s0</span><span>
                     </span><span class="co">-- (a, s1)  = (s0, s0)</span><span>
                        </span><span class="dt">State</span><span> </span><span class="va">sb</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">i</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">_</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="va">a</span><span>
                     </span><span class="co">--       sb = (\_ -&gt; ((), s0+1))</span><span>
                    </span><span class="kw">in</span><span> </span><span class="va">sb</span><span> </span><span class="va">s1</span><span class="ot">)</span><span>
                     </span><span class="co">-- ((), s0+1)</span><span>
 </span><span class="op">==</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">s0</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">s0</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span>
 </span><span class="op">==</span><span> </span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">i</span><span>  </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span></code></pre></div>
<p>Finally, we have</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span>    </span><span class="va">exec</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">i</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="dv">0</span><span>
 </span><span class="op">==</span><span> </span><span class="va">snd</span><span> </span><span class="op">$</span><span> </span><span class="va">runState</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">i</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="dv">0</span><span>
 </span><span class="op">==</span><span> </span><span class="va">snd</span><span> </span><span class="op">$</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">i</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">i</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span> </span><span class="dv">0</span><span>
 </span><span class="op">==</span><span> </span><span class="va">snd</span><span> </span><span class="op">$</span><span> </span><span class="ot">(</span><span class="ot">(</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="dv">1</span><span class="ot">)</span><span>
 </span><span class="op">==</span><span> </span><span class="dv">1</span></code></pre></div>
<p>This is my favourite thing about Haskell: the fact that it is built on
abstractions that can be reasoned about in such a rigorous manner.</p>
<p>In fact, with some inspired renaming, <a href="http://www.haskellforall.com/2014/04/how-continuation-monad-works.html">you too could have invented the
continuation monad</a>.</p>

        </div>
        <div id="footer">
            <div class="rc-webring">
                <a href="https://webring.recurse.com"><img src="https://webring.recurse.com/icon.svg" /> RC Webring</a>
            </div>
            <div class="rc-scout">
                <script async defer src="https://www.recurse-scout.com/loader.js?t=5ac465e5d3396a7e491e42afac4c5c90"></script>
            </div>
        </div>
        <script data-goatcounter="//vaibhavsagar.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
        <script type="text/javascript" id="MathJax-script" async src="//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
        </script>
        <script>
        window.MathJax = {
            loader: {load: ['[tex]/color', '[tex]/cancel', '[tex]/textmacros']},
            tex: {packages: {'[+]': ['color', 'cancel', 'textmacros']}}
        };
        </script>
    </body>
</html>
