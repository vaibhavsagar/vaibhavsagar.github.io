<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Binary Trees To Hash Array Mapped Tries, Step by Step - Vaibhav Sagar</title>
        <link href="data:," rel="icon">
        <link rel="stylesheet" type="text/css" href="../../../../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../../../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../../../../">Vaibhav Sagar</a>
            </div>
            <div id="navigation">
                <a href="../../../../../about/">About</a>
                <a href="../../../../../talks/">Talks</a>
                <a href="../../../../../archive/">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Binary Trees To Hash Array Mapped Tries, Step by Step</h1>

            <div class="info">
    Posted on  7 October 2023
    
</div>
<div class="info">
    
        Tags: <a title="All pages tagged 'programming'." href="../../../../../blog/tags/programming/" rel="tag">programming</a>, <a title="All pages tagged 'haskell'." href="../../../../../blog/tags/haskell/" rel="tag">haskell</a>
    
</div>

<p>Hash Array Mapped Tries (HAMTs) are a persistent data structure used to implement hashmaps. They’re heavily used <a href="https://github.com/clojure/clojure/blob/2a058814e5fa3e8fb630ae507c3fa7dc865138c6/src/jvm/clojure/lang/PersistentHashMap.java">in Clojure</a> and used to be the backbone of Haskell’s <a href="https://hackage.haskell.org/package/aeson"><code>aeson</code></a> library until <a href="https://hackage.haskell.org/package/aeson-2.0.1.0/changelog">relatively recently</a>. I’ve <a href="../../../../../blog/2018/07/29/hamts-from-scratch/">written about HAMTs before</a> but wanted to try a different approach: starting with a binary tree (or something close to it) and then making a series of straightforward modifications until we end up with the implementation detailed there.</p>
<p>Let’s start with some language extensions and imports:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="pp">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span class="pp">{-# LANGUAGE TypeSynonymInstances #-}</span><span>
</span><span class="pp">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span class="pp">{-# LANGUAGE RankNTypes #-}</span><span>


</span><span class="kw">import</span><span> </span><span class="dt">Data.Bits</span><span>             </span><span class="ot">(</span><span class="dt">Bits</span><span> </span><span class="ot">(</span><span class="va">bit</span><span class="ot">,</span><span> </span><span class="va">complement</span><span class="ot">,</span><span> </span><span class="va">popCount</span><span class="ot">,</span><span> </span><span class="va">shiftR</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="op">.&amp;.</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="op">.|.</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">testBit</span><span class="ot">)</span><span class="ot">,</span><span>
                              </span><span class="dt">FiniteBits</span><span> </span><span class="ot">(</span><span class="va">finiteBitSize</span><span class="ot">)</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.ByteArray.Hash</span><span>   </span><span class="ot">(</span><span class="dt">FnvHash32</span><span> </span><span class="ot">(</span><span class="ot">..</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="va">fnv1Hash</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.ByteString.Char8</span><span> </span><span class="ot">(</span><span class="va">pack</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Char</span><span>             </span><span class="ot">(</span><span class="va">intToDigit</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Semigroup</span><span>        </span><span class="ot">(</span><span class="ot">(</span><span class="op">&lt;&gt;</span><span class="ot">)</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Vector</span><span>           </span><span class="ot">(</span><span class="dt">Vector</span><span class="ot">,</span><span> </span><span class="va">drop</span><span class="ot">,</span><span> </span><span class="va">singleton</span><span class="ot">,</span><span> </span><span class="va">take</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="op">!</span><span class="ot">)</span><span class="ot">,</span><span> </span><span class="ot">(</span><span class="op">//</span><span class="ot">)</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.Word</span><span>             </span><span class="ot">(</span><span class="dt">Word16</span><span class="ot">,</span><span> </span><span class="dt">Word32</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Numeric</span><span>               </span><span class="ot">(</span><span class="va">showIntAtBase</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Prelude</span><span>               </span><span class="kw">hiding</span><span> </span><span class="ot">(</span><span class="va">drop</span><span class="ot">,</span><span> </span><span class="va">lookup</span><span class="ot">,</span><span> </span><span class="va">take</span><span class="ot">,</span><span> </span><span class="va">replicate</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span>             </span><span class="dt">Prelude</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">System.TimeIt</span><span>         </span><span class="ot">(</span><span class="va">timeIt</span><span class="ot">)</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Text.Show.Pretty</span><span>      </span><span class="ot">(</span><span class="va">pPrint</span><span class="ot">)</span></code></pre></div>
<p>I think it’s useful to be able to visualise these structures, for which we need some more imports:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import</span><span> </span><span class="dt">IHaskell.Display.Graphviz</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.Trans.State.Strict</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.Trans.Writer.CPS</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Control.Monad.Trans.Class</span><span>
</span><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="dt">Data.Vector</span><span> </span><span class="kw">as</span><span> </span><span class="dt">Vector</span><span>
</span><span class="kw">import</span><span> </span><span class="dt">Data.List</span><span> </span><span class="ot">(</span><span class="va">intercalate</span><span class="ot">,</span><span> </span><span class="va">intersperse</span><span class="ot">,</span><span> </span><span class="va">foldl'</span><span class="ot">)</span></code></pre></div>
<p>I’m going to define some instances for pretty-printing hashes:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">newtype</span><span> </span><span class="dt">Binary</span><span> </span><span class="va">a</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Binary</span><span> </span><span class="va">a</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="ot">(</span><span class="dt">Enum</span><span class="ot">,</span><span> </span><span class="dt">Ord</span><span class="ot">,</span><span> </span><span class="dt">Real</span><span class="ot">,</span><span> </span><span class="dt">Integral</span><span class="ot">,</span><span> </span><span class="dt">Eq</span><span class="ot">,</span><span> </span><span class="dt">Num</span><span class="ot">,</span><span> </span><span class="dt">Bits</span><span class="ot">,</span><span> </span><span class="dt">FiniteBits</span><span class="ot">)</span><span>

</span><span class="kw">instance</span><span> </span><span class="ot">(</span><span class="dt">FiniteBits</span><span> </span><span class="va">a</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span> </span><span class="va">a</span><span class="ot">,</span><span> </span><span class="dt">Integral</span><span> </span><span class="va">a</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="dt">Show</span><span> </span><span class="ot">(</span><span class="dt">Binary</span><span> </span><span class="va">a</span><span class="ot">)</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">show</span><span> </span><span class="ot">(</span><span class="dt">Binary</span><span> </span><span class="va">n</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
        </span><span class="va">str</span><span> </span><span class="ot">=</span><span> </span><span class="va">showIntAtBase</span><span> </span><span class="dv">2</span><span> </span><span class="va">intToDigit</span><span> </span><span class="va">n</span><span> </span><span class="st">&quot;&quot;</span><span>
        </span><span class="va">size</span><span> </span><span class="ot">=</span><span> </span><span class="va">finiteBitSize</span><span> </span><span class="va">n</span><span>
        </span><span class="kw">in</span><span> </span><span class="va">Prelude.replicate</span><span> </span><span class="ot">(</span><span class="va">size</span><span> </span><span class="op">-</span><span> </span><span class="va">length</span><span> </span><span class="va">str</span><span class="ot">)</span><span> </span><span class="ch">'0'</span><span> </span><span class="op">&lt;&gt;</span><span> </span><span class="va">str</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span><span> </span><span class="dt">Hash</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Binary</span><span> </span><span class="dt">Word32</span><span>

</span><span class="kw">class</span><span> </span><span class="dt">Hashable</span><span> </span><span class="va">a</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">hash</span><span> </span><span class="ot">::</span><span> </span><span class="va">a</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash</span></code></pre></div>
<p>One can think of hashing as mapping values of some type to fixed-size values of another type, and in this case I’ve decided to hash <code>Int</code>s to themselves for demonstration purposes. I would strongly recommend against doing this in production, but when explaining how these trees are constructed it’s handy to be able to immediately tell what the hash of some <code>Int</code> will be.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span><span> </span><span class="dt">Hashable</span><span> </span><span class="dt">String</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">hash</span><span> </span><span class="va">s</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
        </span><span class="dt">FnvHash32</span><span> </span><span class="va">h</span><span> </span><span class="ot">=</span><span> </span><span class="va">fnv1Hash</span><span> </span><span class="ot">(</span><span class="va">pack</span><span> </span><span class="va">s</span><span class="ot">)</span><span>
        </span><span class="kw">in</span><span> </span><span class="dt">Binary</span><span> </span><span class="va">h</span><span>

</span><span class="kw">instance</span><span> </span><span class="dt">Hashable</span><span> </span><span class="dt">Int</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">hash</span><span> </span><span class="va">int</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Binary</span><span> </span><span class="ot">(</span><span class="va">fromIntegral</span><span> </span><span class="va">int</span><span class="ot">)</span></code></pre></div>
I’m also defining some helpers so that we can generate DOT representations and use <code>ihaskell-graphviz</code> to display each of the structures defined here:
<details>
<summary>
Graphviz helper functions
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">getFreshId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">State</span><span> </span><span class="dt">Int</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">getFreshId</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">currentId</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">get</span><span>
    </span><span class="va">put</span><span> </span><span class="ot">(</span><span class="va">currentId</span><span class="op">+</span><span class="dv">1</span><span class="ot">)</span><span>
    </span><span class="va">pure</span><span> </span><span class="va">currentId</span><span>

</span><span class="va">escape</span><span> </span><span class="ot">=</span><span> </span><span class="va">concatMap</span><span> </span><span class="va">escaper</span><span>
    </span><span class="kw">where</span><span>
        </span><span class="va">escaper</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Char</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">String</span><span>
        </span><span class="va">escaper</span><span> </span><span class="va">c</span><span> </span><span class="ot">=</span><span> </span><span class="kw">case</span><span> </span><span class="va">c</span><span> </span><span class="kw">of</span><span>
            </span><span class="ch">'&quot;'</span><span>  </span><span class="ot">-&gt;</span><span> </span><span class="st">&quot;\\\&quot;&quot;</span><span>
            </span><span class="ch">'\\'</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="st">&quot;\\\\&quot;</span><span>
            </span><span class="ot">_</span><span>    </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="va">c</span><span class="ot">]</span><span>

</span><span class="va">makeDotLines</span><span> </span><span class="ot">::</span><span> </span><span class="ot">[</span><span class="dt">String</span><span class="ot">]</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">String</span><span>
</span><span class="va">makeDotLines</span><span> </span><span class="ot">=</span><span> </span><span class="va">concatMap</span><span> </span><span class="ot">(</span><span class="op">++</span><span> </span><span class="st">&quot;;\n&quot;</span><span class="ot">)</span><span>

</span><span class="va">preamble</span><span> </span><span class="ot">=</span><span> </span><span class="va">unlines</span><span>
    </span><span class="ot">[</span><span> </span><span class="st">&quot;digraph {&quot;</span><span>
    </span><span class="ot">,</span><span> </span><span class="st">&quot;node [shape=record];&quot;</span><span>
    </span><span class="ot">,</span><span> </span><span class="st">&quot;splines=false;&quot;</span><span>
    </span><span class="ot">,</span><span> </span><span class="st">&quot;ranksep=2;&quot;</span><span>
    </span><span class="ot">,</span><span> </span><span class="st">&quot;nodesep=1;&quot;</span><span>
    </span><span class="ot">]</span><span>
</span><span class="va">postamble</span><span> </span><span class="ot">=</span><span> </span><span class="va">unlines</span><span> </span><span class="ot">[</span><span class="st">&quot;}&quot;</span><span class="ot">]</span><span>

</span><span class="va">makeDot</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">String</span><span>
</span><span class="va">makeDot</span><span> </span><span class="va">str</span><span> </span><span class="ot">=</span><span> </span><span class="va">preamble</span><span> </span><span class="op">++</span><span> </span><span class="va">str</span><span> </span><span class="op">++</span><span> </span><span class="va">postamble</span></code></pre></div>
</details>
<p>Let’s define a typeclass to abstract over the details of our data structures. For our purposes we only care that for some <code>Mapping</code>, we can have an empty value, a way to <code>insert</code> key-value pairs, and a way to <code>lookup</code> a particular key:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">class</span><span> </span><span class="dt">Mapping</span><span> </span><span class="va">mapping</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">empty</span><span> </span><span class="ot">::</span><span> </span><span class="kw">forall</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="op">.</span><span> </span><span class="va">mapping</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span>
    </span><span class="va">lookup</span><span> </span><span class="ot">::</span><span> </span><span class="kw">forall</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="op">.</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">k</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">k</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">mapping</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="va">v</span><span>
    </span><span class="va">insert</span><span> </span><span class="ot">::</span><span> </span><span class="kw">forall</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="op">.</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">k</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">k</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">mapping</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">mapping</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span></code></pre></div>
<p>As a way of exercising these <code>Mappings</code>, I’ve chosen to implement a simple memoised <code>fib'</code> function that stores intermediate results:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">fib'</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Mapping</span><span> </span><span class="va">m</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">m</span><span> </span><span class="dt">Int</span><span> </span><span class="dt">Integer</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="dt">Integer</span><span class="ot">,</span><span> </span><span class="va">m</span><span> </span><span class="dt">Int</span><span> </span><span class="dt">Integer</span><span class="ot">)</span><span>
</span><span class="va">fib'</span><span> </span><span class="va">table</span><span> </span><span class="dv">0</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="dv">1</span><span class="ot">,</span><span> </span><span class="va">insert</span><span> </span><span class="dv">0</span><span> </span><span class="dv">1</span><span> </span><span class="va">table</span><span class="ot">)</span><span>
</span><span class="va">fib'</span><span> </span><span class="va">table</span><span> </span><span class="dv">1</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="dv">1</span><span class="ot">,</span><span> </span><span class="va">insert</span><span> </span><span class="dv">1</span><span> </span><span class="dv">1</span><span> </span><span class="va">table</span><span class="ot">)</span><span>
</span><span class="va">fib'</span><span> </span><span class="va">table</span><span> </span><span class="va">n</span><span> </span><span class="ot">=</span><span> </span><span class="kw">case</span><span> </span><span class="va">lookup</span><span> </span><span class="va">n</span><span> </span><span class="va">table</span><span> </span><span class="kw">of</span><span>
    </span><span class="dt">Just</span><span> </span><span class="va">i</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">(</span><span class="va">i</span><span class="ot">,</span><span> </span><span class="va">table</span><span class="ot">)</span><span>
    </span><span class="dt">Nothing</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="kw">let</span><span>
        </span><span class="ot">(</span><span class="va">i1</span><span class="ot">,</span><span> </span><span class="va">table'</span><span class="ot">)</span><span>  </span><span class="ot">=</span><span> </span><span class="va">fib'</span><span> </span><span class="va">table</span><span>  </span><span class="ot">(</span><span class="va">n</span><span class="op">-</span><span class="dv">1</span><span class="ot">)</span><span>
        </span><span class="ot">(</span><span class="va">i2</span><span class="ot">,</span><span> </span><span class="va">table''</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="va">fib'</span><span> </span><span class="va">table'</span><span> </span><span class="ot">(</span><span class="va">n</span><span class="op">-</span><span class="dv">2</span><span class="ot">)</span><span>
        </span><span class="kw">in</span><span> </span><span class="ot">(</span><span class="va">i1</span><span> </span><span class="op">+</span><span> </span><span class="va">i2</span><span class="ot">,</span><span> </span><span class="va">insert</span><span> </span><span class="va">n</span><span> </span><span class="ot">(</span><span class="va">i1</span><span> </span><span class="op">+</span><span> </span><span class="va">i2</span><span class="ot">)</span><span> </span><span class="va">table''</span><span class="ot">)</span></code></pre></div>
<p>After that housekeeping, we can begin with our first data structure:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">=</span><span> </span><span class="dt">HashBinaryMappedTrieNone</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">HashBinaryMappedTrieLeaf</span><span> </span><span class="dt">Hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">HashBinaryMappedTrieNode</span><span>
        </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span class="ot">)</span><span>
        </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span class="ot">)</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="ot">(</span><span class="dt">Eq</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span class="ot">)</span></code></pre></div>
<p>This is a binary tree with key-value pairs stored at the leaves. It is also a bitwise <a href="https://en.wikipedia.org/wiki/Trie">trie</a> because I plan to insert into it as follows:</p>
<ol type="1">
<li>First, hash the key.</li>
<li>If we find a <code>HashBinaryMappedTrieNone</code>, replace it with a <code>HashBinaryMappedTrieLeaf</code> and our hash, key, and value and stop. If we find a <code>HashBinaryMappedTrieLeaf</code> and it’s not the key-value pair we are inserting, replace it with a <code>HashBinaryMappedTrieNode</code> and insert both the old value and the new value into this node.</li>
<li>Branch on the rightmost bit of the hash. If it is a <code>0</code>, go left, otherwise go right.</li>
<li>Remove the rightmost bit from the hash for the purposes of considering whether we go left or right.</li>
<li>Repeat steps 2-5.</li>
</ol>
<p>I’ve chosen to call it a Hash Binary Mapped Trie, since it is a binary (bitwise) trie storing a mapping based on hashes.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">insertHashBinaryMappedTrie</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHashBinaryMappedTrieHelper</span><span> </span><span class="dv">0</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="va">key</span><span>

</span><span class="va">insertHashBinaryMappedTrieHelper</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="dt">HashBinaryMappedTrieNone</span><span> </span><span class="ot">=</span><span>
    </span><span class="dt">HashBinaryMappedTrieLeaf</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrieLeaf</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span class="ot">)</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">hash</span><span> </span><span class="op">==</span><span> </span><span class="va">leafHash</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashBinaryMappedTrieLeaf</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">otherwise</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
        </span><span class="va">emptyNode</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashBinaryMappedTrieNode</span><span> </span><span class="dt">HashBinaryMappedTrieNone</span><span> </span><span class="dt">HashBinaryMappedTrieNone</span><span>
        </span><span class="va">leafInsertedNode</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span> </span><span class="va">emptyNode</span><span>
        </span><span class="kw">in</span><span> </span><span class="va">insertHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="va">leafInsertedNode</span><span>
</span><span class="va">insertHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrieNode</span><span> </span><span class="va">left</span><span> </span><span class="va">right</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">goRight</span><span> </span><span class="ot">=</span><span> </span><span class="va">testBit</span><span> </span><span class="va">hash</span><span> </span><span class="va">depth</span><span>
    </span><span class="va">depth'</span><span> </span><span class="ot">=</span><span> </span><span class="va">depth</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">goRight</span><span>
        </span><span class="kw">then</span><span> </span><span class="dt">HashBinaryMappedTrieNode</span><span> </span><span class="va">left</span><span> </span><span class="ot">(</span><span class="va">insertHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="va">right</span><span class="ot">)</span><span>
        </span><span class="kw">else</span><span> </span><span class="dt">HashBinaryMappedTrieNode</span><span> </span><span class="ot">(</span><span class="va">insertHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="va">left</span><span class="ot">)</span><span> </span><span class="va">right</span></code></pre></div>
<p>To look up a particular key, the process is similar:</p>
<ol type="1">
<li>Hash the key.</li>
<li>If we find a <code>HashBinaryMappedTrieNone</code>, return <code>Nothing</code>. If we find a <code>HashBinaryMappedTrieLeaf</code>, check that the hashes match (this ignores the possibility of hash collisions) and if so return the pair otherwise return <code>Nothing</code>.</li>
<li>Branch on the rightmost bit of the hash, going left if it is <code>0</code> and right otherwise.</li>
<li>Remove the rightmost bit from the hash for the purposes of considering whether to go left or right.</li>
<li>Repeat steps 2-5.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">lookupHashBinaryMappedTrie</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="va">value</span><span>
</span><span class="va">lookupHashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="ot">=</span><span> </span><span class="va">lookupHashBinaryMappedTrieHelper</span><span> </span><span class="dv">0</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="va">key</span><span>

</span><span class="va">lookupHashBinaryMappedTrieHelper</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="va">value</span><span>
</span><span class="va">lookupHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="dt">HashBinaryMappedTrieNone</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Nothing</span><span>
</span><span class="va">lookupHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrieLeaf</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span class="ot">)</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">hash</span><span> </span><span class="op">==</span><span> </span><span class="va">leafHash</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Just</span><span> </span><span class="va">leafValue</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">otherwise</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Nothing</span><span>
</span><span class="va">lookupHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrieNode</span><span> </span><span class="va">left</span><span> </span><span class="va">right</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">goRight</span><span> </span><span class="ot">=</span><span> </span><span class="va">testBit</span><span> </span><span class="va">hash</span><span> </span><span class="va">depth</span><span>
    </span><span class="va">depth'</span><span> </span><span class="ot">=</span><span> </span><span class="va">depth</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">goRight</span><span>
        </span><span class="kw">then</span><span> </span><span class="va">lookupHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">right</span><span>
        </span><span class="kw">else</span><span> </span><span class="va">lookupHashBinaryMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">left</span></code></pre></div>
<p>An empty <code>HashBinaryMappedTrie</code> is <code>HashBinaryMappedTrieNone</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">emptyHashBinaryMappedTrie</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashBinaryMappedTrieNone</span></code></pre></div>
<p>We can easily implement an instance of <code>Mapping</code> for <code>HashBinaryMappedTrie</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span><span> </span><span class="dt">Mapping</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">empty</span><span> </span><span class="ot">=</span><span> </span><span class="va">emptyHashBinaryMappedTrie</span><span>
    </span><span class="va">insert</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHashBinaryMappedTrie</span><span>
    </span><span class="va">lookup</span><span> </span><span class="ot">=</span><span> </span><span class="va">lookupHashBinaryMappedTrie</span></code></pre></div>
<p>Now we can build a tree to look at using <code>fib'</code>, but before we can visualise it we need to convert it into DOT files for <code>ihaskell-graphviz</code>:</p>
<details>
<summary>
Graphviz helper functions for HashBinaryMappedTrie
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span><span> </span><span class="dt">HashBinaryMappedTrieGraphvizNode</span><span>
    </span><span class="ot">=</span><span> </span><span class="dt">HashBinaryMappedTrieGraphvizNode</span><span>
        </span><span class="ot">{</span><span> </span><span class="va">hashBinaryMappedTrieGraphvizNodeId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashBinaryMappedTrieGraphvizLeftChildId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashBinaryMappedTrieGraphvizRightChildId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">}</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">HashBinaryMappedTrieGraphvizLeafNode</span><span>
        </span><span class="ot">{</span><span> </span><span class="va">hashBinaryMappedTrieGraphvizLeafNodeId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashBinaryMappedTriGraphvizeLeafHash</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashBinaryMappedTrieGraphvizLeafKey</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashBinaryMappedTrieGraphvizLeafNodeValue</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">}</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="ot">(</span><span class="dt">Eq</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span class="ot">)</span><span>

</span><span class="va">numberHBMT</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Show</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">WriterT</span><span> </span><span class="ot">[</span><span class="dt">HashBinaryMappedTrieGraphvizNode</span><span class="ot">]</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">numberHBMT</span><span> </span><span class="dt">HashBinaryMappedTrieNone</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">tell</span><span> </span><span class="va">mempty</span><span>
    </span><span class="va">pure</span><span> </span><span class="dv">0</span><span>
</span><span class="va">numberHBMT</span><span> </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrieLeaf</span><span> </span><span class="va">h</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">lift</span><span> </span><span class="va">getFreshId</span><span>
    </span><span class="va">tell</span><span> </span><span class="ot">[</span><span class="dt">HashBinaryMappedTrieGraphvizLeafNode</span><span> </span><span class="va">i</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">h</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">k</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">]</span><span>
    </span><span class="va">pure</span><span> </span><span class="va">i</span><span>
</span><span class="va">numberHBMT</span><span> </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrieNode</span><span> </span><span class="va">l</span><span> </span><span class="va">r</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">lift</span><span> </span><span class="va">getFreshId</span><span>
    </span><span class="va">leftChildId</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">numberHBMT</span><span> </span><span class="va">l</span><span>
    </span><span class="va">rightChildId</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">numberHBMT</span><span> </span><span class="va">r</span><span>
    </span><span class="va">tell</span><span> </span><span class="ot">[</span><span class="dt">HashBinaryMappedTrieGraphvizNode</span><span> </span><span class="va">i</span><span> </span><span class="va">leftChildId</span><span> </span><span class="va">rightChildId</span><span class="ot">]</span><span>
    </span><span class="va">pure</span><span> </span><span class="va">i</span><span>

</span><span class="va">nodeLinesHBMT</span><span> </span><span class="ot">::</span><span> </span><span class="dt">HashBinaryMappedTrieGraphvizNode</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">String</span><span class="ot">]</span><span>
</span><span class="va">nodeLinesHBMT</span><span> </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrieGraphvizLeafNode</span><span> </span><span class="va">i</span><span> </span><span class="va">h</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="kw">label</span><span> </span><span class="ot">=</span><span> </span><span class="va">intercalate</span><span> </span><span class="st">&quot;|&quot;</span><span> </span><span class="ot">[</span><span class="va">h</span><span class="ot">,</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">]</span><span>
    </span><span class="va">line</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span class="ot">)</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;[label=\&quot;&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">escape</span><span> </span><span class="kw">label</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;\&quot;]&quot;</span><span>
    </span><span class="kw">in</span><span> </span><span class="ot">[</span><span class="va">line</span><span class="ot">]</span><span>
</span><span class="va">nodeLinesHBMT</span><span> </span><span class="ot">(</span><span class="dt">HashBinaryMappedTrieGraphvizNode</span><span> </span><span class="va">i</span><span> </span><span class="va">l</span><span> </span><span class="va">r</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">edges</span><span> </span><span class="ot">=</span><span> </span><span class="va">map</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="va">index</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; -&gt; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">index</span><span class="ot">)</span><span> </span><span class="ot">[</span><span class="va">l</span><span class="ot">,</span><span> </span><span class="va">r</span><span class="ot">]</span><span>
    </span><span class="kw">label</span><span> </span><span class="ot">=</span><span> </span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;[label=\&quot;\&quot;]&quot;</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">label</span><span class="ot">:</span><span class="va">edges</span><span>

</span><span class="va">dotFromHBMT</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Show</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="dt">HashBinaryMappedTrie</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">String</span><span>
</span><span class="va">dotFromHBMT</span><span> </span><span class="ot">=</span><span> </span><span class="va">makeDot</span><span> </span><span class="op">.</span><span> </span><span class="va">makeDotLines</span><span class="op">.</span><span> </span><span class="va">concatMap</span><span> </span><span class="va">nodeLinesHBMT</span><span> </span><span class="op">.</span><span> </span><span class="va">flip</span><span> </span><span class="va">evalState</span><span> </span><span class="dv">0</span><span> </span><span class="op">.</span><span> </span><span class="va">execWriterT</span><span> </span><span class="op">.</span><span> </span><span class="va">numberHBMT</span></code></pre></div>
</details>
Here’s a visualisation of the tree created by <code>fib' 8</code>:
<details>
<summary>
Hash Binary Mapped Trie
</summary>
<div style="overflow: scroll">
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">dot</span><span> </span><span class="op">$</span><span> </span><span class="va">dotFromHBMT</span><span> </span><span class="op">$</span><span> </span><span class="va">snd</span><span> </span><span class="op">$</span><span> </span><span class="va">fib'</span><span> </span><span class="va">emptyHashBinaryMappedTrie</span><span> </span><span class="dv">8</span></code></pre></div>
<svg width="3454pt" height="769pt" viewBox="0.00 0.00 3453.50 769.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 765)">
<polygon fill="white" stroke="none" points="-4,4 -4,-765 3449.5,-765 3449.5,4 -4,4"></polygon>
<!-- n4 -->
<g id="node1" class="node">
<title>
n4
</title>
<polygon fill="none" stroke="black" points="0,-0.5 0,-36.5 357,-36.5 357,-0.5 0,-0.5"></polygon>
<text text-anchor="middle" x="152.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000000</text>
<polyline fill="none" stroke="black" points="305,-0.5 305,-36.5"></polyline>
<text text-anchor="middle" x="318" y="-14.8" font-family="Times,serif" font-size="14.00">0</text>
<polyline fill="none" stroke="black" points="331,-0.5 331,-36.5"></polyline>
<text text-anchor="middle" x="344" y="-14.8" font-family="Times,serif" font-size="14.00">1</text>
</g>
<!-- n5 -->
<g id="node2" class="node">
<title>
n5
</title>
<polygon fill="none" stroke="black" points="429.5,-0.5 429.5,-36.5 795.5,-36.5 795.5,-0.5 429.5,-0.5"></polygon>
<text text-anchor="middle" x="582" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000001000</text>
<polyline fill="none" stroke="black" points="734.5,-0.5 734.5,-36.5"></polyline>
<text text-anchor="middle" x="747.5" y="-14.8" font-family="Times,serif" font-size="14.00">8</text>
<polyline fill="none" stroke="black" points="760.5,-0.5 760.5,-36.5"></polyline>
<text text-anchor="middle" x="778" y="-14.8" font-family="Times,serif" font-size="14.00">34</text>
</g>
<!-- n3 -->
<g id="node3" class="node">
<title>
n3
</title>
<polygon fill="none" stroke="black" points="368.5,-181.5 368.5,-217.5 422.5,-217.5 422.5,-181.5 368.5,-181.5"></polygon>
<text text-anchor="middle" x="395.5" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n3&#45;&gt;n4 -->
<g id="edge1" class="edge">
<title>
n3-&gt;n4
</title>
<path fill="none" stroke="black" d="M375.09,-181.66C336.39,-149.74 252.27,-80.35 207.65,-43.55"></path>
<polygon fill="black" stroke="black" points="210.13,-41.05 200.19,-37.39 205.67,-46.45 210.13,-41.05"></polygon>
</g>
<!-- n3&#45;&gt;n5 -->
<g id="edge2" class="edge">
<title>
n3-&gt;n5
</title>
<path fill="none" stroke="black" d="M415.91,-181.66C454.61,-149.74 538.73,-80.35 583.35,-43.55"></path>
<polygon fill="black" stroke="black" points="585.33,-46.45 590.81,-37.39 580.87,-41.05 585.33,-46.45"></polygon>
</g>
<!-- n6 -->
<g id="node4" class="node">
<title>
n6
</title>
<polygon fill="none" stroke="black" points="495,-181.5 495,-217.5 852,-217.5 852,-181.5 495,-181.5"></polygon>
<text text-anchor="middle" x="647.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000100</text>
<polyline fill="none" stroke="black" points="800,-181.5 800,-217.5"></polyline>
<text text-anchor="middle" x="813" y="-195.8" font-family="Times,serif" font-size="14.00">4</text>
<polyline fill="none" stroke="black" points="826,-181.5 826,-217.5"></polyline>
<text text-anchor="middle" x="839" y="-195.8" font-family="Times,serif" font-size="14.00">5</text>
</g>
<!-- n2 -->
<g id="node5" class="node">
<title>
n2
</title>
<polygon fill="none" stroke="black" points="646.5,-362.5 646.5,-398.5 700.5,-398.5 700.5,-362.5 646.5,-362.5"></polygon>
<text text-anchor="middle" x="673.5" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n2&#45;&gt;n3 -->
<g id="edge3" class="edge">
<title>
n2-&gt;n3
</title>
<path fill="none" stroke="black" d="M647.35,-362.66C597.36,-330.48 488.2,-260.19 431.42,-223.63"></path>
<polygon fill="black" stroke="black" points="433.36,-220.72 423.06,-218.24 429.57,-226.6 433.36,-220.72"></polygon>
</g>
<!-- n2&#45;&gt;n6 -->
<g id="edge4" class="edge">
<title>
n2-&gt;n6
</title>
<path fill="none" stroke="black" d="M673.5,-362.66C673.5,-331.88 673.5,-266.23 673.5,-228.58"></path>
<polygon fill="black" stroke="black" points="677,-228.94 673.5,-218.94 670,-228.94 677,-228.94"></polygon>
</g>
<!-- n8 -->
<g id="node6" class="node">
<title>
n8
</title>
<polygon fill="none" stroke="black" points="924,-181.5 924,-217.5 1281,-217.5 1281,-181.5 924,-181.5"></polygon>
<text text-anchor="middle" x="1076.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000010</text>
<polyline fill="none" stroke="black" points="1229,-181.5 1229,-217.5"></polyline>
<text text-anchor="middle" x="1242" y="-195.8" font-family="Times,serif" font-size="14.00">2</text>
<polyline fill="none" stroke="black" points="1255,-181.5 1255,-217.5"></polyline>
<text text-anchor="middle" x="1268" y="-195.8" font-family="Times,serif" font-size="14.00">2</text>
</g>
<!-- n9 -->
<g id="node7" class="node">
<title>
n9
</title>
<polygon fill="none" stroke="black" points="1353.5,-181.5 1353.5,-217.5 1719.5,-217.5 1719.5,-181.5 1353.5,-181.5"></polygon>
<text text-anchor="middle" x="1506" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000110</text>
<polyline fill="none" stroke="black" points="1658.5,-181.5 1658.5,-217.5"></polyline>
<text text-anchor="middle" x="1671.5" y="-195.8" font-family="Times,serif" font-size="14.00">6</text>
<polyline fill="none" stroke="black" points="1684.5,-181.5 1684.5,-217.5"></polyline>
<text text-anchor="middle" x="1702" y="-195.8" font-family="Times,serif" font-size="14.00">13</text>
</g>
<!-- n7 -->
<g id="node8" class="node">
<title>
n7
</title>
<polygon fill="none" stroke="black" points="1292.5,-362.5 1292.5,-398.5 1346.5,-398.5 1346.5,-362.5 1292.5,-362.5"></polygon>
<text text-anchor="middle" x="1319.5" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n7&#45;&gt;n8 -->
<g id="edge5" class="edge">
<title>
n7-&gt;n8
</title>
<path fill="none" stroke="black" d="M1299.09,-362.66C1260.39,-330.74 1176.27,-261.35 1131.65,-224.55"></path>
<polygon fill="black" stroke="black" points="1134.13,-222.05 1124.19,-218.39 1129.67,-227.45 1134.13,-222.05"></polygon>
</g>
<!-- n7&#45;&gt;n9 -->
<g id="edge6" class="edge">
<title>
n7-&gt;n9
</title>
<path fill="none" stroke="black" d="M1339.91,-362.66C1378.61,-330.74 1462.73,-261.35 1507.35,-224.55"></path>
<polygon fill="black" stroke="black" points="1509.33,-227.45 1514.81,-218.39 1504.87,-222.05 1509.33,-227.45"></polygon>
</g>
<!-- n1 -->
<g id="node9" class="node">
<title>
n1
</title>
<polygon fill="none" stroke="black" points="1292.5,-543.5 1292.5,-579.5 1346.5,-579.5 1346.5,-543.5 1292.5,-543.5"></polygon>
<text text-anchor="middle" x="1319.5" y="-557.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n1&#45;&gt;n2 -->
<g id="edge7" class="edge">
<title>
n1-&gt;n2
</title>
<path fill="none" stroke="black" d="M1292.56,-553.04C1190.77,-524.83 829.31,-424.67 711.17,-391.94"></path>
<polygon fill="black" stroke="black" points="712.22,-388.6 701.65,-389.3 710.35,-395.34 712.22,-388.6"></polygon>
</g>
<!-- n1&#45;&gt;n7 -->
<g id="edge8" class="edge">
<title>
n1-&gt;n7
</title>
<path fill="none" stroke="black" d="M1319.5,-543.66C1319.5,-512.88 1319.5,-447.23 1319.5,-409.58"></path>
<polygon fill="black" stroke="black" points="1323,-409.94 1319.5,-399.94 1316,-409.94 1323,-409.94"></polygon>
</g>
<!-- n12 -->
<g id="node10" class="node">
<title>
n12
</title>
<polygon fill="none" stroke="black" points="1792,-181.5 1792,-217.5 2149,-217.5 2149,-181.5 1792,-181.5"></polygon>
<text text-anchor="middle" x="1944.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000001</text>
<polyline fill="none" stroke="black" points="2097,-181.5 2097,-217.5"></polyline>
<text text-anchor="middle" x="2110" y="-195.8" font-family="Times,serif" font-size="14.00">1</text>
<polyline fill="none" stroke="black" points="2123,-181.5 2123,-217.5"></polyline>
<text text-anchor="middle" x="2136" y="-195.8" font-family="Times,serif" font-size="14.00">1</text>
</g>
<!-- n13 -->
<g id="node11" class="node">
<title>
n13
</title>
<polygon fill="none" stroke="black" points="2221,-181.5 2221,-217.5 2578,-217.5 2578,-181.5 2221,-181.5"></polygon>
<text text-anchor="middle" x="2373.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000101</text>
<polyline fill="none" stroke="black" points="2526,-181.5 2526,-217.5"></polyline>
<text text-anchor="middle" x="2539" y="-195.8" font-family="Times,serif" font-size="14.00">5</text>
<polyline fill="none" stroke="black" points="2552,-181.5 2552,-217.5"></polyline>
<text text-anchor="middle" x="2565" y="-195.8" font-family="Times,serif" font-size="14.00">8</text>
</g>
<!-- n11 -->
<g id="node12" class="node">
<title>
n11
</title>
<polygon fill="none" stroke="black" points="2157.5,-362.5 2157.5,-398.5 2211.5,-398.5 2211.5,-362.5 2157.5,-362.5"></polygon>
<text text-anchor="middle" x="2184.5" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n11&#45;&gt;n12 -->
<g id="edge9" class="edge">
<title>
n11-&gt;n12
</title>
<path fill="none" stroke="black" d="M2164.37,-362.66C2126.29,-330.81 2043.6,-261.64 1999.52,-224.78"></path>
<polygon fill="black" stroke="black" points="2001.81,-222.13 1991.9,-218.4 1997.32,-227.5 2001.81,-222.13"></polygon>
</g>
<!-- n11&#45;&gt;n13 -->
<g id="edge10" class="edge">
<title>
n11-&gt;n13
</title>
<path fill="none" stroke="black" d="M2204.73,-362.66C2242.98,-330.81 2326.06,-261.64 2370.34,-224.78"></path>
<polygon fill="black" stroke="black" points="2372.56,-227.48 2378.01,-218.39 2368.08,-222.1 2372.56,-227.48"></polygon>
</g>
<!-- n15 -->
<g id="node13" class="node">
<title>
n15
</title>
<polygon fill="none" stroke="black" points="2650,-181.5 2650,-217.5 3007,-217.5 3007,-181.5 2650,-181.5"></polygon>
<text text-anchor="middle" x="2802.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000011</text>
<polyline fill="none" stroke="black" points="2955,-181.5 2955,-217.5"></polyline>
<text text-anchor="middle" x="2968" y="-195.8" font-family="Times,serif" font-size="14.00">3</text>
<polyline fill="none" stroke="black" points="2981,-181.5 2981,-217.5"></polyline>
<text text-anchor="middle" x="2994" y="-195.8" font-family="Times,serif" font-size="14.00">3</text>
</g>
<!-- n16 -->
<g id="node14" class="node">
<title>
n16
</title>
<polygon fill="none" stroke="black" points="3079.5,-181.5 3079.5,-217.5 3445.5,-217.5 3445.5,-181.5 3079.5,-181.5"></polygon>
<text text-anchor="middle" x="3232" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000111</text>
<polyline fill="none" stroke="black" points="3384.5,-181.5 3384.5,-217.5"></polyline>
<text text-anchor="middle" x="3397.5" y="-195.8" font-family="Times,serif" font-size="14.00">7</text>
<polyline fill="none" stroke="black" points="3410.5,-181.5 3410.5,-217.5"></polyline>
<text text-anchor="middle" x="3428" y="-195.8" font-family="Times,serif" font-size="14.00">21</text>
</g>
<!-- n14 -->
<g id="node15" class="node">
<title>
n14
</title>
<polygon fill="none" stroke="black" points="2801.5,-362.5 2801.5,-398.5 2855.5,-398.5 2855.5,-362.5 2801.5,-362.5"></polygon>
<text text-anchor="middle" x="2828.5" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n14&#45;&gt;n15 -->
<g id="edge11" class="edge">
<title>
n14-&gt;n15
</title>
<path fill="none" stroke="black" d="M2828.5,-362.66C2828.5,-331.88 2828.5,-266.23 2828.5,-228.58"></path>
<polygon fill="black" stroke="black" points="2832,-228.94 2828.5,-218.94 2825,-228.94 2832,-228.94"></polygon>
</g>
<!-- n14&#45;&gt;n16 -->
<g id="edge12" class="edge">
<title>
n14-&gt;n16
</title>
<path fill="none" stroke="black" d="M2855.32,-368.44C2925.98,-339.29 3118.19,-260.02 3211,-221.74"></path>
<polygon fill="black" stroke="black" points="3212.23,-225.02 3220.14,-217.97 3209.56,-218.55 3212.23,-225.02"></polygon>
</g>
<!-- n10 -->
<g id="node16" class="node">
<title>
n10
</title>
<polygon fill="none" stroke="black" points="2157.5,-543.5 2157.5,-579.5 2211.5,-579.5 2211.5,-543.5 2157.5,-543.5"></polygon>
<text text-anchor="middle" x="2184.5" y="-557.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n10&#45;&gt;n11 -->
<g id="edge13" class="edge">
<title>
n10-&gt;n11
</title>
<path fill="none" stroke="black" d="M2184.5,-543.66C2184.5,-512.88 2184.5,-447.23 2184.5,-409.58"></path>
<polygon fill="black" stroke="black" points="2188,-409.94 2184.5,-399.94 2181,-409.94 2188,-409.94"></polygon>
</g>
<!-- n10&#45;&gt;n14 -->
<g id="edge14" class="edge">
<title>
n10-&gt;n14
</title>
<path fill="none" stroke="black" d="M2211.35,-553.04C2312.72,-524.86 2672.35,-424.9 2790.55,-392.05"></path>
<polygon fill="black" stroke="black" points="2791.38,-395.45 2800.08,-389.4 2789.5,-388.71 2791.38,-395.45"></polygon>
</g>
<!-- n0 -->
<g id="node17" class="node">
<title>
n0
</title>
<polygon fill="none" stroke="black" points="1726.5,-724.5 1726.5,-760.5 1780.5,-760.5 1780.5,-724.5 1726.5,-724.5"></polygon>
<text text-anchor="middle" x="1753.5" y="-738.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n0&#45;&gt;n1 -->
<g id="edge15" class="edge">
<title>
n0-&gt;n1
</title>
<path fill="none" stroke="black" d="M1726.68,-730.44C1652.23,-699.73 1442.87,-613.38 1356.98,-577.96"></path>
<polygon fill="black" stroke="black" points="1358.4,-574.76 1347.82,-574.18 1355.73,-581.23 1358.4,-574.76"></polygon>
</g>
<!-- n0&#45;&gt;n10 -->
<g id="edge16" class="edge">
<title>
n0-&gt;n10
</title>
<path fill="none" stroke="black" d="M1780.46,-730.3C1854.61,-699.51 2061.75,-613.48 2147.05,-578.05"></path>
<polygon fill="black" stroke="black" points="2148.26,-581.34 2156.15,-574.27 2145.57,-574.88 2148.26,-581.34"></polygon>
</g>
</g>
</svg>
</div>
</details>
<p>As we can see, this data structure does actually work, and if that’s all we require, we could probably stop here. However, the most obvious issue is that the low branching factor of 2 means that our trees get too deep too quickly and that negatively impacts the time and space complexity of most operations. We will address this shortly, but first I would like to take a slight detour and do some <a href="https://martinfowler.com/articles/preparatory-refactoring-example.html">prefactoring</a> to make this possible: instead of having child nodes point directly to a parent node, let’s store a 2-element array in the parent node and have the children live there.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">=</span><span> </span><span class="dt">Hash2ArrayMappedTrieNone</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">Hash2ArrayMappedTrieLeaf</span><span> </span><span class="dt">Hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">Hash2ArrayMappedTrieNode</span><span> </span><span class="ot">(</span><span class="dt">Vector</span><span> </span><span class="ot">(</span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span class="ot">)</span><span class="ot">)</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="ot">(</span><span class="dt">Eq</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span class="ot">)</span></code></pre></div>
<p>We can reuse most of our existing code with only minor changes to account for the existence of the array, which will always have two elements.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">insertHash2ArrayMappedTrie</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHash2ArrayMappedTrieHelper</span><span> </span><span class="dv">0</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="va">key</span><span>

</span><span class="va">insertHash2ArrayMappedTrieHelper</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="dt">Hash2ArrayMappedTrieNone</span><span> </span><span class="ot">=</span><span>
    </span><span class="dt">Hash2ArrayMappedTrieLeaf</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="dt">Hash2ArrayMappedTrieLeaf</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span class="ot">)</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">hash</span><span> </span><span class="op">==</span><span> </span><span class="va">leafHash</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Hash2ArrayMappedTrieLeaf</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">otherwise</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
        </span><span class="va">emptyNode</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Hash2ArrayMappedTrieNode</span><span> </span><span class="ot">(</span><span class="va">replicate</span><span> </span><span class="dv">2</span><span> </span><span class="dt">Hash2ArrayMappedTrieNone</span><span class="ot">)</span><span>
        </span><span class="va">leafInsertedNode</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span> </span><span class="va">emptyNode</span><span>
        </span><span class="kw">in</span><span> </span><span class="va">insertHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="va">leafInsertedNode</span><span>
</span><span class="va">insertHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="dt">Hash2ArrayMappedTrieNode</span><span> </span><span class="va">children</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">goRight</span><span> </span><span class="ot">=</span><span> </span><span class="va">testBit</span><span> </span><span class="va">hash</span><span> </span><span class="va">depth</span><span>
    </span><span class="va">depth'</span><span> </span><span class="ot">=</span><span> </span><span class="va">depth</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">goRight</span><span>
        </span><span class="kw">then</span><span> </span><span class="dt">Hash2ArrayMappedTrieNode</span><span> </span><span class="op">$</span><span> </span><span class="va">children</span><span> </span><span class="op">//</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="dv">1</span><span class="ot">,</span><span> </span><span class="va">insertHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="va">children</span><span> </span><span class="op">!</span><span> </span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span class="ot">]</span><span>
        </span><span class="kw">else</span><span> </span><span class="dt">Hash2ArrayMappedTrieNode</span><span> </span><span class="op">$</span><span> </span><span class="va">children</span><span> </span><span class="op">//</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span><span> </span><span class="va">insertHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="va">children</span><span> </span><span class="op">!</span><span> </span><span class="dv">0</span><span class="ot">)</span><span class="ot">)</span><span class="ot">]</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">lookupHash2ArrayMappedTrie</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="va">value</span><span>
</span><span class="va">lookupHash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="ot">=</span><span> </span><span class="va">lookupHash2ArrayMappedTrieHelper</span><span> </span><span class="dv">0</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="va">key</span><span>

</span><span class="va">lookupHash2ArrayMappedTrieHelper</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="va">value</span><span>
</span><span class="va">lookupHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="dt">Hash2ArrayMappedTrieNone</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Nothing</span><span>
</span><span class="va">lookupHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="dt">Hash2ArrayMappedTrieLeaf</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span class="ot">)</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">hash</span><span> </span><span class="op">==</span><span> </span><span class="va">leafHash</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Just</span><span> </span><span class="va">leafValue</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">otherwise</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Nothing</span><span>
</span><span class="va">lookupHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="dt">Hash2ArrayMappedTrieNode</span><span> </span><span class="va">children</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">goRight</span><span> </span><span class="ot">=</span><span> </span><span class="va">testBit</span><span> </span><span class="va">hash</span><span> </span><span class="va">depth</span><span>
    </span><span class="va">depth'</span><span> </span><span class="ot">=</span><span> </span><span class="va">depth</span><span> </span><span class="op">+</span><span> </span><span class="dv">1</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">goRight</span><span>
        </span><span class="kw">then</span><span> </span><span class="va">lookupHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="va">children</span><span> </span><span class="op">!</span><span> </span><span class="dv">1</span><span class="ot">)</span><span>
        </span><span class="kw">else</span><span> </span><span class="va">lookupHash2ArrayMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="va">children</span><span> </span><span class="op">!</span><span> </span><span class="dv">0</span><span class="ot">)</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">emptyHash2ArrayMappedTrie</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Hash2ArrayMappedTrieNone</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span><span> </span><span class="dt">Mapping</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">empty</span><span> </span><span class="ot">=</span><span> </span><span class="va">emptyHash2ArrayMappedTrie</span><span>
    </span><span class="va">insert</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHash2ArrayMappedTrie</span><span>
    </span><span class="va">lookup</span><span> </span><span class="ot">=</span><span> </span><span class="va">lookupHash2ArrayMappedTrie</span></code></pre></div>
And as before we can define a function to render this tree using Graphviz:
<details>
<summary>
Hash 2-Array Mapped Trie
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span><span> </span><span class="dt">Hash2ArrayMappedTrieGraphvizNode</span><span>
    </span><span class="ot">=</span><span> </span><span class="dt">Hash2ArrayMappedTrieGraphvizNode</span><span>
        </span><span class="ot">{</span><span> </span><span class="va">hash2ArrayMappedTrieGraphvizNodeId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hash2ArrayMappedTrieGraphvizFields</span><span> </span><span class="ot">::</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
        </span><span class="ot">}</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">Hash2ArrayMappedTrieGraphvizLeafNode</span><span>
        </span><span class="ot">{</span><span> </span><span class="va">hash2ArrayMappedTrieGraphvizLeafNodeId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hash2ArrayMappedTrieGraphvizLeafHash</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hash2ArrayMappedTrieGraphvizLeafKey</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hash2ArrayMappedTrieGraphvizLeafNodeValue</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">}</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="ot">(</span><span class="dt">Eq</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span class="ot">)</span><span>

</span><span class="va">numberH2AMT</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Show</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">WriterT</span><span> </span><span class="ot">[</span><span class="dt">Hash2ArrayMappedTrieGraphvizNode</span><span class="ot">]</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">numberH2AMT</span><span> </span><span class="dt">Hash2ArrayMappedTrieNone</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">tell</span><span> </span><span class="va">mempty</span><span>
    </span><span class="va">pure</span><span> </span><span class="dv">0</span><span>
</span><span class="va">numberH2AMT</span><span> </span><span class="ot">(</span><span class="dt">Hash2ArrayMappedTrieLeaf</span><span> </span><span class="va">h</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">lift</span><span> </span><span class="va">getFreshId</span><span>
    </span><span class="va">tell</span><span> </span><span class="ot">[</span><span class="dt">Hash2ArrayMappedTrieGraphvizLeafNode</span><span> </span><span class="va">i</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">h</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">k</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">]</span><span>
    </span><span class="va">pure</span><span> </span><span class="va">i</span><span>
</span><span class="va">numberH2AMT</span><span> </span><span class="ot">(</span><span class="dt">Hash2ArrayMappedTrieNode</span><span> </span><span class="va">hs</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">lift</span><span> </span><span class="va">getFreshId</span><span>
    </span><span class="va">numbered</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">Vector.toList</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">traverse</span><span> </span><span class="va">numberH2AMT</span><span> </span><span class="va">hs</span><span>
    </span><span class="va">tell</span><span> </span><span class="ot">[</span><span class="dt">Hash2ArrayMappedTrieGraphvizNode</span><span> </span><span class="va">i</span><span> </span><span class="va">numbered</span><span class="ot">]</span><span>
    </span><span class="va">pure</span><span> </span><span class="va">i</span><span>

</span><span class="va">nodeLinesH2AMT</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Hash2ArrayMappedTrieGraphvizNode</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">String</span><span class="ot">]</span><span>
</span><span class="va">nodeLinesH2AMT</span><span> </span><span class="ot">(</span><span class="dt">Hash2ArrayMappedTrieGraphvizLeafNode</span><span> </span><span class="va">i</span><span> </span><span class="va">h</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="kw">label</span><span> </span><span class="ot">=</span><span> </span><span class="va">intercalate</span><span> </span><span class="st">&quot;|&quot;</span><span> </span><span class="ot">[</span><span class="va">h</span><span class="ot">,</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">]</span><span>
    </span><span class="va">line</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span class="ot">)</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;[label=\&quot;&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">escape</span><span> </span><span class="kw">label</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;\&quot;]&quot;</span><span>
    </span><span class="kw">in</span><span> </span><span class="ot">[</span><span class="va">line</span><span class="ot">]</span><span>
</span><span class="va">nodeLinesH2AMT</span><span> </span><span class="ot">(</span><span class="dt">Hash2ArrayMappedTrieGraphvizNode</span><span> </span><span class="va">i</span><span> </span><span class="va">fs</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">indices</span><span> </span><span class="ot">=</span><span> </span><span class="va">Prelude.take</span><span> </span><span class="ot">(</span><span class="va">length</span><span> </span><span class="va">fs</span><span class="ot">)</span><span> </span><span class="ot">[</span><span class="dv">0</span><span class="ot">..</span><span class="ot">]</span><span>
    </span><span class="va">pairs</span><span> </span><span class="ot">=</span><span> </span><span class="va">zip</span><span> </span><span class="va">indices</span><span> </span><span class="va">fs</span><span>
    </span><span class="va">edges</span><span> </span><span class="ot">=</span><span> </span><span class="va">flip</span><span> </span><span class="va">map</span><span> </span><span class="va">pairs</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="ot">(</span><span class="va">f</span><span class="ot">,</span><span class="va">t</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;:&quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;f&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">f</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; -&gt; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">t</span><span>
    </span><span class="va">fields</span><span> </span><span class="ot">=</span><span> </span><span class="va">flip</span><span> </span><span class="va">map</span><span> </span><span class="va">indices</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">ix</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="st">&quot;&lt;f&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">ix</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;&gt;&quot;</span><span>
    </span><span class="kw">label</span><span> </span><span class="ot">=</span><span> </span><span class="va">intercalate</span><span> </span><span class="st">&quot;|&quot;</span><span> </span><span class="va">fields</span><span>
    </span><span class="va">line</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span class="ot">)</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;[label=\&quot;&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">escape</span><span> </span><span class="kw">label</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;\&quot;]&quot;</span><span>
    </span><span class="kw">in</span><span> </span><span class="ot">(</span><span class="va">line</span><span class="ot">:</span><span class="va">edges</span><span class="ot">)</span><span>

</span><span class="va">dotFromH2AMT</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Show</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="dt">Hash2ArrayMappedTrie</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">String</span><span>
</span><span class="va">dotFromH2AMT</span><span> </span><span class="ot">=</span><span> </span><span class="va">makeDot</span><span> </span><span class="op">.</span><span> </span><span class="va">makeDotLines</span><span class="op">.</span><span> </span><span class="va">concatMap</span><span> </span><span class="va">nodeLinesH2AMT</span><span> </span><span class="op">.</span><span> </span><span class="va">flip</span><span> </span><span class="va">evalState</span><span> </span><span class="dv">0</span><span> </span><span class="op">.</span><span> </span><span class="va">execWriterT</span><span> </span><span class="op">.</span><span> </span><span class="va">numberH2AMT</span></code></pre></div>
</details>
The corresponding tree created by <code>fib' 8</code> looks very similar:
<details>
<summary>
Hash 2-Array Mapped Trie
</summary>
<div style="overflow: scroll">
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">dot</span><span> </span><span class="op">$</span><span> </span><span class="va">dotFromH2AMT</span><span> </span><span class="op">$</span><span> </span><span class="va">snd</span><span> </span><span class="op">$</span><span> </span><span class="va">fib'</span><span> </span><span class="va">emptyHash2ArrayMappedTrie</span><span> </span><span class="dv">8</span></code></pre></div>
<svg width="3454pt" height="769pt" viewBox="0.00 0.00 3453.50 769.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 765)">
<polygon fill="white" stroke="none" points="-4,4 -4,-765 3449.5,-765 3449.5,4 -4,4"></polygon>
<!-- n4 -->
<g id="node1" class="node">
<title>
n4
</title>
<polygon fill="none" stroke="black" points="0,-0.5 0,-36.5 357,-36.5 357,-0.5 0,-0.5"></polygon>
<text text-anchor="middle" x="152.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000000</text>
<polyline fill="none" stroke="black" points="305,-0.5 305,-36.5"></polyline>
<text text-anchor="middle" x="318" y="-14.8" font-family="Times,serif" font-size="14.00">0</text>
<polyline fill="none" stroke="black" points="331,-0.5 331,-36.5"></polyline>
<text text-anchor="middle" x="344" y="-14.8" font-family="Times,serif" font-size="14.00">1</text>
</g>
<!-- n5 -->
<g id="node2" class="node">
<title>
n5
</title>
<polygon fill="none" stroke="black" points="429.5,-0.5 429.5,-36.5 795.5,-36.5 795.5,-0.5 429.5,-0.5"></polygon>
<text text-anchor="middle" x="582" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000001000</text>
<polyline fill="none" stroke="black" points="734.5,-0.5 734.5,-36.5"></polyline>
<text text-anchor="middle" x="747.5" y="-14.8" font-family="Times,serif" font-size="14.00">8</text>
<polyline fill="none" stroke="black" points="760.5,-0.5 760.5,-36.5"></polyline>
<text text-anchor="middle" x="778" y="-14.8" font-family="Times,serif" font-size="14.00">34</text>
</g>
<!-- n3 -->
<g id="node3" class="node">
<title>
n3
</title>
<polygon fill="none" stroke="black" points="368.5,-181.5 368.5,-217.5 422.5,-217.5 422.5,-181.5 368.5,-181.5"></polygon>
<text text-anchor="middle" x="382" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="395.5,-181.5 395.5,-217.5"></polyline>
<text text-anchor="middle" x="409" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n3&#45;&gt;n4 -->
<g id="edge1" class="edge">
<title>
n3:f0-&gt;n4
</title>
<path fill="none" stroke="black" d="M381.5,-181C381.5,-181 265.26,-88.53 208.7,-43.53"></path>
<polygon fill="black" stroke="black" points="211.03,-40.91 201.03,-37.42 206.67,-46.39 211.03,-40.91"></polygon>
</g>
<!-- n3&#45;&gt;n5 -->
<g id="edge2" class="edge">
<title>
n3:f1-&gt;n5
</title>
<path fill="none" stroke="black" d="M409.5,-181C409.5,-181 525.74,-88.53 582.3,-43.53"></path>
<polygon fill="black" stroke="black" points="584.33,-46.39 589.97,-37.42 579.97,-40.91 584.33,-46.39"></polygon>
</g>
<!-- n6 -->
<g id="node4" class="node">
<title>
n6
</title>
<polygon fill="none" stroke="black" points="495,-181.5 495,-217.5 852,-217.5 852,-181.5 495,-181.5"></polygon>
<text text-anchor="middle" x="647.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000100</text>
<polyline fill="none" stroke="black" points="800,-181.5 800,-217.5"></polyline>
<text text-anchor="middle" x="813" y="-195.8" font-family="Times,serif" font-size="14.00">4</text>
<polyline fill="none" stroke="black" points="826,-181.5 826,-217.5"></polyline>
<text text-anchor="middle" x="839" y="-195.8" font-family="Times,serif" font-size="14.00">5</text>
</g>
<!-- n2 -->
<g id="node5" class="node">
<title>
n2
</title>
<polygon fill="none" stroke="black" points="632.5,-362.5 632.5,-398.5 686.5,-398.5 686.5,-362.5 632.5,-362.5"></polygon>
<text text-anchor="middle" x="646" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="659.5,-362.5 659.5,-398.5"></polyline>
<text text-anchor="middle" x="673" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n2&#45;&gt;n3 -->
<g id="edge3" class="edge">
<title>
n2:f0-&gt;n3
</title>
<path fill="none" stroke="black" d="M631.5,-380.5C631.5,-380.5 490.65,-273.07 426.57,-224.2"></path>
<polygon fill="black" stroke="black" points="428.98,-221.63 418.91,-218.35 424.73,-227.2 428.98,-221.63"></polygon>
</g>
<!-- n2&#45;&gt;n6 -->
<g id="edge4" class="edge">
<title>
n2:f1-&gt;n6
</title>
<path fill="none" stroke="black" d="M673.5,-362C673.5,-362 673.5,-275.16 673.5,-228.83"></path>
<polygon fill="black" stroke="black" points="677,-228.99 673.5,-218.99 670,-228.99 677,-228.99"></polygon>
</g>
<!-- n8 -->
<g id="node6" class="node">
<title>
n8
</title>
<polygon fill="none" stroke="black" points="924,-181.5 924,-217.5 1281,-217.5 1281,-181.5 924,-181.5"></polygon>
<text text-anchor="middle" x="1076.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000010</text>
<polyline fill="none" stroke="black" points="1229,-181.5 1229,-217.5"></polyline>
<text text-anchor="middle" x="1242" y="-195.8" font-family="Times,serif" font-size="14.00">2</text>
<polyline fill="none" stroke="black" points="1255,-181.5 1255,-217.5"></polyline>
<text text-anchor="middle" x="1268" y="-195.8" font-family="Times,serif" font-size="14.00">2</text>
</g>
<!-- n9 -->
<g id="node7" class="node">
<title>
n9
</title>
<polygon fill="none" stroke="black" points="1353.5,-181.5 1353.5,-217.5 1719.5,-217.5 1719.5,-181.5 1353.5,-181.5"></polygon>
<text text-anchor="middle" x="1506" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000110</text>
<polyline fill="none" stroke="black" points="1658.5,-181.5 1658.5,-217.5"></polyline>
<text text-anchor="middle" x="1671.5" y="-195.8" font-family="Times,serif" font-size="14.00">6</text>
<polyline fill="none" stroke="black" points="1684.5,-181.5 1684.5,-217.5"></polyline>
<text text-anchor="middle" x="1702" y="-195.8" font-family="Times,serif" font-size="14.00">13</text>
</g>
<!-- n7 -->
<g id="node8" class="node">
<title>
n7
</title>
<polygon fill="none" stroke="black" points="1292.5,-362.5 1292.5,-398.5 1346.5,-398.5 1346.5,-362.5 1292.5,-362.5"></polygon>
<text text-anchor="middle" x="1306" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1319.5,-362.5 1319.5,-398.5"></polyline>
<text text-anchor="middle" x="1333" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n7&#45;&gt;n8 -->
<g id="edge5" class="edge">
<title>
n7:f0-&gt;n8
</title>
<path fill="none" stroke="black" d="M1305.5,-362C1305.5,-362 1189.26,-269.53 1132.7,-224.53"></path>
<polygon fill="black" stroke="black" points="1135.03,-221.91 1125.03,-218.42 1130.67,-227.39 1135.03,-221.91"></polygon>
</g>
<!-- n7&#45;&gt;n9 -->
<g id="edge6" class="edge">
<title>
n7:f1-&gt;n9
</title>
<path fill="none" stroke="black" d="M1333.5,-362C1333.5,-362 1449.74,-269.53 1506.3,-224.53"></path>
<polygon fill="black" stroke="black" points="1508.33,-227.39 1513.97,-218.42 1503.97,-221.91 1508.33,-227.39"></polygon>
</g>
<!-- n1 -->
<g id="node9" class="node">
<title>
n1
</title>
<polygon fill="none" stroke="black" points="1278.5,-543.5 1278.5,-579.5 1332.5,-579.5 1332.5,-543.5 1278.5,-543.5"></polygon>
<text text-anchor="middle" x="1292" y="-557.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1305.5,-543.5 1305.5,-579.5"></polyline>
<text text-anchor="middle" x="1319" y="-557.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n1&#45;&gt;n2 -->
<g id="edge7" class="edge">
<title>
n1:f0-&gt;n2
</title>
<path fill="none" stroke="black" d="M1277.5,-561.5C1277.5,-561.5 831.76,-431.67 697.39,-392.54"></path>
<polygon fill="black" stroke="black" points="698.49,-389.21 687.91,-389.77 696.53,-395.93 698.49,-389.21"></polygon>
</g>
<!-- n1&#45;&gt;n7 -->
<g id="edge8" class="edge">
<title>
n1:f1-&gt;n7
</title>
<path fill="none" stroke="black" d="M1319.5,-543C1319.5,-543 1319.5,-456.16 1319.5,-409.83"></path>
<polygon fill="black" stroke="black" points="1323,-409.99 1319.5,-399.99 1316,-409.99 1323,-409.99"></polygon>
</g>
<!-- n12 -->
<g id="node10" class="node">
<title>
n12
</title>
<polygon fill="none" stroke="black" points="1792,-181.5 1792,-217.5 2149,-217.5 2149,-181.5 1792,-181.5"></polygon>
<text text-anchor="middle" x="1944.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000001</text>
<polyline fill="none" stroke="black" points="2097,-181.5 2097,-217.5"></polyline>
<text text-anchor="middle" x="2110" y="-195.8" font-family="Times,serif" font-size="14.00">1</text>
<polyline fill="none" stroke="black" points="2123,-181.5 2123,-217.5"></polyline>
<text text-anchor="middle" x="2136" y="-195.8" font-family="Times,serif" font-size="14.00">1</text>
</g>
<!-- n13 -->
<g id="node11" class="node">
<title>
n13
</title>
<polygon fill="none" stroke="black" points="2221,-181.5 2221,-217.5 2578,-217.5 2578,-181.5 2221,-181.5"></polygon>
<text text-anchor="middle" x="2373.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000101</text>
<polyline fill="none" stroke="black" points="2526,-181.5 2526,-217.5"></polyline>
<text text-anchor="middle" x="2539" y="-195.8" font-family="Times,serif" font-size="14.00">5</text>
<polyline fill="none" stroke="black" points="2552,-181.5 2552,-217.5"></polyline>
<text text-anchor="middle" x="2565" y="-195.8" font-family="Times,serif" font-size="14.00">8</text>
</g>
<!-- n11 -->
<g id="node12" class="node">
<title>
n11
</title>
<polygon fill="none" stroke="black" points="2157.5,-362.5 2157.5,-398.5 2211.5,-398.5 2211.5,-362.5 2157.5,-362.5"></polygon>
<text text-anchor="middle" x="2171" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="2184.5,-362.5 2184.5,-398.5"></polyline>
<text text-anchor="middle" x="2198" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n11&#45;&gt;n12 -->
<g id="edge9" class="edge">
<title>
n11:f0-&gt;n12
</title>
<path fill="none" stroke="black" d="M2170.5,-362C2170.5,-362 2055.98,-269.53 2000.26,-224.53"></path>
<polygon fill="black" stroke="black" points="2002.68,-221.99 1992.7,-218.43 1998.28,-227.43 2002.68,-221.99"></polygon>
</g>
<!-- n11&#45;&gt;n13 -->
<g id="edge10" class="edge">
<title>
n11:f1-&gt;n13
</title>
<path fill="none" stroke="black" d="M2198.5,-362C2198.5,-362 2313.59,-269.53 2369.6,-224.53"></path>
<polygon fill="black" stroke="black" points="2371.59,-227.42 2377.19,-218.43 2367.2,-221.96 2371.59,-227.42"></polygon>
</g>
<!-- n15 -->
<g id="node13" class="node">
<title>
n15
</title>
<polygon fill="none" stroke="black" points="2650,-181.5 2650,-217.5 3007,-217.5 3007,-181.5 2650,-181.5"></polygon>
<text text-anchor="middle" x="2802.5" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000011</text>
<polyline fill="none" stroke="black" points="2955,-181.5 2955,-217.5"></polyline>
<text text-anchor="middle" x="2968" y="-195.8" font-family="Times,serif" font-size="14.00">3</text>
<polyline fill="none" stroke="black" points="2981,-181.5 2981,-217.5"></polyline>
<text text-anchor="middle" x="2994" y="-195.8" font-family="Times,serif" font-size="14.00">3</text>
</g>
<!-- n16 -->
<g id="node14" class="node">
<title>
n16
</title>
<polygon fill="none" stroke="black" points="3079.5,-181.5 3079.5,-217.5 3445.5,-217.5 3445.5,-181.5 3079.5,-181.5"></polygon>
<text text-anchor="middle" x="3232" y="-195.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000111</text>
<polyline fill="none" stroke="black" points="3384.5,-181.5 3384.5,-217.5"></polyline>
<text text-anchor="middle" x="3397.5" y="-195.8" font-family="Times,serif" font-size="14.00">7</text>
<polyline fill="none" stroke="black" points="3410.5,-181.5 3410.5,-217.5"></polyline>
<text text-anchor="middle" x="3428" y="-195.8" font-family="Times,serif" font-size="14.00">21</text>
</g>
<!-- n14 -->
<g id="node15" class="node">
<title>
n14
</title>
<polygon fill="none" stroke="black" points="2815.5,-362.5 2815.5,-398.5 2869.5,-398.5 2869.5,-362.5 2815.5,-362.5"></polygon>
<text text-anchor="middle" x="2829" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="2842.5,-362.5 2842.5,-398.5"></polyline>
<text text-anchor="middle" x="2856" y="-376.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n14&#45;&gt;n15 -->
<g id="edge11" class="edge">
<title>
n14:f0-&gt;n15
</title>
<path fill="none" stroke="black" d="M2828.5,-362C2828.5,-362 2828.5,-275.16 2828.5,-228.83"></path>
<polygon fill="black" stroke="black" points="2832,-228.99 2828.5,-218.99 2825,-228.99 2832,-228.99"></polygon>
</g>
<!-- n14&#45;&gt;n16 -->
<g id="edge12" class="edge">
<title>
n14:f1-&gt;n16
</title>
<path fill="none" stroke="black" d="M2870.5,-380.5C2870.5,-380.5 3111.22,-269.97 3215.39,-222.13"></path>
<polygon fill="black" stroke="black" points="3216.62,-225.42 3224.25,-218.07 3213.7,-219.06 3216.62,-225.42"></polygon>
</g>
<!-- n10 -->
<g id="node16" class="node">
<title>
n10
</title>
<polygon fill="none" stroke="black" points="2171.5,-543.5 2171.5,-579.5 2225.5,-579.5 2225.5,-543.5 2171.5,-543.5"></polygon>
<text text-anchor="middle" x="2185" y="-557.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="2198.5,-543.5 2198.5,-579.5"></polyline>
<text text-anchor="middle" x="2212" y="-557.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n10&#45;&gt;n11 -->
<g id="edge13" class="edge">
<title>
n10:f0-&gt;n11
</title>
<path fill="none" stroke="black" d="M2184.5,-543C2184.5,-543 2184.5,-456.16 2184.5,-409.83"></path>
<polygon fill="black" stroke="black" points="2188,-409.99 2184.5,-399.99 2181,-409.99 2188,-409.99"></polygon>
</g>
<!-- n10&#45;&gt;n14 -->
<g id="edge14" class="edge">
<title>
n10:f1-&gt;n14
</title>
<path fill="none" stroke="black" d="M2226.5,-561.5C2226.5,-561.5 2670.8,-431.67 2804.73,-392.54"></path>
<polygon fill="black" stroke="black" points="2805.57,-395.94 2814.18,-389.77 2803.6,-389.22 2805.57,-395.94"></polygon>
</g>
<!-- n0 -->
<g id="node17" class="node">
<title>
n0
</title>
<polygon fill="none" stroke="black" points="1726.5,-724.5 1726.5,-760.5 1780.5,-760.5 1780.5,-724.5 1726.5,-724.5"></polygon>
<text text-anchor="middle" x="1740" y="-738.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1753.5,-724.5 1753.5,-760.5"></polyline>
<text text-anchor="middle" x="1767" y="-738.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n0&#45;&gt;n1 -->
<g id="edge15" class="edge">
<title>
n0:f0-&gt;n1
</title>
<path fill="none" stroke="black" d="M1725.5,-742.5C1725.5,-742.5 1445.86,-622.65 1342.94,-578.54"></path>
<polygon fill="black" stroke="black" points="1344.37,-575.35 1333.8,-574.63 1341.62,-581.79 1344.37,-575.35"></polygon>
</g>
<!-- n0&#45;&gt;n10 -->
<g id="edge16" class="edge">
<title>
n0:f1-&gt;n10
</title>
<path fill="none" stroke="black" d="M1781.5,-742.5C1781.5,-742.5 2059.14,-622.65 2161.33,-578.54"></path>
<polygon fill="black" stroke="black" points="2162.6,-581.81 2170.39,-574.63 2159.82,-575.38 2162.6,-581.81"></polygon>
</g>
</g>
</svg>
</div>
</details>
<p>Now that we’re using arrays, we can fix our branching factor problem by recognising the relationship between the number of bits of the hash that we are plucking off and inspecting at each level and the children each node can have. So far we have only been inspecting one bit, which can have two values and therefore two children. If we were to inspect two bits at each level, we could have four possible children per fragment (corresponding to the values 00, 01, 10, and 11), 8 children for 3 bits, and so on. I’ve chosen to use 4 bits which means 16 children.</p>
<p>I’m going to call this iteration <code>HashArrayMappedTrieSpacious</code> because it’s space-inefficient in a way we’ll discuss and fix later.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousNone</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousLeaf</span><span> </span><span class="dt">Hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousNode</span><span> </span><span class="ot">(</span><span class="dt">Vector</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span class="ot">)</span><span class="ot">)</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="ot">(</span><span class="dt">Eq</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span class="ot">)</span></code></pre></div>
<p>An important point is that we re-interpret the hash fragment as the index into our array, e.g. <code>0110</code> is the 6th index. We’ll need some bit-twiddling functions to make this easier.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">hashFragmentLength</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">hashFragmentLength</span><span> </span><span class="ot">=</span><span> </span><span class="dv">4</span><span>

</span><span class="va">hashMask</span><span> </span><span class="ot">=</span><span> </span><span class="va">bit</span><span> </span><span class="va">hashFragmentLength</span><span> </span><span class="op">-</span><span> </span><span class="dv">1</span><span> </span><span class="co">-- 0b1111</span></code></pre></div>
<p>To <code>insert</code> and <code>lookup</code> elements, we now need to:</p>
<ol type="1">
<li>Mask off the correct 4 bits of the hash.</li>
<li>Interpret the 4-bit hash fragment as an index from 0 to 15.</li>
<li>Insert/lookup the element at the corresponding index of the array, recursively creating it if required.</li>
</ol>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">insertHashArrayMappedTrieSpacious</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="dv">0</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="va">key</span><span>

</span><span class="va">insertHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousNone</span><span> </span><span class="ot">=</span><span>
    </span><span class="dt">HashArrayMappedTrieSpaciousLeaf</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieSpaciousLeaf</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span class="ot">)</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">hash</span><span> </span><span class="op">==</span><span> </span><span class="va">leafHash</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousLeaf</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">otherwise</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
        </span><span class="va">emptyNode</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousNode</span><span> </span><span class="ot">(</span><span class="va">replicate</span><span> </span><span class="ot">(</span><span class="dv">2</span><span class="op">^</span><span class="va">hashFragmentLength</span><span class="ot">)</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousNone</span><span class="ot">)</span><span>
        </span><span class="va">leafInsertedNode</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span> </span><span class="va">emptyNode</span><span>
        </span><span class="kw">in</span><span> </span><span class="va">insertHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="va">leafInsertedNode</span><span>
</span><span class="va">insertHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieSpaciousNode</span><span> </span><span class="va">children</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">hashFragment</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="ot">`</span><span class="va">shiftR</span><span class="ot">`</span><span> </span><span class="va">depth</span><span class="ot">)</span><span> </span><span class="op">.&amp;.</span><span> </span><span class="va">hashMask</span><span>
    </span><span class="va">index</span><span> </span><span class="ot">=</span><span> </span><span class="va">fromIntegral</span><span> </span><span class="va">hashFragment</span><span>
    </span><span class="va">depth'</span><span> </span><span class="ot">=</span><span> </span><span class="va">depth</span><span> </span><span class="op">+</span><span> </span><span class="va">hashFragmentLength</span><span>
    </span><span class="kw">in</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousNode</span><span>
        </span><span class="ot">(</span><span class="va">children</span><span> </span><span class="op">//</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="va">index</span><span class="ot">,</span><span> </span><span class="va">insertHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="va">children</span><span> </span><span class="op">!</span><span> </span><span class="va">index</span><span class="ot">)</span><span class="ot">)</span><span class="ot">]</span><span class="ot">)</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">lookupHashArrayMappedTrieSpacious</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="va">value</span><span>
</span><span class="va">lookupHashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="ot">=</span><span> </span><span class="va">lookupHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="dv">0</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="va">key</span><span>

</span><span class="va">lookupHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="va">value</span><span>
</span><span class="va">lookupHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousNone</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Nothing</span><span>
</span><span class="va">lookupHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieSpaciousLeaf</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span class="ot">)</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">hash</span><span> </span><span class="op">==</span><span> </span><span class="va">leafHash</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Just</span><span> </span><span class="va">leafValue</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">otherwise</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Nothing</span><span>
</span><span class="va">lookupHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieSpaciousNode</span><span> </span><span class="va">children</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">hashFragment</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="ot">`</span><span class="va">shiftR</span><span class="ot">`</span><span> </span><span class="va">depth</span><span class="ot">)</span><span> </span><span class="op">.&amp;.</span><span> </span><span class="va">hashMask</span><span>
    </span><span class="va">index</span><span> </span><span class="ot">=</span><span> </span><span class="va">fromIntegral</span><span> </span><span class="va">hashFragment</span><span>
    </span><span class="va">depth'</span><span> </span><span class="ot">=</span><span> </span><span class="va">depth</span><span> </span><span class="op">+</span><span> </span><span class="va">hashFragmentLength</span><span>
    </span><span class="kw">in</span><span> </span><span class="va">lookupHashArrayMappedTrieSpaciousHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="va">children</span><span> </span><span class="op">!</span><span> </span><span class="va">index</span><span class="ot">)</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">emptyHashArrayMappedTrieSpacious</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousNone</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span><span> </span><span class="dt">Mapping</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">empty</span><span> </span><span class="ot">=</span><span> </span><span class="va">emptyHashArrayMappedTrieSpacious</span><span>
    </span><span class="va">insert</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHashArrayMappedTrieSpacious</span><span>
    </span><span class="va">lookup</span><span> </span><span class="ot">=</span><span> </span><span class="va">lookupHashArrayMappedTrieSpacious</span></code></pre></div>
<p>Once again we can define a rendering function:</p>
<details>
<summary>
Hash Array Mapped Trie (Spacious)
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousGraphvizNode</span><span>
    </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousGraphvizNode</span><span>
        </span><span class="ot">{</span><span> </span><span class="va">hashArrayMappedTrieSpaciousGraphvizNodeId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashArrayMappedTrieSpaciousGraphvizFields</span><span> </span><span class="ot">::</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
        </span><span class="ot">}</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousGraphvizLeafNode</span><span>
        </span><span class="ot">{</span><span> </span><span class="va">hashArrayMappedTrieSpaciousGraphvizLeafNodeId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashArrayMappedTrieSpaciousGraphvizLeafHash</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashArrayMappedTrieSpaciousGraphvizLeafKey</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashArrayMappedTrieSpaciousGraphvizLeafNodeValue</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">}</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="ot">(</span><span class="dt">Eq</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span class="ot">)</span><span>

</span><span class="va">numberHAMTS</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Show</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">WriterT</span><span> </span><span class="ot">[</span><span class="dt">HashArrayMappedTrieSpaciousGraphvizNode</span><span class="ot">]</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">numberHAMTS</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousNone</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">tell</span><span> </span><span class="va">mempty</span><span>
    </span><span class="va">pure</span><span> </span><span class="dv">0</span><span>
</span><span class="va">numberHAMTS</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieSpaciousLeaf</span><span> </span><span class="va">h</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">lift</span><span> </span><span class="va">getFreshId</span><span>
    </span><span class="va">tell</span><span> </span><span class="ot">[</span><span class="dt">HashArrayMappedTrieSpaciousGraphvizLeafNode</span><span> </span><span class="va">i</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">h</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">k</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">]</span><span>
    </span><span class="va">pure</span><span> </span><span class="va">i</span><span>
</span><span class="va">numberHAMTS</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieSpaciousNode</span><span> </span><span class="va">hs</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">lift</span><span> </span><span class="va">getFreshId</span><span>
    </span><span class="va">numbered</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">Vector.toList</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">traverse</span><span> </span><span class="va">numberHAMTS</span><span> </span><span class="va">hs</span><span>
    </span><span class="va">tell</span><span> </span><span class="ot">[</span><span class="dt">HashArrayMappedTrieSpaciousGraphvizNode</span><span> </span><span class="va">i</span><span> </span><span class="va">numbered</span><span class="ot">]</span><span>
    </span><span class="va">pure</span><span> </span><span class="va">i</span><span>

</span><span class="va">nodeLinesHAMTS</span><span> </span><span class="ot">::</span><span> </span><span class="dt">HashArrayMappedTrieSpaciousGraphvizNode</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">String</span><span class="ot">]</span><span>
</span><span class="va">nodeLinesHAMTS</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieSpaciousGraphvizLeafNode</span><span> </span><span class="va">i</span><span> </span><span class="va">h</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="kw">label</span><span> </span><span class="ot">=</span><span> </span><span class="va">intercalate</span><span> </span><span class="st">&quot;|&quot;</span><span> </span><span class="ot">[</span><span class="va">h</span><span class="ot">,</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">]</span><span>
    </span><span class="va">line</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span class="ot">)</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;[label=\&quot;&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">escape</span><span> </span><span class="kw">label</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;\&quot;]&quot;</span><span>
    </span><span class="kw">in</span><span> </span><span class="ot">[</span><span class="va">line</span><span class="ot">]</span><span>
</span><span class="va">nodeLinesHAMTS</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieSpaciousGraphvizNode</span><span> </span><span class="va">i</span><span> </span><span class="va">fs</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">indices</span><span> </span><span class="ot">=</span><span> </span><span class="va">Prelude.take</span><span> </span><span class="ot">(</span><span class="va">length</span><span> </span><span class="va">fs</span><span class="ot">)</span><span> </span><span class="ot">[</span><span class="dv">0</span><span class="ot">..</span><span class="ot">]</span><span>
    </span><span class="va">pairs</span><span> </span><span class="ot">=</span><span> </span><span class="va">filter</span><span> </span><span class="ot">(</span><span class="ot">\</span><span class="ot">(</span><span class="ot">_</span><span class="ot">,</span><span class="va">i</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">i</span><span> </span><span class="op">/=</span><span> </span><span class="dv">0</span><span class="ot">)</span><span> </span><span class="op">$</span><span> </span><span class="va">zip</span><span> </span><span class="va">indices</span><span> </span><span class="va">fs</span><span>
    </span><span class="va">edges</span><span> </span><span class="ot">=</span><span> </span><span class="va">flip</span><span> </span><span class="va">map</span><span> </span><span class="va">pairs</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="ot">(</span><span class="va">f</span><span class="ot">,</span><span class="va">t</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;:&quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;f&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">f</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; -&gt; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">t</span><span>
    </span><span class="va">fields</span><span> </span><span class="ot">=</span><span> </span><span class="va">flip</span><span> </span><span class="va">map</span><span> </span><span class="va">indices</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">ix</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="st">&quot;&lt;f&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">ix</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;&gt;&quot;</span><span>
    </span><span class="kw">label</span><span> </span><span class="ot">=</span><span> </span><span class="va">intercalate</span><span> </span><span class="st">&quot;|&quot;</span><span> </span><span class="va">fields</span><span>
    </span><span class="va">line</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span class="ot">)</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;[label=\&quot;&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">escape</span><span> </span><span class="kw">label</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;\&quot;]&quot;</span><span>
    </span><span class="kw">in</span><span> </span><span class="ot">(</span><span class="va">line</span><span class="ot">:</span><span class="va">edges</span><span class="ot">)</span><span>

</span><span class="va">dotFromHAMTS</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Show</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="dt">HashArrayMappedTrieSpacious</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">String</span><span>
</span><span class="va">dotFromHAMTS</span><span> </span><span class="ot">=</span><span> </span><span class="va">makeDot</span><span> </span><span class="op">.</span><span> </span><span class="va">makeDotLines</span><span class="op">.</span><span> </span><span class="va">concatMap</span><span> </span><span class="va">nodeLinesHAMTS</span><span> </span><span class="op">.</span><span> </span><span class="va">flip</span><span> </span><span class="va">evalState</span><span> </span><span class="dv">0</span><span> </span><span class="op">.</span><span> </span><span class="va">execWriterT</span><span> </span><span class="op">.</span><span> </span><span class="va">numberHAMTS</span></code></pre></div>
</details>
And inspect our handiwork:
<details>
<summary>
Hash Array Mapped Trie (Spacious)
</summary>
<div style="overflow: scroll">
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">dot</span><span> </span><span class="op">$</span><span> </span><span class="va">dotFromHAMTS</span><span> </span><span class="op">$</span><span> </span><span class="va">snd</span><span> </span><span class="op">$</span><span> </span><span class="va">fib'</span><span> </span><span class="va">emptyHashArrayMappedTrieSpacious</span><span> </span><span class="dv">8</span></code></pre></div>
<svg width="3825pt" height="226pt" viewBox="0.00 0.00 3824.50 226.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 222)">
<polygon fill="white" stroke="none" points="-4,4 -4,-222 3820.5,-222 3820.5,4 -4,4"></polygon>
<!-- n1 -->
<g id="node1" class="node">
<title>
n1
</title>
<polygon fill="none" stroke="black" points="0,-0.5 0,-36.5 357,-36.5 357,-0.5 0,-0.5"></polygon>
<text text-anchor="middle" x="152.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000000</text>
<polyline fill="none" stroke="black" points="305,-0.5 305,-36.5"></polyline>
<text text-anchor="middle" x="318" y="-14.8" font-family="Times,serif" font-size="14.00">0</text>
<polyline fill="none" stroke="black" points="331,-0.5 331,-36.5"></polyline>
<text text-anchor="middle" x="344" y="-14.8" font-family="Times,serif" font-size="14.00">1</text>
</g>
<!-- n2 -->
<g id="node2" class="node">
<title>
n2
</title>
<polygon fill="none" stroke="black" points="429,-0.5 429,-36.5 786,-36.5 786,-0.5 429,-0.5"></polygon>
<text text-anchor="middle" x="581.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000001</text>
<polyline fill="none" stroke="black" points="734,-0.5 734,-36.5"></polyline>
<text text-anchor="middle" x="747" y="-14.8" font-family="Times,serif" font-size="14.00">1</text>
<polyline fill="none" stroke="black" points="760,-0.5 760,-36.5"></polyline>
<text text-anchor="middle" x="773" y="-14.8" font-family="Times,serif" font-size="14.00">1</text>
</g>
<!-- n3 -->
<g id="node3" class="node">
<title>
n3
</title>
<polygon fill="none" stroke="black" points="858,-0.5 858,-36.5 1215,-36.5 1215,-0.5 858,-0.5"></polygon>
<text text-anchor="middle" x="1010.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000010</text>
<polyline fill="none" stroke="black" points="1163,-0.5 1163,-36.5"></polyline>
<text text-anchor="middle" x="1176" y="-14.8" font-family="Times,serif" font-size="14.00">2</text>
<polyline fill="none" stroke="black" points="1189,-0.5 1189,-36.5"></polyline>
<text text-anchor="middle" x="1202" y="-14.8" font-family="Times,serif" font-size="14.00">2</text>
</g>
<!-- n4 -->
<g id="node4" class="node">
<title>
n4
</title>
<polygon fill="none" stroke="black" points="1287,-0.5 1287,-36.5 1644,-36.5 1644,-0.5 1287,-0.5"></polygon>
<text text-anchor="middle" x="1439.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000011</text>
<polyline fill="none" stroke="black" points="1592,-0.5 1592,-36.5"></polyline>
<text text-anchor="middle" x="1605" y="-14.8" font-family="Times,serif" font-size="14.00">3</text>
<polyline fill="none" stroke="black" points="1618,-0.5 1618,-36.5"></polyline>
<text text-anchor="middle" x="1631" y="-14.8" font-family="Times,serif" font-size="14.00">3</text>
</g>
<!-- n5 -->
<g id="node5" class="node">
<title>
n5
</title>
<polygon fill="none" stroke="black" points="1716,-0.5 1716,-36.5 2073,-36.5 2073,-0.5 1716,-0.5"></polygon>
<text text-anchor="middle" x="1868.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000100</text>
<polyline fill="none" stroke="black" points="2021,-0.5 2021,-36.5"></polyline>
<text text-anchor="middle" x="2034" y="-14.8" font-family="Times,serif" font-size="14.00">4</text>
<polyline fill="none" stroke="black" points="2047,-0.5 2047,-36.5"></polyline>
<text text-anchor="middle" x="2060" y="-14.8" font-family="Times,serif" font-size="14.00">5</text>
</g>
<!-- n6 -->
<g id="node6" class="node">
<title>
n6
</title>
<polygon fill="none" stroke="black" points="2145,-0.5 2145,-36.5 2502,-36.5 2502,-0.5 2145,-0.5"></polygon>
<text text-anchor="middle" x="2297.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000101</text>
<polyline fill="none" stroke="black" points="2450,-0.5 2450,-36.5"></polyline>
<text text-anchor="middle" x="2463" y="-14.8" font-family="Times,serif" font-size="14.00">5</text>
<polyline fill="none" stroke="black" points="2476,-0.5 2476,-36.5"></polyline>
<text text-anchor="middle" x="2489" y="-14.8" font-family="Times,serif" font-size="14.00">8</text>
</g>
<!-- n7 -->
<g id="node7" class="node">
<title>
n7
</title>
<polygon fill="none" stroke="black" points="2574.5,-0.5 2574.5,-36.5 2940.5,-36.5 2940.5,-0.5 2574.5,-0.5"></polygon>
<text text-anchor="middle" x="2727" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000110</text>
<polyline fill="none" stroke="black" points="2879.5,-0.5 2879.5,-36.5"></polyline>
<text text-anchor="middle" x="2892.5" y="-14.8" font-family="Times,serif" font-size="14.00">6</text>
<polyline fill="none" stroke="black" points="2905.5,-0.5 2905.5,-36.5"></polyline>
<text text-anchor="middle" x="2923" y="-14.8" font-family="Times,serif" font-size="14.00">13</text>
</g>
<!-- n8 -->
<g id="node8" class="node">
<title>
n8
</title>
<polygon fill="none" stroke="black" points="3012.5,-0.5 3012.5,-36.5 3378.5,-36.5 3378.5,-0.5 3012.5,-0.5"></polygon>
<text text-anchor="middle" x="3165" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000111</text>
<polyline fill="none" stroke="black" points="3317.5,-0.5 3317.5,-36.5"></polyline>
<text text-anchor="middle" x="3330.5" y="-14.8" font-family="Times,serif" font-size="14.00">7</text>
<polyline fill="none" stroke="black" points="3343.5,-0.5 3343.5,-36.5"></polyline>
<text text-anchor="middle" x="3361" y="-14.8" font-family="Times,serif" font-size="14.00">21</text>
</g>
<!-- n9 -->
<g id="node9" class="node">
<title>
n9
</title>
<polygon fill="none" stroke="black" points="3450.5,-0.5 3450.5,-36.5 3816.5,-36.5 3816.5,-0.5 3450.5,-0.5"></polygon>
<text text-anchor="middle" x="3603" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000001000</text>
<polyline fill="none" stroke="black" points="3755.5,-0.5 3755.5,-36.5"></polyline>
<text text-anchor="middle" x="3768.5" y="-14.8" font-family="Times,serif" font-size="14.00">8</text>
<polyline fill="none" stroke="black" points="3781.5,-0.5 3781.5,-36.5"></polyline>
<text text-anchor="middle" x="3799" y="-14.8" font-family="Times,serif" font-size="14.00">34</text>
</g>
<!-- n0 -->
<g id="node10" class="node">
<title>
n0
</title>
<polygon fill="none" stroke="black" points="1800.5,-181.5 1800.5,-217.5 2136.5,-217.5 2136.5,-181.5 1800.5,-181.5"></polygon>
<text text-anchor="middle" x="1811" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1821.5,-181.5 1821.5,-217.5"></polyline>
<text text-anchor="middle" x="1832" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1842.5,-181.5 1842.5,-217.5"></polyline>
<text text-anchor="middle" x="1853" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1863.5,-181.5 1863.5,-217.5"></polyline>
<text text-anchor="middle" x="1874" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1884.5,-181.5 1884.5,-217.5"></polyline>
<text text-anchor="middle" x="1895" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1905.5,-181.5 1905.5,-217.5"></polyline>
<text text-anchor="middle" x="1916" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1926.5,-181.5 1926.5,-217.5"></polyline>
<text text-anchor="middle" x="1937" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1947.5,-181.5 1947.5,-217.5"></polyline>
<text text-anchor="middle" x="1958" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1968.5,-181.5 1968.5,-217.5"></polyline>
<text text-anchor="middle" x="1979" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1989.5,-181.5 1989.5,-217.5"></polyline>
<text text-anchor="middle" x="2000" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="2010.5,-181.5 2010.5,-217.5"></polyline>
<text text-anchor="middle" x="2021" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="2031.5,-181.5 2031.5,-217.5"></polyline>
<text text-anchor="middle" x="2042" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="2052.5,-181.5 2052.5,-217.5"></polyline>
<text text-anchor="middle" x="2063" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="2073.5,-181.5 2073.5,-217.5"></polyline>
<text text-anchor="middle" x="2084" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="2094.5,-181.5 2094.5,-217.5"></polyline>
<text text-anchor="middle" x="2105" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="2115.5,-181.5 2115.5,-217.5"></polyline>
<text text-anchor="middle" x="2126" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n0&#45;&gt;n1 -->
<g id="edge1" class="edge">
<title>
n0:f0-&gt;n1
</title>
<path fill="none" stroke="black" d="M1799.5,-199.5C1799.5,-199.5 754.82,-83.5 342.77,-37.74"></path>
<polygon fill="black" stroke="black" points="343.19,-34.27 332.87,-36.64 342.42,-41.22 343.19,-34.27"></polygon>
</g>
<!-- n0&#45;&gt;n2 -->
<g id="edge2" class="edge">
<title>
n0:f1-&gt;n2
</title>
<path fill="none" stroke="black" d="M1831.5,-181C1831.5,-181 1068.63,-80.34 747.41,-37.96"></path>
<polygon fill="black" stroke="black" points="748.05,-34.51 737.68,-36.68 747.13,-41.45 748.05,-34.51"></polygon>
</g>
<!-- n0&#45;&gt;n3 -->
<g id="edge3" class="edge">
<title>
n0:f2-&gt;n3
</title>
<path fill="none" stroke="black" d="M1852.5,-181C1852.5,-181 1349.43,-81.43 1133.29,-38.66"></path>
<polygon fill="black" stroke="black" points="1134.26,-35.28 1123.77,-36.77 1132.9,-42.15 1134.26,-35.28"></polygon>
</g>
<!-- n0&#45;&gt;n4 -->
<g id="edge4" class="edge">
<title>
n0:f3-&gt;n4
</title>
<path fill="none" stroke="black" d="M1873.5,-181C1873.5,-181 1629.65,-84.48 1518.99,-40.67"></path>
<polygon fill="black" stroke="black" points="1520.39,-37.46 1509.8,-37.04 1517.81,-43.97 1520.39,-37.46"></polygon>
</g>
<!-- n0&#45;&gt;n5 -->
<g id="edge5" class="edge">
<title>
n0:f4-&gt;n5
</title>
<path fill="none" stroke="black" d="M1894.5,-181C1894.5,-181 1894.5,-94.16 1894.5,-47.83"></path>
<polygon fill="black" stroke="black" points="1898,-47.99 1894.5,-37.99 1891,-47.99 1898,-47.99"></polygon>
</g>
<!-- n0&#45;&gt;n6 -->
<g id="edge6" class="edge">
<title>
n0:f5-&gt;n6
</title>
<path fill="none" stroke="black" d="M1915.5,-181C1915.5,-181 2159.35,-84.48 2270.01,-40.67"></path>
<polygon fill="black" stroke="black" points="2271.19,-43.97 2279.2,-37.04 2268.61,-37.46 2271.19,-43.97"></polygon>
</g>
<!-- n0&#45;&gt;n7 -->
<g id="edge7" class="edge">
<title>
n0:f6-&gt;n7
</title>
<path fill="none" stroke="black" d="M1936.5,-181C1936.5,-181 2442.65,-81.43 2660.11,-38.66"></path>
<polygon fill="black" stroke="black" points="2660.57,-42.13 2669.71,-36.77 2659.22,-35.27 2660.57,-42.13"></polygon>
</g>
<!-- n0&#45;&gt;n8 -->
<g id="edge8" class="edge">
<title>
n0:f7-&gt;n8
</title>
<path fill="none" stroke="black" d="M1957.5,-181C1957.5,-181 2729.09,-80.34 3053.99,-37.96"></path>
<polygon fill="black" stroke="black" points="3054.39,-41.44 3063.85,-36.67 3053.48,-34.5 3054.39,-41.44"></polygon>
</g>
<!-- n0&#45;&gt;n9 -->
<g id="edge9" class="edge">
<title>
n0:f8-&gt;n9
</title>
<path fill="none" stroke="black" d="M1979.5,-181C1979.5,-181 3016.49,-79.75 3448.28,-37.59"></path>
<polygon fill="black" stroke="black" points="3448.5,-41.08 3458.11,-36.63 3447.82,-34.11 3448.5,-41.08"></polygon>
</g>
</g>
</svg>
</div>
</details>
<p>This is much better from a time-complexity perspective because the branching factor is higher. However, there’s one new issue we have introduced: it might not be so obvious in our small 8-element tree above, but every parent node now stores a 16-element array regardless of how many children it has. This is unnecessarily wasteful, and we can improve here.</p>
<p>Ideally we’d want to store an array that’s just big enough to fit the correct number of children, which we would resize as necessary when inserting or deleting elements. To accomplish this, we’ll paradoxically need to store another mapping between hash fragments and array indices. We’ll of course want this mapping to have minimal overhead, otherwise it wouldn’t end up saving much (or any) space.</p>
<p>This impressive technical feat is made possible by the magic of bitmaps! The general idea is that we store an additional bitmap that is the same size as the maximum length of the array (16 in our case), and then we do some more bit-twiddling that uses a hash fragment together with this bitmap to determine the correct index. The algorithm is:</p>
<ol type="1">
<li>Interpret the hash fragment as a number <code>n</code>.</li>
<li>If inserting, set the <code>n</code>th bit of the bitmap.</li>
<li>Mask off all bits <code>n</code> and above in the bitmap.</li>
<li>The <a href="https://vaibhavsagar.com/blog/2019/09/08/popcount/#hash-array-mapped-tries">population count</a> of the remaining bits is the index.</li>
</ol>
<p>Let’s try an example. We start with an empty bitmap:</p>
<pre><code>┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘
  5   4   3   2   1   0   9   8   7   6   5   4   3   2   1   0
  1   1   1   1   1   1</code></pre>
<p>And we want to insert an element <code>x</code> with a hash fragment of <code>0b0100</code>. This is interpreted as <code>4</code>, so we set that in the bitmap:</p>
<pre><code>┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 1 │ 0 │ 0 │ 0 │ 0 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘
  5   4   3   2   1   0   9   8   7   6   5   4   3   2   1   0
  1   1   1   1   1   1</code></pre>
<p>Then we mask off all bits <code>4</code> and above:</p>
<pre><code>┌───┬───┬───┬───┐
│ 0 │ 0 │ 0 │ 0 │
└───┴───┴───┴───┘
  3   2   1   0</code></pre>
<p>And the population count of this bitmap is <code>0</code>, which is our index.</p>
<p>The array looks like this:</p>
<pre><code>┌───┐
│ x │
└───┘
  0</code></pre>
<p>Let’s now insert an element <code>y</code> with a hash fragment of <code>0b1001</code>. This is interpreted as <code>9</code>, so we set that:</p>
<pre><code>┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 1 │ 0 │ 0 │ 0 │ 0 │ 1 │ 0 │ 0 │ 0 │ 0 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘
  5   4   3   2   1   0   9   8   7   6   5   4   3   2   1   0
  1   1   1   1   1   1</code></pre>
<p>Mask off all bits <code>9</code> and above:</p>
<pre><code>┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 0 │ 0 │ 0 │ 1 │ 0 │ 0 │ 0 │ 0 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┘
  8   7   6   5   4   3   2   1   0</code></pre>
<p>And the population count of this bitmap is <code>1</code>, which is our index.</p>
<p>The array now looks like this:</p>
<pre><code>┌───┬───┐
│ x │ y │
└───┴───┘
  0   1</code></pre>
<p>Finally, let’s insert an element <code>z</code> with a hash fragment of <code>0b0010</code>, or <code>2</code>:</p>
<pre><code>┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 0 │ 0 │ 0 │ 0 │ 0 │ 0 │ 1 │ 0 │ 0 │ 0 │ 0 │ 1 │ 0 │ 1 │ 0 │ 0 │
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘
  5   4   3   2   1   0   9   8   7   6   5   4   3   2   1   0
  1   1   1   1   1   1</code></pre>
<p>We mask off bits <code>2</code> and above:</p>
<pre><code>┌───┬───┐
│ 0 │ 0 │
└───┴───┘
  1   0</code></pre>
<p>The population count of this bitmap is also <code>0</code>, which means we need to insert this new element at the beginning of the array and shift the other elements to the right:</p>
<pre><code>┌───┬───┬───┐
│ z │ x │ y │
└───┴───┴───┘
  0   1   2</code></pre>
<p>The updated bitmap means that looking up our other elements will still work correctly.</p>
<p>With that taken care of, we arrive at our final data structure:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieNone</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">HashArrayMappedTrieLeaf</span><span> </span><span class="dt">Hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">HashArrayMappedTrieNode</span><span> </span><span class="ot">(</span><span class="dt">Binary</span><span> </span><span class="dt">Word16</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="dt">Vector</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span class="ot">)</span><span class="ot">)</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="ot">(</span><span class="dt">Eq</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span class="ot">)</span></code></pre></div>
<p>We modify our <code>insert</code> and <code>lookup</code> functions to use bitmaps as described above:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">insertHashArrayMappedTrie</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHashArrayMappedTrieHelper</span><span> </span><span class="dv">0</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="va">key</span><span>

</span><span class="va">insertHashArrayMappedTrieHelper</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHashArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="dt">HashArrayMappedTrieNone</span><span> </span><span class="ot">=</span><span>
    </span><span class="dt">HashArrayMappedTrieLeaf</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
</span><span class="va">insertHashArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="va">leaf</span><span class="ot">@</span><span class="ot">(</span><span class="dt">HashArrayMappedTrieLeaf</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span class="ot">)</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">hash</span><span> </span><span class="op">==</span><span> </span><span class="va">leafHash</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieLeaf</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">otherwise</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
        </span><span class="va">leafHashFragment</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="va">leafHash</span><span> </span><span class="ot">`</span><span class="va">shiftR</span><span class="ot">`</span><span> </span><span class="va">depth</span><span class="ot">)</span><span> </span><span class="op">.&amp;.</span><span> </span><span class="va">hashMask</span><span>
        </span><span class="va">leafBitmap</span><span> </span><span class="ot">=</span><span> </span><span class="va">bit</span><span> </span><span class="ot">(</span><span class="va">fromIntegral</span><span> </span><span class="va">leafHashFragment</span><span class="ot">)</span><span>
        </span><span class="va">leafInsertedNode</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieNode</span><span> </span><span class="va">leafBitmap</span><span> </span><span class="ot">(</span><span class="va">singleton</span><span> </span><span class="va">leaf</span><span class="ot">)</span><span>
        </span><span class="kw">in</span><span> </span><span class="va">insertHashArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="va">leafInsertedNode</span><span>
</span><span class="va">insertHashArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieNode</span><span> </span><span class="va">bitmap</span><span> </span><span class="va">children</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">hashFragment</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="ot">`</span><span class="va">shiftR</span><span class="ot">`</span><span> </span><span class="va">depth</span><span class="ot">)</span><span> </span><span class="op">.&amp;.</span><span> </span><span class="va">hashMask</span><span>
    </span><span class="va">elemBitmap</span><span> </span><span class="ot">=</span><span> </span><span class="va">bit</span><span> </span><span class="ot">(</span><span class="va">fromIntegral</span><span> </span><span class="va">hashFragment</span><span class="ot">)</span><span>
    </span><span class="va">index</span><span> </span><span class="ot">=</span><span> </span><span class="va">popCount</span><span> </span><span class="ot">(</span><span class="va">bitmap</span><span> </span><span class="op">.&amp;.</span><span> </span><span class="ot">(</span><span class="va">elemBitmap</span><span> </span><span class="op">-</span><span> </span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span>
    </span><span class="va">depth'</span><span> </span><span class="ot">=</span><span> </span><span class="va">depth</span><span> </span><span class="op">+</span><span> </span><span class="va">hashFragmentLength</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">elemBitmap</span><span> </span><span class="op">.&amp;.</span><span> </span><span class="va">bitmap</span><span> </span><span class="op">==</span><span> </span><span class="dv">0</span><span>
        </span><span class="kw">then</span><span> </span><span class="kw">let</span><span>
            </span><span class="va">leaf</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieLeaf</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span>
            </span><span class="va">bitmap'</span><span> </span><span class="ot">=</span><span> </span><span class="va">bitmap</span><span> </span><span class="op">.|.</span><span> </span><span class="va">elemBitmap</span><span>
            </span><span class="va">children'</span><span> </span><span class="ot">=</span><span> </span><span class="va">take</span><span> </span><span class="va">index</span><span> </span><span class="va">children</span><span> </span><span class="op">&lt;&gt;</span><span> </span><span class="va">singleton</span><span> </span><span class="va">leaf</span><span> </span><span class="op">&lt;&gt;</span><span> </span><span class="va">drop</span><span> </span><span class="va">index</span><span> </span><span class="va">children</span><span>
            </span><span class="kw">in</span><span> </span><span class="dt">HashArrayMappedTrieNode</span><span> </span><span class="va">bitmap'</span><span> </span><span class="va">children'</span><span>
        </span><span class="kw">else</span><span> </span><span class="kw">let</span><span>
            </span><span class="va">subtree</span><span> </span><span class="ot">=</span><span> </span><span class="va">children</span><span> </span><span class="op">!</span><span> </span><span class="va">index</span><span>
            </span><span class="va">subtree'</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHashArrayMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="va">subtree</span><span>
            </span><span class="va">children'</span><span> </span><span class="ot">=</span><span> </span><span class="va">children</span><span> </span><span class="op">//</span><span> </span><span class="ot">[</span><span class="ot">(</span><span class="va">index</span><span class="ot">,</span><span> </span><span class="va">subtree'</span><span class="ot">)</span><span class="ot">]</span><span>
            </span><span class="kw">in</span><span> </span><span class="dt">HashArrayMappedTrieNode</span><span> </span><span class="va">bitmap</span><span> </span><span class="va">children'</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">lookupHashArrayMappedTrie</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Hashable</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="va">value</span><span>
</span><span class="va">lookupHashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="ot">=</span><span> </span><span class="va">lookupHashArrayMappedTrieHelper</span><span> </span><span class="dv">0</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="va">key</span><span class="ot">)</span><span> </span><span class="va">key</span><span>

</span><span class="va">lookupHashArrayMappedTrieHelper</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Hash</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="va">key</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">key</span><span> </span><span class="va">value</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">Maybe</span><span> </span><span class="va">value</span><span>
</span><span class="va">lookupHashArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="dt">HashArrayMappedTrieNone</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Nothing</span><span>
</span><span class="va">lookupHashArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieLeaf</span><span> </span><span class="va">leafHash</span><span> </span><span class="va">leafKey</span><span> </span><span class="va">leafValue</span><span class="ot">)</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">hash</span><span> </span><span class="op">==</span><span> </span><span class="va">leafHash</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Just</span><span> </span><span class="va">leafValue</span><span>
    </span><span class="ot">|</span><span> </span><span class="va">otherwise</span><span> </span><span class="ot">=</span><span> </span><span class="dt">Nothing</span><span>
</span><span class="va">lookupHashArrayMappedTrieHelper</span><span> </span><span class="va">depth</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieNode</span><span> </span><span class="va">bitmap</span><span> </span><span class="va">children</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">hashFragment</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="va">hash</span><span> </span><span class="ot">`</span><span class="va">shiftR</span><span class="ot">`</span><span> </span><span class="va">depth</span><span class="ot">)</span><span> </span><span class="op">.&amp;.</span><span> </span><span class="va">hashMask</span><span>
    </span><span class="va">elemBitmap</span><span> </span><span class="ot">=</span><span> </span><span class="va">bit</span><span> </span><span class="ot">(</span><span class="va">fromIntegral</span><span> </span><span class="va">hashFragment</span><span class="ot">)</span><span>
    </span><span class="va">index</span><span> </span><span class="ot">=</span><span> </span><span class="va">popCount</span><span> </span><span class="ot">(</span><span class="va">bitmap</span><span> </span><span class="op">.&amp;.</span><span> </span><span class="ot">(</span><span class="va">elemBitmap</span><span> </span><span class="op">-</span><span> </span><span class="dv">1</span><span class="ot">)</span><span class="ot">)</span><span>
    </span><span class="va">depth'</span><span> </span><span class="ot">=</span><span> </span><span class="va">depth</span><span> </span><span class="op">+</span><span> </span><span class="va">hashFragmentLength</span><span>
    </span><span class="kw">in</span><span> </span><span class="kw">if</span><span> </span><span class="va">elemBitmap</span><span> </span><span class="op">.&amp;.</span><span> </span><span class="va">bitmap</span><span> </span><span class="op">==</span><span> </span><span class="dv">0</span><span>
        </span><span class="kw">then</span><span> </span><span class="dt">Nothing</span><span>
        </span><span class="kw">else</span><span> </span><span class="va">lookupHashArrayMappedTrieHelper</span><span> </span><span class="va">depth'</span><span> </span><span class="va">hash</span><span> </span><span class="va">key</span><span> </span><span class="ot">(</span><span class="va">children</span><span> </span><span class="op">!</span><span> </span><span class="va">index</span><span class="ot">)</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">emptyHashArrayMappedTrie</span><span> </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieNone</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span><span> </span><span class="dt">Mapping</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">empty</span><span> </span><span class="ot">=</span><span> </span><span class="va">emptyHashArrayMappedTrie</span><span>
    </span><span class="va">insert</span><span> </span><span class="ot">=</span><span> </span><span class="va">insertHashArrayMappedTrie</span><span>
    </span><span class="va">lookup</span><span> </span><span class="ot">=</span><span> </span><span class="va">lookupHashArrayMappedTrie</span></code></pre></div>
And one last time, we can render these:
<details>
<summary>
Hash Array Mapped Trie
</summary>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span><span> </span><span class="dt">HashArrayMappedTrieGraphvizNode</span><span>
    </span><span class="ot">=</span><span> </span><span class="dt">HashArrayMappedTrieGraphvizNode</span><span>
        </span><span class="ot">{</span><span> </span><span class="va">hashArrayMappedTrieGraphvizNodeId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashArrayMappedTrieGraphvizBitmap</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashArrayMappedTrieGraphvizFields</span><span> </span><span class="ot">::</span><span> </span><span class="ot">[</span><span class="dt">Int</span><span class="ot">]</span><span>
        </span><span class="ot">}</span><span>
    </span><span class="ot">|</span><span> </span><span class="dt">HashArrayMappedTrieGraphvizLeafNode</span><span>
        </span><span class="ot">{</span><span> </span><span class="va">hashArrayMappedTrieGraphvizLeafNodeId</span><span> </span><span class="ot">::</span><span> </span><span class="dt">Int</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashArrayMappedTrieGraphvizLeafHash</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashArrayMappedTrieGraphvizLeafKey</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">,</span><span> </span><span class="va">hashArrayMappedTrieGraphvizLeafNodeValue</span><span> </span><span class="ot">::</span><span> </span><span class="dt">String</span><span>
        </span><span class="ot">}</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="ot">(</span><span class="dt">Eq</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span class="ot">)</span><span>

</span><span class="va">numberHAMT</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Show</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">WriterT</span><span> </span><span class="ot">[</span><span class="dt">HashArrayMappedTrieGraphvizNode</span><span class="ot">]</span><span> </span><span class="ot">(</span><span class="dt">State</span><span> </span><span class="dt">Int</span><span class="ot">)</span><span> </span><span class="dt">Int</span><span>
</span><span class="va">numberHAMT</span><span> </span><span class="dt">HashArrayMappedTrieNone</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">tell</span><span> </span><span class="va">mempty</span><span>
    </span><span class="va">pure</span><span> </span><span class="dv">0</span><span>
</span><span class="va">numberHAMT</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieLeaf</span><span> </span><span class="va">h</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">lift</span><span> </span><span class="va">getFreshId</span><span>
    </span><span class="va">tell</span><span> </span><span class="ot">[</span><span class="dt">HashArrayMappedTrieGraphvizLeafNode</span><span> </span><span class="va">i</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">h</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">k</span><span class="ot">)</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">v</span><span class="ot">)</span><span class="ot">]</span><span>
    </span><span class="va">pure</span><span> </span><span class="va">i</span><span>
</span><span class="va">numberHAMT</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieNode</span><span> </span><span class="va">b</span><span> </span><span class="va">hs</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">i</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">lift</span><span> </span><span class="va">getFreshId</span><span>
    </span><span class="va">numbered</span><span> </span><span class="ot">&lt;-</span><span> </span><span class="va">Vector.toList</span><span> </span><span class="op">&lt;$&gt;</span><span> </span><span class="va">traverse</span><span> </span><span class="va">numberHAMT</span><span> </span><span class="va">hs</span><span>
    </span><span class="va">tell</span><span> </span><span class="ot">[</span><span class="dt">HashArrayMappedTrieGraphvizNode</span><span> </span><span class="va">i</span><span> </span><span class="ot">(</span><span class="va">show</span><span> </span><span class="va">b</span><span class="ot">)</span><span> </span><span class="va">numbered</span><span class="ot">]</span><span>
    </span><span class="va">pure</span><span> </span><span class="va">i</span><span>

</span><span class="va">nodeLinesHAMT</span><span> </span><span class="ot">::</span><span> </span><span class="dt">HashArrayMappedTrieGraphvizNode</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="ot">[</span><span class="dt">String</span><span class="ot">]</span><span>
</span><span class="va">nodeLinesHAMT</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieGraphvizLeafNode</span><span> </span><span class="va">i</span><span> </span><span class="va">h</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="kw">label</span><span> </span><span class="ot">=</span><span> </span><span class="va">intercalate</span><span> </span><span class="st">&quot;|&quot;</span><span> </span><span class="ot">[</span><span class="va">h</span><span class="ot">,</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="va">v</span><span class="ot">]</span><span>
    </span><span class="va">line</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span class="ot">)</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;[label=\&quot;&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">escape</span><span> </span><span class="kw">label</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;\&quot;]&quot;</span><span>
    </span><span class="kw">in</span><span> </span><span class="ot">[</span><span class="va">line</span><span class="ot">]</span><span>
</span><span class="va">nodeLinesHAMT</span><span> </span><span class="ot">(</span><span class="dt">HashArrayMappedTrieGraphvizNode</span><span> </span><span class="va">i</span><span> </span><span class="va">b</span><span> </span><span class="va">fs</span><span class="ot">)</span><span> </span><span class="ot">=</span><span> </span><span class="kw">let</span><span>
    </span><span class="va">indices</span><span> </span><span class="ot">=</span><span> </span><span class="va">Prelude.take</span><span> </span><span class="ot">(</span><span class="va">length</span><span> </span><span class="va">fs</span><span class="ot">)</span><span> </span><span class="ot">[</span><span class="dv">0</span><span class="ot">..</span><span class="ot">]</span><span>
    </span><span class="va">pairs</span><span> </span><span class="ot">=</span><span> </span><span class="va">zip</span><span> </span><span class="va">indices</span><span> </span><span class="va">fs</span><span>
    </span><span class="va">edges</span><span> </span><span class="ot">=</span><span> </span><span class="va">flip</span><span> </span><span class="va">map</span><span> </span><span class="va">pairs</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="ot">(</span><span class="va">f</span><span class="ot">,</span><span class="va">t</span><span class="ot">)</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;:&quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;f&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">f</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; -&gt; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">t</span><span>
    </span><span class="va">fields</span><span> </span><span class="ot">=</span><span> </span><span class="va">flip</span><span> </span><span class="va">map</span><span> </span><span class="va">indices</span><span> </span><span class="op">$</span><span> </span><span class="ot">\</span><span class="va">ix</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="st">&quot;&lt;f&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">ix</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;&gt;&quot;</span><span>
    </span><span class="kw">label</span><span> </span><span class="ot">=</span><span> </span><span class="va">intercalate</span><span> </span><span class="st">&quot;|&quot;</span><span> </span><span class="op">$</span><span> </span><span class="va">b</span><span class="ot">:</span><span class="va">fields</span><span>
    </span><span class="va">line</span><span> </span><span class="ot">=</span><span> </span><span class="ot">(</span><span class="st">&quot;n&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">show</span><span> </span><span class="va">i</span><span class="ot">)</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot; &quot;</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;[label=\&quot;&quot;</span><span> </span><span class="op">++</span><span> </span><span class="va">escape</span><span> </span><span class="kw">label</span><span> </span><span class="op">++</span><span> </span><span class="st">&quot;\&quot;]&quot;</span><span>
    </span><span class="kw">in</span><span> </span><span class="ot">(</span><span class="va">line</span><span class="ot">:</span><span class="va">edges</span><span class="ot">)</span><span>

</span><span class="va">dotFromHAMT</span><span> </span><span class="ot">::</span><span> </span><span class="ot">(</span><span class="dt">Show</span><span> </span><span class="va">k</span><span class="ot">,</span><span> </span><span class="dt">Show</span><span> </span><span class="va">v</span><span class="ot">)</span><span> </span><span class="ot">=&gt;</span><span> </span><span class="dt">HashArrayMappedTrie</span><span> </span><span class="va">k</span><span> </span><span class="va">v</span><span> </span><span class="ot">-&gt;</span><span> </span><span class="dt">String</span><span>
</span><span class="va">dotFromHAMT</span><span> </span><span class="ot">=</span><span> </span><span class="va">makeDot</span><span> </span><span class="op">.</span><span> </span><span class="va">makeDotLines</span><span class="op">.</span><span> </span><span class="va">concatMap</span><span> </span><span class="va">nodeLinesHAMT</span><span> </span><span class="op">.</span><span> </span><span class="va">flip</span><span> </span><span class="va">evalState</span><span> </span><span class="dv">0</span><span> </span><span class="op">.</span><span> </span><span class="va">execWriterT</span><span> </span><span class="op">.</span><span> </span><span class="va">numberHAMT</span></code></pre></div>
</div>
</details>
<details>
<summary>
Hash Array Mapped Trie
</summary>
<div style="overflow: scroll">
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="va">dot</span><span> </span><span class="op">$</span><span> </span><span class="va">dotFromHAMT</span><span> </span><span class="op">$</span><span> </span><span class="va">snd</span><span> </span><span class="op">$</span><span> </span><span class="va">fib'</span><span> </span><span class="va">emptyHashArrayMappedTrie</span><span> </span><span class="dv">8</span></code></pre></div>
<svg width="3825pt" height="226pt" viewBox="0.00 0.00 3824.50 226.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 222)">
<polygon fill="white" stroke="none" points="-4,4 -4,-222 3820.5,-222 3820.5,4 -4,4"></polygon>
<!-- n1 -->
<g id="node1" class="node">
<title>
n1
</title>
<polygon fill="none" stroke="black" points="0,-0.5 0,-36.5 357,-36.5 357,-0.5 0,-0.5"></polygon>
<text text-anchor="middle" x="152.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000000</text>
<polyline fill="none" stroke="black" points="305,-0.5 305,-36.5"></polyline>
<text text-anchor="middle" x="318" y="-14.8" font-family="Times,serif" font-size="14.00">0</text>
<polyline fill="none" stroke="black" points="331,-0.5 331,-36.5"></polyline>
<text text-anchor="middle" x="344" y="-14.8" font-family="Times,serif" font-size="14.00">1</text>
</g>
<!-- n2 -->
<g id="node2" class="node">
<title>
n2
</title>
<polygon fill="none" stroke="black" points="429,-0.5 429,-36.5 786,-36.5 786,-0.5 429,-0.5"></polygon>
<text text-anchor="middle" x="581.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000001</text>
<polyline fill="none" stroke="black" points="734,-0.5 734,-36.5"></polyline>
<text text-anchor="middle" x="747" y="-14.8" font-family="Times,serif" font-size="14.00">1</text>
<polyline fill="none" stroke="black" points="760,-0.5 760,-36.5"></polyline>
<text text-anchor="middle" x="773" y="-14.8" font-family="Times,serif" font-size="14.00">1</text>
</g>
<!-- n3 -->
<g id="node3" class="node">
<title>
n3
</title>
<polygon fill="none" stroke="black" points="858,-0.5 858,-36.5 1215,-36.5 1215,-0.5 858,-0.5"></polygon>
<text text-anchor="middle" x="1010.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000010</text>
<polyline fill="none" stroke="black" points="1163,-0.5 1163,-36.5"></polyline>
<text text-anchor="middle" x="1176" y="-14.8" font-family="Times,serif" font-size="14.00">2</text>
<polyline fill="none" stroke="black" points="1189,-0.5 1189,-36.5"></polyline>
<text text-anchor="middle" x="1202" y="-14.8" font-family="Times,serif" font-size="14.00">2</text>
</g>
<!-- n4 -->
<g id="node4" class="node">
<title>
n4
</title>
<polygon fill="none" stroke="black" points="1287,-0.5 1287,-36.5 1644,-36.5 1644,-0.5 1287,-0.5"></polygon>
<text text-anchor="middle" x="1439.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000011</text>
<polyline fill="none" stroke="black" points="1592,-0.5 1592,-36.5"></polyline>
<text text-anchor="middle" x="1605" y="-14.8" font-family="Times,serif" font-size="14.00">3</text>
<polyline fill="none" stroke="black" points="1618,-0.5 1618,-36.5"></polyline>
<text text-anchor="middle" x="1631" y="-14.8" font-family="Times,serif" font-size="14.00">3</text>
</g>
<!-- n5 -->
<g id="node5" class="node">
<title>
n5
</title>
<polygon fill="none" stroke="black" points="1716,-0.5 1716,-36.5 2073,-36.5 2073,-0.5 1716,-0.5"></polygon>
<text text-anchor="middle" x="1868.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000100</text>
<polyline fill="none" stroke="black" points="2021,-0.5 2021,-36.5"></polyline>
<text text-anchor="middle" x="2034" y="-14.8" font-family="Times,serif" font-size="14.00">4</text>
<polyline fill="none" stroke="black" points="2047,-0.5 2047,-36.5"></polyline>
<text text-anchor="middle" x="2060" y="-14.8" font-family="Times,serif" font-size="14.00">5</text>
</g>
<!-- n6 -->
<g id="node6" class="node">
<title>
n6
</title>
<polygon fill="none" stroke="black" points="2145,-0.5 2145,-36.5 2502,-36.5 2502,-0.5 2145,-0.5"></polygon>
<text text-anchor="middle" x="2297.5" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000101</text>
<polyline fill="none" stroke="black" points="2450,-0.5 2450,-36.5"></polyline>
<text text-anchor="middle" x="2463" y="-14.8" font-family="Times,serif" font-size="14.00">5</text>
<polyline fill="none" stroke="black" points="2476,-0.5 2476,-36.5"></polyline>
<text text-anchor="middle" x="2489" y="-14.8" font-family="Times,serif" font-size="14.00">8</text>
</g>
<!-- n7 -->
<g id="node7" class="node">
<title>
n7
</title>
<polygon fill="none" stroke="black" points="2574.5,-0.5 2574.5,-36.5 2940.5,-36.5 2940.5,-0.5 2574.5,-0.5"></polygon>
<text text-anchor="middle" x="2727" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000110</text>
<polyline fill="none" stroke="black" points="2879.5,-0.5 2879.5,-36.5"></polyline>
<text text-anchor="middle" x="2892.5" y="-14.8" font-family="Times,serif" font-size="14.00">6</text>
<polyline fill="none" stroke="black" points="2905.5,-0.5 2905.5,-36.5"></polyline>
<text text-anchor="middle" x="2923" y="-14.8" font-family="Times,serif" font-size="14.00">13</text>
</g>
<!-- n8 -->
<g id="node8" class="node">
<title>
n8
</title>
<polygon fill="none" stroke="black" points="3012.5,-0.5 3012.5,-36.5 3378.5,-36.5 3378.5,-0.5 3012.5,-0.5"></polygon>
<text text-anchor="middle" x="3165" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000000111</text>
<polyline fill="none" stroke="black" points="3317.5,-0.5 3317.5,-36.5"></polyline>
<text text-anchor="middle" x="3330.5" y="-14.8" font-family="Times,serif" font-size="14.00">7</text>
<polyline fill="none" stroke="black" points="3343.5,-0.5 3343.5,-36.5"></polyline>
<text text-anchor="middle" x="3361" y="-14.8" font-family="Times,serif" font-size="14.00">21</text>
</g>
<!-- n9 -->
<g id="node9" class="node">
<title>
n9
</title>
<polygon fill="none" stroke="black" points="3450.5,-0.5 3450.5,-36.5 3816.5,-36.5 3816.5,-0.5 3450.5,-0.5"></polygon>
<text text-anchor="middle" x="3603" y="-14.8" font-family="Times,serif" font-size="14.00">00000000000000000000000000001000</text>
<polyline fill="none" stroke="black" points="3755.5,-0.5 3755.5,-36.5"></polyline>
<text text-anchor="middle" x="3768.5" y="-14.8" font-family="Times,serif" font-size="14.00">8</text>
<polyline fill="none" stroke="black" points="3781.5,-0.5 3781.5,-36.5"></polyline>
<text text-anchor="middle" x="3799" y="-14.8" font-family="Times,serif" font-size="14.00">34</text>
</g>
<!-- n0 -->
<g id="node10" class="node">
<title>
n0
</title>
<polygon fill="none" stroke="black" points="1638.5,-181.5 1638.5,-217.5 1988.5,-217.5 1988.5,-181.5 1638.5,-181.5"></polygon>
<text text-anchor="middle" x="1719" y="-195.8" font-family="Times,serif" font-size="14.00">0000000111111111</text>
<polyline fill="none" stroke="black" points="1799.5,-181.5 1799.5,-217.5"></polyline>
<text text-anchor="middle" x="1810" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1820.5,-181.5 1820.5,-217.5"></polyline>
<text text-anchor="middle" x="1831" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1841.5,-181.5 1841.5,-217.5"></polyline>
<text text-anchor="middle" x="1852" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1862.5,-181.5 1862.5,-217.5"></polyline>
<text text-anchor="middle" x="1873" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1883.5,-181.5 1883.5,-217.5"></polyline>
<text text-anchor="middle" x="1894" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1904.5,-181.5 1904.5,-217.5"></polyline>
<text text-anchor="middle" x="1915" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1925.5,-181.5 1925.5,-217.5"></polyline>
<text text-anchor="middle" x="1936" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1946.5,-181.5 1946.5,-217.5"></polyline>
<text text-anchor="middle" x="1957" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
<polyline fill="none" stroke="black" points="1967.5,-181.5 1967.5,-217.5"></polyline>
<text text-anchor="middle" x="1978" y="-195.8" font-family="Times,serif" font-size="14.00"> </text>
</g>
<!-- n0&#45;&gt;n1 -->
<g id="edge1" class="edge">
<title>
n0:f0-&gt;n1
</title>
<path fill="none" stroke="black" d="M1809.5,-181C1809.5,-181 786.93,-79.75 361.15,-37.59"></path>
<polygon fill="black" stroke="black" points="361.77,-34.13 351.47,-36.63 361.08,-41.1 361.77,-34.13"></polygon>
</g>
<!-- n0&#45;&gt;n2 -->
<g id="edge2" class="edge">
<title>
n0:f1-&gt;n2
</title>
<path fill="none" stroke="black" d="M1831.5,-181C1831.5,-181 1068.63,-80.34 747.41,-37.96"></path>
<polygon fill="black" stroke="black" points="748.05,-34.51 737.68,-36.68 747.13,-41.45 748.05,-34.51"></polygon>
</g>
<!-- n0&#45;&gt;n3 -->
<g id="edge3" class="edge">
<title>
n0:f2-&gt;n3
</title>
<path fill="none" stroke="black" d="M1852.5,-181C1852.5,-181 1349.43,-81.43 1133.29,-38.66"></path>
<polygon fill="black" stroke="black" points="1134.26,-35.28 1123.77,-36.77 1132.9,-42.15 1134.26,-35.28"></polygon>
</g>
<!-- n0&#45;&gt;n4 -->
<g id="edge4" class="edge">
<title>
n0:f3-&gt;n4
</title>
<path fill="none" stroke="black" d="M1873.5,-181C1873.5,-181 1629.65,-84.48 1518.99,-40.67"></path>
<polygon fill="black" stroke="black" points="1520.39,-37.46 1509.8,-37.04 1517.81,-43.97 1520.39,-37.46"></polygon>
</g>
<!-- n0&#45;&gt;n5 -->
<g id="edge5" class="edge">
<title>
n0:f4-&gt;n5
</title>
<path fill="none" stroke="black" d="M1894.5,-181C1894.5,-181 1894.5,-94.16 1894.5,-47.83"></path>
<polygon fill="black" stroke="black" points="1898,-47.99 1894.5,-37.99 1891,-47.99 1898,-47.99"></polygon>
</g>
<!-- n0&#45;&gt;n6 -->
<g id="edge6" class="edge">
<title>
n0:f5-&gt;n6
</title>
<path fill="none" stroke="black" d="M1915.5,-181C1915.5,-181 2159.35,-84.48 2270.01,-40.67"></path>
<polygon fill="black" stroke="black" points="2271.19,-43.97 2279.2,-37.04 2268.61,-37.46 2271.19,-43.97"></polygon>
</g>
<!-- n0&#45;&gt;n7 -->
<g id="edge7" class="edge">
<title>
n0:f6-&gt;n7
</title>
<path fill="none" stroke="black" d="M1936.5,-181C1936.5,-181 2442.65,-81.43 2660.11,-38.66"></path>
<polygon fill="black" stroke="black" points="2660.57,-42.13 2669.71,-36.77 2659.22,-35.27 2660.57,-42.13"></polygon>
</g>
<!-- n0&#45;&gt;n8 -->
<g id="edge8" class="edge">
<title>
n0:f7-&gt;n8
</title>
<path fill="none" stroke="black" d="M1957.5,-181C1957.5,-181 2729.09,-80.34 3053.99,-37.96"></path>
<polygon fill="black" stroke="black" points="3054.39,-41.44 3063.85,-36.67 3053.48,-34.5 3054.39,-41.44"></polygon>
</g>
<!-- n0&#45;&gt;n9 -->
<g id="edge9" class="edge">
<title>
n0:f8-&gt;n9
</title>
<path fill="none" stroke="black" d="M1989.5,-199.5C1989.5,-199.5 3049.52,-83.44 3467.21,-37.71"></path>
<polygon fill="black" stroke="black" points="3467.4,-41.21 3476.96,-36.64 3466.64,-34.25 3467.4,-41.21"></polygon>
</g>
</g>
</svg>
</div>
</details>
<p>And we’re done! Here are a few more things to explore that I didn’t have space to cover here:</p>
<ul>
<li><p>These data structures don’t handle collisions, but these could be added with a <code>Collision</code> node that stores a list of key-value pairs where the keys all share the same hash.</p></li>
<li><p>In the case where a node’s bitmap is full, we don’t need to do most of the bit-twiddling above, and in practice most implementations also have a special <code>Full</code> node for this purpose.</p></li>
<li><p>I’ve only looked at <code>insert</code> and <code>lookup</code>, but there are some intricacies to implementing <code>delete</code> etc.</p></li>
<li><p>All these data structures are persistent, by virtue of them being implemented with immutable vectors. The original paper uses mutable vectors and is not persistent.</p></li>
<li><p>Even in the case where we want a persistent data structure, we might want to do a series of updates to a “thawed” version of the structure and then “freeze” it afterwards like we do with vectors in Haskell. I don’t know of an implementation that has this capability.</p></li>
</ul>

        </div>
        <div id="footer">
            <div class="rc-webring">
                <a href="https://webring.recurse.com"><img src="https://webring.recurse.com/icon.svg" /> RC Webring</a>
            </div>
            <div class="rc-scout">
                <script async defer src="https://www.recurse-scout.com/loader.js?t=5ac465e5d3396a7e491e42afac4c5c90"></script>
            </div>
        </div>
        <script data-goatcounter="https://vaibhavsagar.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    </body>
</html>
